<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Localorbit</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.8.0/application.js' type='text/javascript'></script>    
    <link href='./assets/0.8.0/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.8.0/favicon_red.png" />
    <link rel="icon" type="image/png" href="./assets/0.8.0/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.8.0/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2016-03-27T13:47:31-04:00">2016-03-27T13:47:31-04:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="red">56.33%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         1.83
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>98</b> files in total.
    <b>3355</b> relevant lines. 
    <span class="green"><b>1890</b> lines covered</span> and
    <span class="red"><b>1465</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#e656db5174be1cd70944e5cba4d0a6eb4b006e70" class="src_link" title="app/controllers/admin/locations_controller.rb">app/controllers/admin/locations_controller.rb</a></td>
        <td class="red strong">44.44 %</td>
        <td>66</td>
        <td>36</td>
        <td>16</td>
        <td>20</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6fb0c2f8e219d28d8fa930578e6c48b93da70fbe" class="src_link" title="app/controllers/admin/markets_controller.rb">app/controllers/admin/markets_controller.rb</a></td>
        <td class="red strong">65.15 %</td>
        <td>156</td>
        <td>66</td>
        <td>43</td>
        <td>23</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c28933f8248a5f1bd332c64a287705fb3178682d" class="src_link" title="app/controllers/admin/orders_controller.rb">app/controllers/admin/orders_controller.rb</a></td>
        <td class="red strong">18.02 %</td>
        <td>186</td>
        <td>111</td>
        <td>20</td>
        <td>91</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#eb8a89067b0eb299ccb2d5e1d5f1c7d3190eeb80" class="src_link" title="app/controllers/admin_controller.rb">app/controllers/admin_controller.rb</a></td>
        <td class="red strong">61.54 %</td>
        <td>22</td>
        <td>13</td>
        <td>8</td>
        <td>5</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f6393dcf7b183687bb7a1695b2e1926c0b4a7d9f" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
        <td class="red strong">65.19 %</td>
        <td>234</td>
        <td>135</td>
        <td>88</td>
        <td>47</td>
        <td>7.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2c95eec30d2cc16f5c17c3baf40e2e6b9cab24dc" class="src_link" title="app/controllers/audited_sweeper.rb">app/controllers/audited_sweeper.rb</a></td>
        <td class="red strong">40.0 %</td>
        <td>16</td>
        <td>10</td>
        <td>4</td>
        <td>6</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c2831a274b5fa3f5a209bbdc7f283f26aec9fd6d" class="src_link" title="app/controllers/concerns/sticky_filters.rb">app/controllers/concerns/sticky_filters.rb</a></td>
        <td class="red strong">72.73 %</td>
        <td>42</td>
        <td>22</td>
        <td>16</td>
        <td>6</td>
        <td>2.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#95ad399433a6e0dc85707ebe07bcd0243814f000" class="src_link" title="app/controllers/dashboards_controller.rb">app/controllers/dashboards_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>29</td>
        <td>16</td>
        <td>16</td>
        <td>0</td>
        <td>2.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#41ab7fc95b6bb8df94358bd839e7a88fa948c885" class="src_link" title="app/controllers/products_controller.rb">app/controllers/products_controller.rb</a></td>
        <td class="red strong">46.34 %</td>
        <td>85</td>
        <td>41</td>
        <td>19</td>
        <td>22</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0aa5301e5e54fc5ea9b019e96be426708f9ce2d2" class="src_link" title="app/decorators/market_decorator.rb">app/decorators/market_decorator.rb</a></td>
        <td class="red strong">32.18 %</td>
        <td>164</td>
        <td>87</td>
        <td>28</td>
        <td>59</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3a61abaaa49d3c236b2285d8f25be66b7799a90b" class="src_link" title="app/interactors/create_market.rb">app/interactors/create_market.rb</a></td>
        <td class="red strong">72.73 %</td>
        <td>85</td>
        <td>11</td>
        <td>8</td>
        <td>3</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ab4d181a8c951355dfcd2106d811e8fbaecff1f1" class="src_link" title="app/interactors/create_stripe_customer_for_entity.rb">app/interactors/create_stripe_customer_for_entity.rb</a></td>
        <td class="yellow strong">85.71 %</td>
        <td>31</td>
        <td>14</td>
        <td>12</td>
        <td>2</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c520bf7043597e306218a876c19241490547a1ae" class="src_link" title="app/interactors/process_packing_labels_printable.rb">app/interactors/process_packing_labels_printable.rb</a></td>
        <td class="red strong">58.82 %</td>
        <td>24</td>
        <td>17</td>
        <td>10</td>
        <td>7</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e2096b790a64bd089e1c0f6a5c3ce6323c1c5902" class="src_link" title="app/interactors/register_stripe_standalone_market.rb">app/interactors/register_stripe_standalone_market.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1536ac38ba90496ac08e8c77134683fcddcc06fb" class="src_link" title="app/models/audit.rb">app/models/audit.rb</a></td>
        <td class="yellow strong">83.33 %</td>
        <td>23</td>
        <td>12</td>
        <td>10</td>
        <td>2</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#98760ea3d5f477bb2648f853cc6be3734ccf6503" class="src_link" title="app/models/bank_account.rb">app/models/bank_account.rb</a></td>
        <td class="red strong">58.14 %</td>
        <td>76</td>
        <td>43</td>
        <td>25</td>
        <td>18</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d52230d753807901405106120b3f0ec97cb559ab" class="src_link" title="app/models/bank_account_verification.rb">app/models/bank_account_verification.rb</a></td>
        <td class="red strong">45.45 %</td>
        <td>44</td>
        <td>22</td>
        <td>10</td>
        <td>12</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#297cefce289857cab7e23b896510618bb7816081" class="src_link" title="app/models/batch_invoice.rb">app/models/batch_invoice.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>24</td>
        <td>15</td>
        <td>12</td>
        <td>3</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b00f6b151e773fb0f7935745af0a2f8bce775b5b" class="src_link" title="app/models/batch_invoice_error.rb">app/models/batch_invoice_error.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7d6b95f77de50a87acdf09faa7b69bd2adad8909" class="src_link" title="app/models/batch_invoice_order.rb">app/models/batch_invoice_order.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6f7876cc8dc0c78e0b74b2e424a3cf2dead3239d" class="src_link" title="app/models/cart.rb">app/models/cart.rb</a></td>
        <td class="red strong">60.0 %</td>
        <td>60</td>
        <td>35</td>
        <td>21</td>
        <td>14</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b71115e9c06f79e0e3fecf9a5250368dc6876f2b" class="src_link" title="app/models/cart_item.rb">app/models/cart_item.rb</a></td>
        <td class="red strong">54.29 %</td>
        <td>61</td>
        <td>35</td>
        <td>19</td>
        <td>16</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b8abd46ac4f9f547810732f7bb83095dbf0c9ed5" class="src_link" title="app/models/category.rb">app/models/category.rb</a></td>
        <td class="red strong">56.25 %</td>
        <td>33</td>
        <td>16</td>
        <td>9</td>
        <td>7</td>
        <td>1.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a1bbaf91e7964c1847557d0d4f6667e637212e2e" class="src_link" title="app/models/concerns/delivery_status.rb">app/models/concerns/delivery_status.rb</a></td>
        <td class="red strong">59.09 %</td>
        <td>57</td>
        <td>22</td>
        <td>13</td>
        <td>9</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#16511fde3c30d5c083ec480a9abf361ca88e8039" class="src_link" title="app/models/concerns/soft_delete.rb">app/models/concerns/soft_delete.rb</a></td>
        <td class="red strong">64.71 %</td>
        <td>31</td>
        <td>17</td>
        <td>11</td>
        <td>6</td>
        <td>2.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b0c319fd45fe3ce704a387af0de8bb20df0ceda4" class="src_link" title="app/models/concerns/sortable.rb">app/models/concerns/sortable.rb</a></td>
        <td class="red strong">46.15 %</td>
        <td>23</td>
        <td>13</td>
        <td>6</td>
        <td>7</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#aadbe6f03a049d0c65f09087b486a2cfc22fd6fb" class="src_link" title="app/models/credit.rb">app/models/credit.rb</a></td>
        <td class="red strong">59.62 %</td>
        <td>85</td>
        <td>52</td>
        <td>31</td>
        <td>21</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4f991ff19695b52aebdb2453536bb907dd77e895" class="src_link" title="app/models/delivery.rb">app/models/delivery.rb</a></td>
        <td class="red strong">65.38 %</td>
        <td>44</td>
        <td>26</td>
        <td>17</td>
        <td>9</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#13544cd42bc470d0e882cf253a78e74d2941cb22" class="src_link" title="app/models/delivery_note.rb">app/models/delivery_note.rb</a></td>
        <td class="yellow strong">88.89 %</td>
        <td>16</td>
        <td>9</td>
        <td>8</td>
        <td>1</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#97def70c5f28df0dc2428a1d0ab2a61122027fa9" class="src_link" title="app/models/delivery_schedule.rb">app/models/delivery_schedule.rb</a></td>
        <td class="red strong">74.79 %</td>
        <td>228</td>
        <td>119</td>
        <td>89</td>
        <td>30</td>
        <td>1.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a6a9309fc1b17fae353e7277f63ed6615ea18310" class="src_link" title="app/models/discount.rb">app/models/discount.rb</a></td>
        <td class="red strong">60.34 %</td>
        <td>106</td>
        <td>58</td>
        <td>35</td>
        <td>23</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6d078e7a5bde0cbd1ea4b5b4ab48237c6fcec632" class="src_link" title="app/models/external_product.rb">app/models/external_product.rb</a></td>
        <td class="red strong">71.43 %</td>
        <td>13</td>
        <td>7</td>
        <td>5</td>
        <td>2</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#00a1d947a0b8110ffb78e707bbb265c5f9e83c99" class="src_link" title="app/models/fresh_sheet.rb">app/models/fresh_sheet.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#eb4679dffdf4e9ad78f374f74cdd60b5986aef32" class="src_link" title="app/models/general_product.rb">app/models/general_product.rb</a></td>
        <td class="red strong">66.67 %</td>
        <td>60</td>
        <td>30</td>
        <td>20</td>
        <td>10</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7d7018abd3ff9d4285ac176bdf07d656aafd432f" class="src_link" title="app/models/location.rb">app/models/location.rb</a></td>
        <td class="red strong">56.25 %</td>
        <td>52</td>
        <td>32</td>
        <td>18</td>
        <td>14</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d0d22f73dc8a03ec724e778c01cc99d70c04f5a4" class="src_link" title="app/models/lot.rb">app/models/lot.rb</a></td>
        <td class="red strong">70.37 %</td>
        <td>68</td>
        <td>27</td>
        <td>19</td>
        <td>8</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9c87cf54a46084f347a52462903219622dfb478d" class="src_link" title="app/models/managed_market.rb">app/models/managed_market.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bdb2384df877367fa7ccd308a595fe278b273f65" class="src_link" title="app/models/market.rb">app/models/market.rb</a></td>
        <td class="red strong">57.53 %</td>
        <td>272</td>
        <td>146</td>
        <td>84</td>
        <td>62</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#adfd9c51a7a2491e54cbcc4cdeb7856ab81846b1" class="src_link" title="app/models/market_address.rb">app/models/market_address.rb</a></td>
        <td class="red strong">56.41 %</td>
        <td>72</td>
        <td>39</td>
        <td>22</td>
        <td>17</td>
        <td>1.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#59997c0af36745d874a2774b9d76046e397079c2" class="src_link" title="app/models/market_cross_sells.rb">app/models/market_cross_sells.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f2e93fcdda5bd3811037fc42d61653e2a3b1bd44" class="src_link" title="app/models/market_organization.rb">app/models/market_organization.rb</a></td>
        <td class="yellow strong">90.0 %</td>
        <td>35</td>
        <td>20</td>
        <td>18</td>
        <td>2</td>
        <td>12.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#64c68558034ccf6b504f831069f89a71ad835622" class="src_link" title="app/models/metric.rb">app/models/metric.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6569bd35eb2e41aea5ada6ce0bb0ea39ce10e0f4" class="src_link" title="app/models/newsletter.rb">app/models/newsletter.rb</a></td>
        <td class="red strong">41.18 %</td>
        <td>29</td>
        <td>17</td>
        <td>7</td>
        <td>10</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#04d65295c1d339b6637b4f0f8c1cd4f3a4719179" class="src_link" title="app/models/order.rb">app/models/order.rb</a></td>
        <td class="red strong">56.84 %</td>
        <td>470</td>
        <td>234</td>
        <td>133</td>
        <td>101</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d5c01b3984d4a4bc0f5b428156f55658a8453b3f" class="src_link" title="app/models/order_item.rb">app/models/order_item.rb</a></td>
        <td class="red strong">58.59 %</td>
        <td>238</td>
        <td>128</td>
        <td>75</td>
        <td>53</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#41d30a20534252f2048a2b63dd219cbded33bc68" class="src_link" title="app/models/order_item_lot.rb">app/models/order_item_lot.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>17</td>
        <td>10</td>
        <td>8</td>
        <td>2</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0cc922615abf97a04cb473c9ad5895a343f05071" class="src_link" title="app/models/order_number.rb">app/models/order_number.rb</a></td>
        <td class="red strong">42.86 %</td>
        <td>36</td>
        <td>21</td>
        <td>9</td>
        <td>12</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#74cf7f909043ce0e96ff09efe843dfbf5beea4af" class="src_link" title="app/models/order_payment.rb">app/models/order_payment.rb</a></td>
        <td class="yellow strong">83.33 %</td>
        <td>14</td>
        <td>6</td>
        <td>5</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cc42b90bf3a480559c14e2918ed2b14afb4a24af" class="src_link" title="app/models/order_printable.rb">app/models/order_printable.rb</a></td>
        <td class="red strong">62.5 %</td>
        <td>14</td>
        <td>8</td>
        <td>5</td>
        <td>3</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cefe9b10f584e8fbb0f3fe69abdffda387ea7c03" class="src_link" title="app/models/order_template.rb">app/models/order_template.rb</a></td>
        <td class="red strong">60.0 %</td>
        <td>15</td>
        <td>10</td>
        <td>6</td>
        <td>4</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#046242a63b971550bceca68f446b0417e1944096" class="src_link" title="app/models/order_template_item.rb">app/models/order_template_item.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>6</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2ce6038d932a7aea729bad90c5e40c6ff9dffc4b" class="src_link" title="app/models/organization.rb">app/models/organization.rb</a></td>
        <td class="red strong">66.67 %</td>
        <td>178</td>
        <td>93</td>
        <td>62</td>
        <td>31</td>
        <td>2.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6f239ab72547f1f4efddb8b536ad5b167d665811" class="src_link" title="app/models/packing_labels_printable.rb">app/models/packing_labels_printable.rb</a></td>
        <td class="red strong">62.5 %</td>
        <td>14</td>
        <td>8</td>
        <td>5</td>
        <td>3</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a3781be5cd84f6e7b76fa5783d44c130a497e6a8" class="src_link" title="app/models/payment.rb">app/models/payment.rb</a></td>
        <td class="red strong">78.57 %</td>
        <td>89</td>
        <td>42</td>
        <td>33</td>
        <td>9</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#55b0ad17f327102082a079eb72ce27b07af52438" class="src_link" title="app/models/plan.rb">app/models/plan.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>8</td>
        <td>5</td>
        <td>4</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#70af20f3bee585688e8bb736fe0eccbe48254cfd" class="src_link" title="app/models/price.rb">app/models/price.rb</a></td>
        <td class="red strong">63.64 %</td>
        <td>47</td>
        <td>22</td>
        <td>14</td>
        <td>8</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b386c520a52dd0b7ab147ce21e59ec28b95a866a" class="src_link" title="app/models/product.rb">app/models/product.rb</a></td>
        <td class="red strong">58.78 %</td>
        <td>499</td>
        <td>296</td>
        <td>174</td>
        <td>122</td>
        <td>3.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#385b1b972fc33be56187342a1359983f9f92ff29" class="src_link" title="app/models/product_delivery.rb">app/models/product_delivery.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e5f0eab211128bdc1fcce9cd3256130db80822df" class="src_link" title="app/models/promotion.rb">app/models/promotion.rb</a></td>
        <td class="red strong">69.23 %</td>
        <td>43</td>
        <td>26</td>
        <td>18</td>
        <td>8</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0b8e25199e4ada04358ea4aff98aec0dcd26d12a" class="src_link" title="app/models/registration.rb">app/models/registration.rb</a></td>
        <td class="red strong">44.83 %</td>
        <td>89</td>
        <td>29</td>
        <td>13</td>
        <td>16</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fd10ecfe6f989458ffc0550d4c28f353475af99b" class="src_link" title="app/models/sequence.rb">app/models/sequence.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>20</td>
        <td>12</td>
        <td>4</td>
        <td>8</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#17011d2e8bb228d2df047e467b0a63b07cf01d59" class="src_link" title="app/models/subscription.rb">app/models/subscription.rb</a></td>
        <td class="red strong">70.59 %</td>
        <td>36</td>
        <td>17</td>
        <td>12</td>
        <td>5</td>
        <td>3.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e64251f9f113262be1de8425cce3cb81476e4880" class="src_link" title="app/models/subscription_type.rb">app/models/subscription_type.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>9</td>
        <td>6</td>
        <td>6</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4a7d923c20db2b57a1c5524b804ad23f5e2e2f87" class="src_link" title="app/models/twitter_user.rb">app/models/twitter_user.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>13</td>
        <td>7</td>
        <td>7</td>
        <td>0</td>
        <td>10.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#663b79d7a1f8e6453bbc613242cd2c0950dd0e3a" class="src_link" title="app/models/unit.rb">app/models/unit.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0e5f82fe4ec822a3ad073ce032e2b8868f51340f" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>447</td>
        <td>220</td>
        <td>110</td>
        <td>110</td>
        <td>3.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5c36890f87b7331f1b02acb68da270f8e930f3cc" class="src_link" title="app/models/user_organization.rb">app/models/user_organization.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2607de79e6bd874cb1d120893a224984cc3914da" class="src_link" title="app/presenters/buyer_order_presenter.rb">app/presenters/buyer_order_presenter.rb</a></td>
        <td class="red strong">69.57 %</td>
        <td>36</td>
        <td>23</td>
        <td>16</td>
        <td>7</td>
        <td>1.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c6f05c0045a5643d00160d01187d9ba9322c3b5e" class="src_link" title="app/presenters/market_search_presenter.rb">app/presenters/market_search_presenter.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>13</td>
        <td>9</td>
        <td>9</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#07db43b1544874d05f2837a99275682f49b00905" class="src_link" title="app/presenters/order_presenter.rb">app/presenters/order_presenter.rb</a></td>
        <td class="red strong">54.17 %</td>
        <td>71</td>
        <td>24</td>
        <td>13</td>
        <td>11</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9662f19389d7771cd51b1b026ec3b7149e4d2697" class="src_link" title="app/presenters/seller_order.rb">app/presenters/seller_order.rb</a></td>
        <td class="red strong">40.0 %</td>
        <td>82</td>
        <td>40</td>
        <td>16</td>
        <td>24</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f7d3ceea3da3b12510721a44416b1b0e25aee488" class="src_link" title="app/presenters/totals_presenter.rb">app/presenters/totals_presenter.rb</a></td>
        <td class="red strong">29.27 %</td>
        <td>67</td>
        <td>41</td>
        <td>12</td>
        <td>29</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#31d1497423a9595722cacb04f10d24ea1309ac13" class="src_link" title="lib/constraints/non_market_domain.rb">lib/constraints/non_market_domain.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>10</td>
        <td>6</td>
        <td>6</td>
        <td>0</td>
        <td>8.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e462a8e3204d76e0bd1754415ef64e83e7902163" class="src_link" title="lib/devise/strategies/token_auth.rb">lib/devise/strategies/token_auth.rb</a></td>
        <td class="red strong">60.0 %</td>
        <td>19</td>
        <td>10</td>
        <td>6</td>
        <td>4</td>
        <td>3.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b2e45e97ae71dccef403a9b7241e9b9e65a35ce3" class="src_link" title="lib/dragonfly_background_resize.rb">lib/dragonfly_background_resize.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>58</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>2.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5a1368d77a95813fbe9b624ad4e92a8cb6b411ce" class="src_link" title="lib/event_tracker.rb">lib/event_tracker.rb</a></td>
        <td class="red strong">52.0 %</td>
        <td>49</td>
        <td>25</td>
        <td>13</td>
        <td>12</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a83a1a4e7893e6e56f5b7872b082d0c2edad746d" class="src_link" title="lib/feature_access.rb">lib/feature_access.rb</a></td>
        <td class="red strong">48.78 %</td>
        <td>72</td>
        <td>41</td>
        <td>20</td>
        <td>21</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f67aee6c518d4c17173c04281cbcac499e10477f" class="src_link" title="lib/financials.rb">lib/financials.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#dca1943c128a974f10b34b789c16455343fab874" class="src_link" title="lib/financials/payment_executor.rb">lib/financials/payment_executor.rb</a></td>
        <td class="red strong">24.24 %</td>
        <td>65</td>
        <td>33</td>
        <td>8</td>
        <td>25</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2145744d58fb0b37255d224f07bc9060525687a6" class="src_link" title="lib/import_legacy_taxonomy.rb">lib/import_legacy_taxonomy.rb</a></td>
        <td class="green strong">92.11 %</td>
        <td>64</td>
        <td>38</td>
        <td>35</td>
        <td>3</td>
        <td>19.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ecb41e8ff4bcfb4601a42dfeb41e82033492af31" class="src_link" title="lib/interactor_ext.rb">lib/interactor_ext.rb</a></td>
        <td class="yellow strong">87.5 %</td>
        <td>13</td>
        <td>8</td>
        <td>7</td>
        <td>1</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fae6a37d5b44f85a58285805d9d00493e153ee0b" class="src_link" title="lib/orders/delivery_status_logic.rb">lib/orders/delivery_status_logic.rb</a></td>
        <td class="red strong">52.63 %</td>
        <td>41</td>
        <td>19</td>
        <td>10</td>
        <td>9</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b88e8970d515f0eddd2d6775412c5d2a76422d27" class="src_link" title="lib/packing_labels/generator.rb">lib/packing_labels/generator.rb</a></td>
        <td class="red strong">14.81 %</td>
        <td>66</td>
        <td>27</td>
        <td>4</td>
        <td>23</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3d5696ed0d2ac5c269f03f601554458bf78d5085" class="src_link" title="lib/payment_provider.rb">lib/payment_provider.rb</a></td>
        <td class="red strong">62.26 %</td>
        <td>158</td>
        <td>53</td>
        <td>33</td>
        <td>20</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e6f477e8126827db4f734301f02809722e60a13b" class="src_link" title="lib/payment_provider/balanced.rb">lib/payment_provider/balanced.rb</a></td>
        <td class="red strong">41.3 %</td>
        <td>130</td>
        <td>46</td>
        <td>19</td>
        <td>27</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c0d91e30f87ab0a9611e2fbac6fd8c6b627255f0" class="src_link" title="lib/payment_provider/fee_estimator.rb">lib/payment_provider/fee_estimator.rb</a></td>
        <td class="red strong">71.43 %</td>
        <td>29</td>
        <td>14</td>
        <td>10</td>
        <td>4</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0ceced5f34b4d7de056011c0d55f3d3bbbf70f6c" class="src_link" title="lib/payment_provider/handlers/async_handler.rb">lib/payment_provider/handlers/async_handler.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>18</td>
        <td>10</td>
        <td>5</td>
        <td>5</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a695486fab59c7482eab572271450ff54363ca40" class="src_link" title="lib/payment_provider/handlers/transfer_paid.rb">lib/payment_provider/handlers/transfer_paid.rb</a></td>
        <td class="red strong">38.46 %</td>
        <td>40</td>
        <td>13</td>
        <td>5</td>
        <td>8</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a613e4ab53ce21a956778b6ed0ae7bf06ba715c9" class="src_link" title="lib/payment_provider/stripe.rb">lib/payment_provider/stripe.rb</a></td>
        <td class="red strong">32.05 %</td>
        <td>419</td>
        <td>156</td>
        <td>50</td>
        <td>106</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7ff61436d055397135b0317218206291aa862be4" class="src_link" title="lib/rschema_ext/either.rb">lib/rschema_ext/either.rb</a></td>
        <td class="red strong">38.46 %</td>
        <td>21</td>
        <td>13</td>
        <td>5</td>
        <td>8</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#030be7edf78511d6e1efbfdecb4aa5bc740991a8" class="src_link" title="lib/rschema_ext/regexp.rb">lib/rschema_ext/regexp.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>10</td>
        <td>6</td>
        <td>2</td>
        <td>4</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#df9f2258febe1ca99aad2d2a5e2118c8c4c9fabd" class="src_link" title="lib/schema_validation.rb">lib/schema_validation.rb</a></td>
        <td class="red strong">53.85 %</td>
        <td>22</td>
        <td>13</td>
        <td>7</td>
        <td>6</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#441fd0f1f96025e96d622f8781386cd1854f48dc" class="src_link" title="lib/search.rb">lib/search.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b8f3ae297f657b2adf839a4a766e24677792ea13" class="src_link" title="lib/search/date_format.rb">lib/search/date_format.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>9</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>2.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bdf175fdc5f4c153e53caa3d84b89e9ee002c104" class="src_link" title="lib/search/market_and_organization.rb">lib/search/market_and_organization.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>37</td>
        <td>21</td>
        <td>7</td>
        <td>14</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cf9c4dc80395b5a17cda5d90f5616761e1a554e4" class="src_link" title="lib/search/query_defaults.rb">lib/search/query_defaults.rb</a></td>
        <td class="yellow strong">84.62 %</td>
        <td>25</td>
        <td>13</td>
        <td>11</td>
        <td>2</td>
        <td>2.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4245d48787b0aff698d0ceef7d15b86c5276f948" class="src_link" title="lib/terms_of_service.rb">lib/terms_of_service.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>9</td>
        <td>5</td>
        <td>4</td>
        <td>1</td>
        <td>2.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#656af73318b5e914fe9c673561cf60a660898738" class="src_link" title="lib/util/trim_text.rb">lib/util/trim_text.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>21</td>
        <td>9</td>
        <td>9</td>
        <td>0</td>
        <td>7.2</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.9.0 
        and simplecov-html v0.8.0<br/>
        using RSpec
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="e656db5174be1cd70944e5cba4d0a6eb4b006e70">
  <div class="header">
    <h3>app/controllers/admin/locations_controller.rb</h3>
    <h4><span class="red">44.44 %</span> covered</h4>
    <div>
      <b>36</b> relevant lines. 
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>20</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Admin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class LocationsController &lt; AdminController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    before_action :find_organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      @locations = @organization.locations.visible.alphabetical_by_name.decorate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    def new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">      @location = @organization.locations.build</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      @location = @organization.locations.build(location_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      if @location.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        redirect_to [:admin, @organization, :locations], notice: &quot;Successfully added address #{@location.name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        flash.now[:alert] = &quot;Could not save address&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        render :new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    def edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      @location = @organization.locations.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      @location = @organization.locations.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      if @location.update_attributes(location_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        redirect_to [:admin, @organization, :locations], notice: &quot;Successfully updated address #{@location.name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        flash.now[:alert] = &quot;Could not update address&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        render :new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    def update_default</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      @organization.locations.update_all(default_billing: false, default_shipping: false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      @organization.locations.find(params[:default_billing_id]).update_attributes(default_billing: true) if params[:default_billing_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      @organization.locations.find(params[:default_shipping_id]).update_attributes(default_shipping: true) if params[:default_shipping_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      redirect_to [:admin, @organization, :locations], notice: &quot;Successfully updated default addresses&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      @locations = @organization.locations.soft_delete(*params[:location_ids])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      redirect_to [:admin, @organization, :locations], notice: &quot;Successfully removed the address(es) #{location_names}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    def find_organization</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      @organization = current_user.managed_organizations.find(params[:organization_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    def location_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      params.require(:location).permit(:name, :address, :city, :state, :zip, :country, :phone, :fax, :default_billing)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">    def location_names</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      @locations.map(&amp;:name).to_sentence</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6fb0c2f8e219d28d8fa930578e6c48b93da70fbe">
  <div class="header">
    <h3>app/controllers/admin/markets_controller.rb</h3>
    <h4><span class="red">65.15 %</span> covered</h4>
    <div>
      <b>66</b> relevant lines. 
      <span class="green"><b>43</b> lines covered</span> and
      <span class="red"><b>23</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Admin::MarketsController &lt; AdminController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include StickyFilters</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :require_admin, only: [:new, :create]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :require_admin_or_market_manager, except: [:new, :create]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :find_scoped_market, only: [:show, :update, :payment_options, :update_active, :confirm_pending]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :find_sticky_params, only: :index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    if params[&quot;clear&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      redirect_to url_for(params.except(:clear))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      if @query_params.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">        @query_params = {:q =&gt; { :active_eq =&gt; true}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      @search_presenter = MarketSearchPresenter.new(@query_params, current_user)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      @q = search(@search_presenter)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      @markets = @q.result(distinct: true).periscope(request.query_parameters)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="22">
          <span class="hits">2</span>
          
          <code class="ruby">        format.html { @markets = @markets.page(params[:page]).per(params[:per_page]) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">        format.csv { @filename = &quot;markets.csv&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    @market = Market.new(payment_provider: PaymentProvider.for_new_markets.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    if ENV[&quot;USE_STRIPE_STANDALONE_ACCOUNTS&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      results = RegisterStripeMarket.perform(market_params: market_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">      results = RegisterStripeStandaloneMarket.perform(market_params: market_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    if results.success?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      redirect_to [:admin, results.market]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      flash.now.alert = &quot;Could not create market&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      @market = results.market</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      render :new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    if @market.update_attributes(market_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      redirect_to [:admin, @market]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      flash.now.alert = &quot;Could not update market&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      render :show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_active</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    @market.update_attribute(:active, params[:active])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    redirect_to :back, notice: &quot;Updated #{@market.name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  def confirm_pending</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    # Invite the market requester to be a Market Manager</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    results = AddMarketManager.perform(market: @market, email: @market.contact_email, inviter: current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    # If invitation sent successfully, then</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    if results.success?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      # activate the market...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      @market.update_attribute(:pending, params[:pending])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      @market.update_attribute(:active, true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      # ...define a temporary user for purposes of the welcome email...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      @user = User.new do |u|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        u.name = @market.contact_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        u.email = @market.contact_email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      # ...send market requester a welcome email...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      UserMailer.delay.market_welcome(@user, @market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      # ...and redirect with a notification message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      redirect_to :back, notice: &quot;Updated #{@market.name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      # Otherwise, redirect with the error message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      redirect_to :back, alert: &quot;Could not update #{@market.name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"> end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  def payment_options</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    @markets = Market.where(id: @market.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    render partial: &quot;payment_options&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">  def market_params</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">    columns = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      :subdomain,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      :tagline,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      :timezone,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      :contact_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">      :contact_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      :contact_phone,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      :facebook,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">      :twitter,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">      :profile,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">      :policies,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">      :logo,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">      :photo,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      :allow_cross_sell,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      :auto_activate_organizations,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      :closed,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      :store_closed_note,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      :sellers_edit_orders,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      :country,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      :product_label_format,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      :print_multiple_labels_per_item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    if current_user.can_manage_market?(@market)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">      columns.concat([</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        :allow_purchase_orders,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        :require_purchase_orders,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        :allow_credit_cards,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">        :allow_ach,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        :default_allow_purchase_orders,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">        :default_allow_credit_cards,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">        :default_allow_ach,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      ])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">    if current_user.admin?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">      columns.concat([</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">        :active,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        :stripe_standalone</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      ])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    params.require(:market).permit(columns)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">  def market_scope</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="144">
          <span class="hits">4</span>
          
          <code class="ruby">    Market.managed_by(current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_scoped_market</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="148">
          <span class="hits">3</span>
          
          <code class="ruby">    @market = market_scope.find(params[:id] || params[:market_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">  def search(search)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">    results = market_scope.search(search.query)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">    results</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="c28933f8248a5f1bd332c64a287705fb3178682d">
  <div class="header">
    <h3>app/controllers/admin/orders_controller.rb</h3>
    <h4><span class="red">18.02 %</span> covered</h4>
    <div>
      <b>111</b> relevant lines. 
      <span class="green"><b>20</b> lines covered</span> and
      <span class="red"><b>91</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Admin::OrdersController &lt; AdminController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include StickyFilters</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :find_sticky_params, only: :index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    if params[&quot;clear&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      redirect_to url_for(params.except(:clear))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      #@query_params[&quot;placed_at_date_gteq&quot;] ||= 7.days.ago.to_date.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      #@query_params[&quot;placed_at_date_lteq&quot;] ||= Date.today.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      @search_presenter = OrderSearchPresenter.new(@query_params, current_user, &quot;placed_at&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      @q, @totals = search_and_calculate_totals(@search_presenter)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      @orders = @q.result(distinct: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        format.html do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">          @orders = @orders.page(params[:page]).per(@query_params[:per_page])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        format.csv do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">          @order_items = find_order_items(@orders.map(&amp;:id))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">          @abort_mission = @order_items.count &gt; 2999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">          @filename = &quot;orders.csv&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def search_and_calculate_totals(search)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    results = Order.includes(:organization, :items, :delivery).orders_for_seller(current_user).search(search.query)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    results.sorts = &quot;placed_at desc&quot; if results.sorts.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    if !current_user.admin? &amp;&amp; (current_user.market_manager? || current_user.buyer_only?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      order_ids = results.result.map(&amp;:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      order_items = find_order_items(order_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      totals = OrderTotals.new(order_items)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    elsif current_user.seller?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      order_ids = results.result.map(&amp;:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      order_items = Orders::SellerItems.items_for_seller(order_ids, current_user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      totals = OrderTotals.new(order_items)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      totals = OrderTotals.new(OrderItem.where(&quot;1 = 0&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    [results, totals]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    order = Order.orders_for_seller(current_user).find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    if current_user.organization_ids.include?(order.organization_id) || current_user.can_manage_organization?(order.organization)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      @order = BuyerOrder.new(order)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      @order = SellerOrder.new(order, current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    setup_deliveries(@order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    track_event EventTracker::ViewedOrder.name, order: { url: admin_order_url(order.id), value: @order.order_number }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    order = Order.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    setup_deliveries(order)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    if params[&quot;items_to_add&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      return unless perform_add_items(order)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    elsif params[:commit] == &quot;Add Items&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      show_add_items_form(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    elsif params[:commit] == &quot;Change Delivery&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      update_delivery(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    elsif params[&quot;order&quot;][:delivery_clear] == &quot;true&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      remove_delivery_fee(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    elsif params[&quot;order&quot;][:credit_clear] == &quot;true&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      remove_credit(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    # TODO: Change an order items delivery status to &#39;removed&#39; or something rather then deleting them</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    perform_order_update(order, order_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_order_items(order_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    order_items = OrderItem.includes({product: [{general_product: :organization}, :organization]}, {order: :delivery}).joins(:product).where(:order_id =&gt; order_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    order_items</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  def order_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    params[:order].delete(:delivery_id) # Remove the parameter so it doesn&#39;t conflict</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    params[:order].delete(:delivery_clear) # Remove the parameter so it doesn&#39;t conflict</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    params[:order].delete(:credit_clear) # Remove the parameter so it doesn&#39;t conflict</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    params.require(:order).permit(:delivery_clear, :notes, items_attributes: [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      :id, :quantity, :quantity_delivered, :delivery_status, :_destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    ])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_delivery_fee(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    RemoveDeliveryFee.perform(order: order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    redirect_to admin_order_path(order), notice: order.delivery.delivery_schedule.fee_label + &quot; successfully removed.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_credit(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    RemoveCredit.perform(order: order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    redirect_to admin_order_path(order), notice: &quot;Credit successfully removed.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_delivery(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">    order = Order.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    updates = UpdateOrderDelivery.perform(user: current_user, order: order, delivery_id: params.require(:order)[:delivery_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    if updates.success?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">      redirect_to admin_order_path(order), notice: &quot;Delivery successfully updated.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">      redirect_to admin_order_path(order), alert: &quot;This order&#39;s delivery cannot be changed at this time. Our support team has been notified and will update you with more information.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">  def items_to_add</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    items = params.require(:items_to_add)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">    items.select {|i| i[:quantity].to_i &gt; 0 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">  def setup_add_items_form(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    @show_add_items_form = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    @order = SellerOrder.new(order, current_user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    user_order_context = UserOrderContext.build(user: current_user, order: @order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    if FeatureAccess.add_order_items?(user_order_context: user_order_context)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      if user_order_context.is_admin or user_order_context.is_market_manager</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">        # If admin or MM, do NOT limit products to seller org:</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">        @products_for_sale = ProductsForSale.new(order.delivery, order.organization, Cart.new(market: order.market))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        @products_for_sale = ProductsForSale.new(order.delivery, order.organization, Cart.new(market: order.market), {}, {seller: user_order_context.seller_organization })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">      @products_for_sale = ProductsForSale.new(order.delivery, order.organization, Cart.new(market: order.market))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  # Builds a list of deliveries for potential changes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  # Some from the past, some from future, and the order&#39;s actual one.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">  def setup_deliveries(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">    recent_deliveries = order.market.deliveries.recent.active.uniq</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">    future_deliveries = order.market.deliveries.future.active.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">    @deliveries = recent_deliveries | future_deliveries | [order.delivery]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">  def perform_order_update(order, params) # TODO this needs to handle price edits</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">    updates = UpdateOrder.perform(payment_provider: order.payment_provider, order: order, order_params: params, request: request)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">    if updates.success?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">      came_from_admin = request.referer.include?(&quot;/admin/&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      next_url = if order.reload.items.any?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">        came_from_admin ? admin_order_path(order) : order_path(order)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">        order.soft_delete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">        came_from_admin ? admin_orders_path : orders_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">      redirect_to next_url, notice: &quot;Order successfully updated.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">      order = updates.context[:order]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      order.errors.add(:payment_processor, &quot;failed to update your payment&quot;) if updates.context[:status] == &quot;failed&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">      @order = SellerOrder.new(order, current_user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">      render :show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">  def perform_add_items(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">    result = UpdateOrderWithNewItems.perform(payment_provider: order.payment_provider, order: order, item_hashes: items_to_add)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">    if !result.success?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      setup_add_items_form(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">      order.errors[:base] &lt;&lt; &quot;Failed to add items to this order.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      render :show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">  def show_add_items_form(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">    setup_add_items_form(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">    flash.now[:notice] = &quot;Add items below.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">    render :show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="eb8a89067b0eb299ccb2d5e1d5f1c7d3190eeb80">
  <div class="header">
    <h3>app/controllers/admin_controller.rb</h3>
    <h4><span class="red">61.54 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class AdminController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def require_admin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">    render_404 unless current_user.admin?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def require_admin_or_market_manager</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="9">
          <span class="hits">4</span>
          
          <code class="ruby">    return if current_user.admin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    return if current_user.managed_markets.any?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    render_404</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_market</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    @market = current_user.markets.find(params[:market_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def lookup_manageable_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @user = User.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    render_404 unless current_user.can_manage_user?(@user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f6393dcf7b183687bb7a1695b2e1926c0b4a7d9f">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4><span class="red">65.19 %</span> covered</h4>
    <div>
      <b>135</b> relevant lines. 
      <span class="green"><b>88</b> lines covered</span> and
      <span class="red"><b>47</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ApplicationController &lt; ActionController::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include EventTracker</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :configure_permitted_parameters, if: :devise_controller?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :masquerade_user!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authenticate_user!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :ensure_user_not_suspended</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :ensure_market_affiliation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :ensure_active_organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :set_timezone</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :set_intercom_attributes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :current_market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :current_organization</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :current_cart</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :current_delivery</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :redirect_to_url</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  helper_method :signed_in_root_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # Prevent CSRF attacks by raising an exception.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  # For APIs, you may want to use :null_session instead.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  protect_from_forgery with: :exception</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  rescue_from ActiveRecord::RecordNotFound, with: :render_404</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def track_event(event, metadata={})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    EventTracker.track_event_for_user current_user, event, metadata if current_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def signed_in_root_path(user)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="34">
          <span class="hits">18</span>
          
          <code class="ruby">    return root_path unless user</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="35">
          <span class="hits">14</span>
          
          <code class="ruby">    extra = on_main_domain? &amp;&amp; user.default_market ? {host: user.default_market.domain} : {}</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="36">
          <span class="hits">14</span>
          
          <code class="ruby">    if user.buyer_only?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="37">
          <span class="hits">3</span>
          
          <code class="ruby">      products_url(extra)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="39">
          <span class="hits">11</span>
          
          <code class="ruby">      dashboard_url(extra)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def after_update_path_for(_)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    dashboard_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def render_404</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    render file: Rails.root.join(&quot;public/404.html&quot;), status: :not_found</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_organization</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="52">
          <span class="hits">28</span>
          
          <code class="ruby">    if @current_organization &amp;&amp; (@last_organization_market == current_market || @current_organization.all_markets.include?(current_market))</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="53">
          <span class="hits">8</span>
          
          <code class="ruby">      @last_organization_market = current_market</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="54">
          <span class="hits">8</span>
          
          <code class="ruby">      return @current_organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="57">
          <span class="hits">20</span>
          
          <code class="ruby">    @last_organization_market = current_market</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="58">
          <span class="hits">20</span>
          
          <code class="ruby">    @current_organization = find_current_organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_current_organization</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="62">
          <span class="hits">20</span>
          
          <code class="ruby">    return nil unless current_market</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="63">
          <span class="hits">20</span>
          
          <code class="ruby">    return nil unless current_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="65">
          <span class="hits">16</span>
          
          <code class="ruby">    current_user.managed_organizations_within_market(current_market)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="66">
          <span class="hits">16</span>
          
          <code class="ruby">    organization = if current_user.managed_organizations.count == 1</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="67">
          <span class="hits">4</span>
          
          <code class="ruby">      current_user.managed_organizations.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    elsif session[:current_organization_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      current_user.managed_organizations.find_by(id: session[:current_organization_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="72">
          <span class="hits">16</span>
          
          <code class="ruby">    organization if organization &amp;&amp; organization.all_markets.include?(current_market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_market</code>
        </li>
      
        <li class="covered" data-hits="444" data-linenumber="76">
          <span class="hits">444</span>
          
          <code class="ruby">    @current_market ||= market_for_current_subdomain</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  # a before_action to ensure the current_user is affiliated with the market in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  # some capacity. 404 if not.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_market_affiliation</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="82">
          <span class="hits">12</span>
          
          <code class="ruby">    return if current_user.admin?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="83">
          <span class="hits">3</span>
          
          <code class="ruby">    if current_market.nil? || current_market != market_for_current_subdomain(current_user.markets)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      return render_404</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="87">
          <span class="hits">3</span>
          
          <code class="ruby">    unless current_market.active?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      render file: Rails.root.join(&quot;public/market_disabled.html&quot;), status: :forbidden</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_active_organization</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="93">
          <span class="hits">12</span>
          
          <code class="ruby">    return if current_user.nil?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="94">
          <span class="hits">12</span>
          
          <code class="ruby">    return if current_user.admin? || current_user.can_manage_market?(market_for_current_subdomain)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="95">
          <span class="hits">3</span>
          
          <code class="ruby">    if current_user.organizations.active.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      render file: Rails.root.join(&quot;public/organization_disabled.html&quot;), status: :forbidden</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_user_not_suspended</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="101">
          <span class="hits">12</span>
          
          <code class="ruby">    return if current_user.nil?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="102">
          <span class="hits">12</span>
          
          <code class="ruby">    return if current_user.admin? || current_user.can_manage_market?(market_for_current_subdomain)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="104">
          <span class="hits">3</span>
          
          <code class="ruby">    if current_user.suspended_from_all_orgs?(current_market)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">      render file: Rails.root.join(&quot;public/user_suspended.html&quot;), status: :forbidden</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">  def market_for_current_subdomain(scope=Market)</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="110">
          <span class="hits">29</span>
          
          <code class="ruby">    subdomain = request.subdomains(Figaro.env.domain.count(&quot;.&quot;)).first</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="111">
          <span class="hits">29</span>
          
          <code class="ruby">    scope.find_by(subdomain: SimpleIDN.to_unicode(subdomain))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">  def require_selected_market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">    return if current_market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    if current_user.markets.size == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">      redirect_to url_for(host: current_user.markets.first.domain)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">      render &quot;shared/select_market&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">  def on_main_domain?</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="125">
          <span class="hits">14</span>
          
          <code class="ruby">    request.host == Figaro.env.domain || request.host == &quot;app.#{Figaro.env.domain}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_delivery</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    return nil if current_market.blank? || current_organization.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    if defined?(@current_delivery)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      @current_delivery</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">      @current_delivery = find_or_build_current_delivery.try(:decorate)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_or_build_current_delivery</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">    if session[:current_delivery_day]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">      delivery_day = DateTime.parse(session[:current_delivery_day])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      delivery = Delivery.find(session[:current_delivery_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      if not delivery.buyer_deliver_on.day == delivery_day.day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">        new_delivery = DeliverySchedule.find(delivery.delivery_schedule_id).next_delivery_for_date(delivery_day) </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">        session[:current_delivery_id] = new_delivery.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      session[:current_delivery_day] = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">    if selected = Delivery.current_selected(current_market, session[:current_delivery_id]) </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">      selected</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    elsif only_delivery = current_market.only_delivery</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      session[:current_delivery_id] = only_delivery.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      only_delivery</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">  def selected_organization_location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    @selected_organization_location ||=</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">      (session[:current_location] &amp;&amp; current_organization.locations.visible.find_by(id: session[:current_location])) ||</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">      current_organization.shipping_location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_timezone</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="163">
          <span class="hits">20</span>
          
          <code class="ruby">    Time.zone = current_market.timezone if current_market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">  def hide_admin_navigation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    @hide_admin_nav = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_cart</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="171">
          <span class="hits">10</span>
          
          <code class="ruby">    return nil unless session[:cart_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">    return nil unless current_market.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">    return nil unless current_organization.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">    return nil unless current_delivery</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">    @current_cart ||= current_user.carts.includes(items: {product: :prices}).find_by(id: session[:cart_id]).try(:decorate)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="179">
          <span class="hits">1</span>
          
          <code class="ruby">  def require_cart</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    if !current_user.nil? &amp;&amp; !current_organization.nil? &amp;&amp; !current_market.nil? &amp;&amp; !current_delivery.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      @current_cart = Cart.find_or_create_by!(user_id: current_user.id, organization_id: current_organization.id, market_id: current_market.id, delivery_id: current_delivery.id) do |c|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">        c.location = selected_organization_location if current_delivery.requires_location?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      end.decorate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">      session[:cart_id] = @current_cart.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">  def require_organization_location</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="189">
          <span class="hits">1</span>
          
          <code class="ruby">    return unless current_organization &amp;&amp; current_organization.locations.visible.none?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">    redirect_to [:new_admin, current_organization, :location], alert: &quot;You must enter an address for this organization before you can shop&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">  def require_market_open</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">    render &quot;shared/market_closed&quot; if current_market.closed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">  def require_current_organization</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">    return unless current_organization.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">    redirect_to new_sessions_organization_path(redirect_back_to: request.original_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">  def require_current_delivery</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">    redir_opts = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">    if current_delivery.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      return if current_delivery.requires_location? &amp;&amp; selected_organization_location.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">      if current_delivery.can_accept_orders?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">        session[:current_delivery_id] = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">        redir_opts[:alert] = current_delivery.delivery_expired_notice</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">    redirect_to new_sessions_deliveries_path(redirect_back_to: request.fullpath), redir_opts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">  def configure_permitted_parameters</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="220">
          <span class="hits">8</span>
          
          <code class="ruby">    devise_parameter_sanitizer.for(:accept_invitation).concat [:name, :email]</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="221">
          <span class="hits">8</span>
          
          <code class="ruby">    devise_parameter_sanitizer.for(:account_update).concat [:name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">  def redirect_to_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">    params[:redirect_back_to] || [:products]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_intercom_attributes</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="229">
          <span class="hits">20</span>
          
          <code class="ruby">    intercom_custom_data.user[:market] = current_market.name if current_market</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="230">
          <span class="hits">20</span>
          
          <code class="ruby">    intercom_custom_data.user[:org] = current_organization.name if current_organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="234">
          <span class="hits">1</span>
          
          <code class="ruby">require Rails.root.join(&quot;app/controllers/audited_sweeper&quot;)</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2c95eec30d2cc16f5c17c3baf40e2e6b9cab24dc">
  <div class="header">
    <h3>app/controllers/audited_sweeper.rb</h3>
    <h4><span class="red">40.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &quot;audited/sweeper&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Audited::Sweeper &lt; ActionController::Caching::Sweeper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def before_create_with_masquerade(audit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    before_create_without_masquerade(audit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    if controller.try(:user_masquerade?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      user_id = controller.try(:session).try(:[], :devise_masquerade_user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      audit.masquerader_id = user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      username = User.select(:name).find_by(id: user_id).try(:name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      audit.masquerader_username = username</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  alias_method_chain :before_create, :masquerade</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="c2831a274b5fa3f5a209bbdc7f283f26aec9fd6d">
  <div class="header">
    <h3>app/controllers/concerns/sticky_filters.rb</h3>
    <h4><span class="red">72.73 %</span> covered</h4>
    <div>
      <b>22</b> relevant lines. 
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module StickyFilters</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def sticky_parameters(parameters)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="3">
          <span class="hits">4</span>
          
          <code class="ruby">    path = request.path.split(&quot;.&quot;).first</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="4">
          <span class="hits">4</span>
          
          <code class="ruby">    session[:sticky_parameters] ||= {}</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="5">
          <span class="hits">4</span>
          
          <code class="ruby">    existing_parameters = (session[:sticky_parameters][path] || {}).with_indifferent_access</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    # Clear parameters if given a clear key</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="8">
          <span class="hits">4</span>
          
          <code class="ruby">    if parameters[&quot;clear&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      existing_parameters = existing_parameters.slice(&quot;per_page&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      parameters = parameters.slice(&quot;per_page&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # Remove saved page if the user is on page 1</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="14">
          <span class="hits">4</span>
          
          <code class="ruby">    existing_parameters.delete(&quot;page&quot;) if existing_parameters.present? &amp;&amp; parameters[&quot;page&quot;].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # Merge new keys into existing parameters</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="17">
          <span class="hits">4</span>
          
          <code class="ruby">    new_parameters = existing_parameters.deep_merge(parameters)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="18">
          <span class="hits">4</span>
          
          <code class="ruby">    session[:sticky_parameters][path] = deep_remove_blank_keys(new_parameters)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="20">
          <span class="hits">4</span>
          
          <code class="ruby">    session[:sticky_parameters][path]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  def deep_remove_blank_keys(hash)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="26">
          <span class="hits">4</span>
          
          <code class="ruby">    hash = hash.deep_dup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="28">
          <span class="hits">4</span>
          
          <code class="ruby">    hash.each_with_object(hash) do |(key, value), hash|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      if value.is_a?(Hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        hash[key] = deep_remove_blank_keys(value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      elsif value.is_a?(Array) &amp;&amp; value.length &gt; 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        hash[key] = value.reject!(&amp;:blank?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        hash.delete(key) if value.blank? || (value.length == 1 &amp;&amp; value[0] == &quot;&quot;) || key.to_s =~ /.+%.+/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_sticky_params</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="40">
          <span class="hits">4</span>
          
          <code class="ruby">    @query_params = sticky_parameters(request.query_parameters)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="95ad399433a6e0dc85707ebe07bcd0243814f000">
  <div class="header">
    <h3>app/controllers/dashboards_controller.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class DashboardsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include StickyFilters</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :find_sticky_params, only: :show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="7">
          <span class="hits">3</span>
          
          <code class="ruby">    @query_params[&quot;placed_at_date_gteq&quot;] ||= 7.days.ago.to_date.to_s</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="8">
          <span class="hits">3</span>
          
          <code class="ruby">    @query_params[&quot;placed_at_date_lteq&quot;] ||= Date.today.to_s</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="9">
          <span class="hits">3</span>
          
          <code class="ruby">    @presenter = BuyerOrderPresenter.new(current_user, current_market, request.query_parameters, @query_params)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="10">
          <span class="hits">3</span>
          
          <code class="ruby">    @q = search_and_calculate_totals(@presenter)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="12">
          <span class="hits">3</span>
          
          <code class="ruby">    @buyer_orders ||= @q.result</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="13">
          <span class="hits">3</span>
          
          <code class="ruby">    @buyer_orders = @buyer_orders.page(params[:page]).per(@query_params[:per_page])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="15">
          <span class="hits">3</span>
          
          <code class="ruby">    render @presenter.template</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def coming_soon</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def search_and_calculate_totals(query)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="23">
          <span class="hits">3</span>
          
          <code class="ruby">    results = Order.includes(:organization, :items, :delivery).orders_for_buyer(current_user).search(query.query)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="24">
          <span class="hits">3</span>
          
          <code class="ruby">    results.sorts = &quot;placed_at desc&quot; if results.sorts.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="26">
          <span class="hits">3</span>
          
          <code class="ruby">    results</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="41ab7fc95b6bb8df94358bd839e7a88fa948c885">
  <div class="header">
    <h3>app/controllers/products_controller.rb</h3>
    <h4><span class="red">46.34 %</span> covered</h4>
    <div>
      <b>41</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ProductsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include ActiveSupport::NumberHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :require_selected_market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :require_market_open</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :require_current_organization</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :require_organization_location</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :require_current_delivery</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :require_cart</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :hide_admin_navigation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :load_products</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :load_sellers, only: [:search]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    if current_market.alternative_order_page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      render &#39;alternative_order_page&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    @product = @products_for_sale.products.first || raise(ActiveRecord::RecordNotFound)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    @breadcrumbs = [@product.category]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    while @breadcrumbs.last.parent_id.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      @breadcrumbs.push @breadcrumbs.last.parent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    @breadcrumbs.pop</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    @breadcrumbs.reverse!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def search</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    search = params[:q].gsub(/\W+/, &#39;+&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    org_filter = params[:organization] || @sellers.pluck(:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    if search.length &gt; 3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      matching_and_available_products = current_delivery</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        .object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        .delivery_schedule</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        .products</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        .with_available_inventory(current_delivery.deliver_on)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        .priced_for_market_and_buyer(current_market, current_organization)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        .where(organization_id: org_filter)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        .search_by_text(search)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">        .limit(50)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        .includes(:organization, :second_level_category, :prices, :unit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">        .uniq</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      render :json =&gt; matching_and_available_products.map {|p| search_hash(p)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      render :json =&gt; []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  def render_product_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    if product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      render :json =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        html: render_to_string(&quot;_table_row&quot;, :locals =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">          product: product.decorate(context: {current_cart: current_cart})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">        }, :layout =&gt; false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  def search_hash(product)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    prices = product.prices_for_market_and_organization(current_market, current_organization)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    formatted_prices = prices.map {|price| &quot;#{number_to_currency(price.sale_price)} for #{price.min_quantity}+&quot;}.join(&#39;, &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      :id=&gt; product.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      :name=&gt; product.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      :second_level_category_name =&gt; product.second_level_category.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      :seller_name =&gt; product.organization.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      :pricing =&gt; formatted_prices,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      :unit_with_description =&gt; product.unit_with_description(:plural)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_sellers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    @sellers ||= current_market.organizations.where(can_sell: true, active: true).order(:name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_products</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    @products_for_sale = ProductsForSale.new(current_delivery, current_organization, current_cart, request.query_parameters, product_id: params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="0aa5301e5e54fc5ea9b019e96be426708f9ce2d2">
  <div class="header">
    <h3>app/decorators/market_decorator.rb</h3>
    <h4><span class="red">32.18 %</span> covered</h4>
    <div>
      <b>87</b> relevant lines. 
      <span class="green"><b>28</b> lines covered</span> and
      <span class="red"><b>59</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class MarketDecorator &lt; Draper::Decorator</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include ActionView::Helpers::NumberHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include Draper::LazyHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include MapHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def affiliation_item(_)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    content_tag(:li, &quot;#{name}, Market Manager&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def first_address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    addresses.visible.first # remaining, in case (TODO should this go?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def default_address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    default_addrs = addresses.visible.select{|addr| addr if addr.default? } # this should have only one in the array if any</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    unless default_addrs.empty? </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      default_addrs.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      addresses.visible.first # if an address can be properly default or billing via those attrs, it must also be visible (not soft-deleted)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  def billing_address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    billing_addrs = addresses.visible.select{|addr| addr if addr.billing? } # should be just one again</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    unless billing_addrs.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      billing_addrs.first </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      addresses.visible.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def remit_to_address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    remit_to_addrs = addresses.visible.select{|addr| addr if addr.remit_to? } # should be just one again</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    unless remit_to_addrs.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      remit_to_addrs.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  def seller_locations_map(w=400, h=400)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    addresses = organizations.selling.map do |seller|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      seller.shipping_location.geocode if seller.shipping_location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    static_map(addresses, default_address.try(:geocode), w, h)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_address?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    addresses.visible.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_remit_to_address?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    remit_to_address</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def remit_to_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    remit_to_address.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def billing_street_address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    billing_address.address</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  def remit_to_street_address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    remit_to_address.address</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  def billing_city_state_zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    &quot;#{billing_address.city}, #{billing_address.state} #{billing_address.zip}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  def remit_to_city_state_zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    &quot;#{remit_to_address.city}, #{remit_to_address.state} #{remit_to_address.zip}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">  def billing_address_phone_number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    if billing_address.phone</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">      number = billing_address.phone.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      number = contact_phone.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    formatted_num = number.gsub(/[^0-9]/, &quot;&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    if formatted_num.length == 10</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      number_to_phone(formatted_num, area_code: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      number.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  def remit_to_phone_number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    if remit_to_address.phone</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">      number = remit_to_address.phone.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      number = contact_phone.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">    formatted_num = number.gsub(/[^0-9]/, &quot;&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    if formatted_num.length == 10</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      number_to_phone(formatted_num, area_code: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      number.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  # TODO: implement default_street_address etc. if needed.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  # TODO: remove repetion.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">  def default_address_phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    # The &#39;try&#39; here bypasses an erroneous thrown error if there&#39;s no default_address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">    if default_address.try(:phone)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">      number = default_address.phone.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">      number = contact_phone.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">    formatted_num = number.gsub(/[^0-9]/, &quot;&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">    if formatted_num.length == 10</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">      number_to_phone(formatted_num, area_code: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      number.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">  def display_contact_phone</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">    number = contact_phone.to_s.gsub(/[^0-9]/, &quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">    # if we have a clean phone number, format it appropriately, otherwise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    # just display what they give us</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    if number.length == 10</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      number_to_phone(number, area_code: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      contact_phone.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">  def display_plan_interval</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">    if plan_interval == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">      &quot;Monthly&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    elsif plan_interval == 12</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">      &quot;Yearly&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">      &quot;Not Set&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">  def header</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="145">
          <span class="hits">3</span>
          
          <code class="ruby">    if name.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      changes[:name].first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="148">
          <span class="hits">3</span>
          
          <code class="ruby">      name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">  def payble_accounts_for_select</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">    bank_accounts.visible.where(account_type: %w(savings checking)).order(verified: :desc).map do |bank_account|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">      [bank_account.display_name, bank_account.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">  def payment_accounts_for_select</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    bank_accounts.visible.map do |bank_account|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">      next unless bank_account.usable_for?(:debit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">      [bank_account.display_name, bank_account.id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">    end.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="3a61abaaa49d3c236b2285d8f25be66b7799a90b">
  <div class="header">
    <h3>app/interactors/create_market.rb</h3>
    <h4><span class="red">72.73 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class CreateMarket</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include Interactor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def perform</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    defaults = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      payment_provider: PaymentProvider.for_new_markets.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      stripe_standalone: ENV[&quot;USE_STRIPE_STANDALONE_ACCOUNTS&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    market = Market.create(defaults.merge(market_params))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    context[:market] = market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    unless market.valid? &amp;&amp; market.errors.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      context.fail!(error: &quot;Could not create Market&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def rollback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    if context_market = context[:market]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        context_market.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"># post data  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"># {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    # &quot;utf8&quot;=&gt;&quot;✓&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    # &quot;authenticity_token&quot;=&gt;&quot;S/X6xzq2q9UpL9OHvH9kopt8Uv5HMyUjeEAgECi2mEY=&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    # &quot;market&quot;=&gt;{</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    #     &quot;name&quot;=&gt;&quot;Daves Market&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    #     &quot;subdomain&quot;=&gt;&quot;davesmarket&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    #     &quot;tagline&quot;=&gt;&quot;The world&#39;s best tagline&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    #     &quot;timezone&quot;=&gt;&quot;Eastern Time (US &amp; Canada)&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    #     &quot;contact_name&quot;=&gt;&quot;Dave Crosby&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    #     &quot;contact_email&quot;=&gt;&quot;c+market@atomicobject.com&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    #     &quot;contact_phone&quot;=&gt;&quot;616 821 9214&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    #     &quot;facebook&quot;=&gt;&quot;davesmarket&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    #     &quot;twitter&quot;=&gt;&quot;davesmarket&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    #     &quot;profile&quot;=&gt;&quot;The profile of Daves Market&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    #     &quot;policies&quot;=&gt;&quot;The policies of Daves Market&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    #     &quot;closed&quot;=&gt;&quot;0&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    #     &quot;auto_activate_organizations&quot;=&gt;&quot;1&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    #     &quot;store_closed_note&quot;=&gt;&quot;We am closed sry.&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    #     &quot;allow_cross_sell&quot;=&gt;&quot;0&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    #     &quot;sellers_edit_orders&quot;=&gt;&quot;0&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    #     &quot;allow_purchase_orders&quot;=&gt;&quot;1&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    #     &quot;allow_credit_cards&quot;=&gt;&quot;1&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    #     &quot;allow_ach&quot;=&gt;&quot;1&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    #     &quot;default_allow_purchase_orders&quot;=&gt;&quot;0&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    #     &quot;default_allow_credit_cards&quot;=&gt;&quot;1&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    #     &quot;default_allow_ach&quot;=&gt;&quot;1&quot;}, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    #     &quot;commit&quot;=&gt;&quot;Add Market&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    # }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    # columns = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    #   :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    #   :subdomain,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    #   :tagline,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    #   :timezone,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    #   :contact_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    #   :contact_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    #   :contact_phone,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    #   :facebook,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    #   :twitter,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    #   :profile,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    #   :policies,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    #   :logo,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    #   :photo,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    #   :allow_cross_sell,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    #   :auto_activate_organizations,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    #   :closed,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    #   :store_closed_note,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    #   :sellers_edit_orders</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    # ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    # if current_user.admin?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    #   columns.concat([</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    #     :active,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    #     :allow_purchase_orders,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    #     :allow_credit_cards,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    #     :allow_ach,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    #     :default_allow_purchase_orders,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    #     :default_allow_credit_cards,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    #     :default_allow_ach,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    #   ])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    # params.require(:market).permit(columns)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ab4d181a8c951355dfcd2106d811e8fbaecff1f1">
  <div class="header">
    <h3>app/interactors/create_stripe_customer_for_entity.rb</h3>
    <h4><span class="yellow">85.71 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class CreateStripeCustomerForEntity</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include Interactor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def setup</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    context[:entity] ||= context[:market] || context[:organization]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def perform</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    entity = context[:entity]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    if entity.stripe_customer_id.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      customer = PaymentProvider::Stripe.create_customer(stripe_customer_info)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">      entity.update_attribute(:stripe_customer_id, customer.id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      context[:stripe_customer] = customer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      context[:stripe_customer] = PaymentProvider::Stripe.get_stripe_customer(entity.stripe_customer_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    context.fail!(error: e.message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def stripe_customer_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      description: entity.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      metadata: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        &quot;lo.entity_id&quot; =&gt; entity.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        &quot;lo.entity_type&quot; =&gt; entity.class.name.underscore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="c520bf7043597e306218a876c19241490547a1ae">
  <div class="header">
    <h3>app/interactors/process_packing_labels_printable.rb</h3>
    <h4><span class="red">58.82 %</span> covered</h4>
    <div>
      <b>17</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ProcessPackingLabelsPrintable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include Interactor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def perform</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    packing_labels_printable_id, request, product_labels_only, product_label_format, print_multiple_labels_per_item = require_in_context(:packing_labels_printable_id, :request, :product_labels_only, :product_label_format, :print_multiple_labels_per_item)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    delivery_printable = PackingLabelsPrintable.find packing_labels_printable_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    delivery = delivery_printable.delivery</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    user = delivery_printable.user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    orders = delivery.orders.for_seller(user).sort_by(&amp;:billing_organization_name)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="10">
          <span class="hits">3</span>
          
          <code class="ruby">    seller_orders = orders.map do |o| SellerOrder.new(o,user) end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # pdf_result = PackingLabels::Generator.generate(orders: orders, request: request)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    result = PackingLabels::Generator.generate(orders: seller_orders, request: request, product_labels_only: product_labels_only, product_label_format: product_label_format, print_multiple_labels_per_item: print_multiple_labels_per_item)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    if product_label_format == 1 # Zebra label format</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      delivery_printable.zpl = result</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      delivery_printable.zpl_name = &quot;delivery_labels.zpl&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      delivery_printable.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      delivery_printable.pdf = result.data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      delivery_printable.pdf.name = &quot;delivery_labels.pdf&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      delivery_printable.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e2096b790a64bd089e1c0f6a5c3ce6323c1c5902">
  <div class="header">
    <h3>app/interactors/register_stripe_standalone_market.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class RegisterStripeStandaloneMarket</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include Interactor::Organizer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  organize CreateMarket, CreateStripeCustomerForEntity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1536ac38ba90496ac08e8c77134683fcddcc06fb">
  <div class="header">
    <h3>app/models/audit.rb</h3>
    <h4><span class="yellow">83.33 %</span> covered</h4>
    <div>
      <b>12</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &quot;audited/adapters/active_record/audit&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Audited::Adapters::ActiveRecord::Audit &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include PgSearch</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :masquerader, class_name: &quot;User&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :search, method: :for_search, ignore_blank: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  pg_search_scope :search_by_name, :associated_against =&gt; {:user =&gt; [:name, :email]}, using: {tsearch: {prefix: true}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_search(query)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    search_by_name(query)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.decorator_class</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    AuditDecorator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"># Alias constant for easier use</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">Audit = Audited::Adapters::ActiveRecord::Audit</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="98760ea3d5f477bb2648f853cc6be3734ccf6503">
  <div class="header">
    <h3>app/models/bank_account.rb</h3>
    <h4><span class="red">58.14 %</span> covered</h4>
    <div>
      <b>43</b> relevant lines. 
      <span class="green"><b>25</b> lines covered</span> and
      <span class="red"><b>18</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class BankAccount &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true, associated_with: :bankable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include SoftDelete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :save_for_future</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :bankable, polymorphic: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :account_is_unique_to_bankable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :verified, -&gt; { where(verified: true) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :unverified, -&gt; { where(verified: false) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :debitable_bank_accounts, -&gt; { visible.verified.where(account_type: %w(savings checking)) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :creditable_bank_accounts, -&gt; { visible.where(account_type: %w(savings checking)) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :credit_cards, -&gt; { visible.where.not(account_type: %w(savings checking)) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :deposit_accounts, -&gt; { visible.where(account_role: &#39;deposit&#39;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def balanced_verification</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    return nil if verified? || balanced_verification_uri.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    @balanced_verification ||= Balanced::Verification.find(balanced_verification_uri)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  rescue Balanced::NotFound # Probably bad account info</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def bank_account?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    account_type == &quot;checking&quot; || account_type == &quot;savings&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def credit_card?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    !bank_account?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def display_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    if bank_account?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      &quot;ACH: #{bank_name} - *********#{last_four}#{&quot; NOT VERIFIED&quot; unless verified?}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      &quot;#{bank_name} ending in #{last_four}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def expired?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    return false if bank_account?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    now = Time.current</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    expiration_year &lt; now.year || (expiration_month &lt; now.month &amp;&amp; expiration_year == now.year)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  # Checking or savings accounts must be verified to process a debit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  # but can be credited without being verified (not recommended)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  # Credit cards must be current and can only be used in debits</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  def usable_for?(transaction_type=:debit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    (bank_account? &amp;&amp; (verified? || transaction_type == :credit)) || (credit_card? &amp;&amp; !expired? &amp;&amp; transaction_type == :debit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  def verification_failed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    return false if verified?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    return true if balanced_verification.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    balanced_verification.try(:state) == &quot;failed&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def primary_payment_provider</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    if bankable and bankable.respond_to?(:primary_payment_provider)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      bankable.primary_payment_provider</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      raise &quot;Bankable #{bankable.inspect} doesn&#39;t respond to :primary_payment_provider&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  def account_is_unique_to_bankable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    accounts = bankable.bank_accounts.visible.where(account_type: account_type, last_four: last_four, bank_name: bank_name, name: name)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">    accounts = accounts.where.not(id: id) if persisted?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    errors.add(:bankable_id, &quot;already exists for this #{bankable_type.downcase}.&quot;) if accounts.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="d52230d753807901405106120b3f0ec97cb559ab">
  <div class="header">
    <h3>app/models/bank_account_verification.rb</h3>
    <h4><span class="red">45.45 %</span> covered</h4>
    <div>
      <b>22</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>12</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class BankAccountVerification</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include ActiveModel::Model</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :amount_1, :amount_2, :bank_account</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :amount_1, :amount_2, numericality: {greater_than: 0, less_than: 100, only_integer: true}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def attempts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    bank_account.balanced_verification.try(:attempts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def failed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    bank_account.verification_failed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def remaining_attempts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    bank_account.balanced_verification.try(:remaining_attempts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def state</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    bank_account.balanced_verification.try(:state) || &quot;missing&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    return false unless valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    results = VerifyBankAccount.perform(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      bank_account: bank_account,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      verification_params: {amount_1: amount_1, amount_2: amount_2})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    if results.success?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      errors.add(:base, &quot;Could not verify bank account.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      # clear memoized data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      self.bank_account = BankAccount.find bank_account.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  def persisted?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="297cefce289857cab7e23b896510618bb7816081">
  <div class="header">
    <h3>app/models/batch_invoice.rb</h3>
    <h4><span class="red">80.0 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class BatchInvoice &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module GenerationStatus</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    NotStarted = &quot;not_started&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    Generating = &quot;generating&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    Complete = &quot;complete&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    Failed = &quot;failed&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  has_and_belongs_to_many :orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :batch_invoice_errors</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_presence_of :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :pdf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_user, (lambda do |user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    if user.admin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      where(user:user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b00f6b151e773fb0f7935745af0a2f8bce775b5b">
  <div class="header">
    <h3>app/models/batch_invoice_error.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class BatchInvoiceError &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :batch_invoice</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7d6b95f77de50a87acdf09faa7b69bd2adad8909">
  <div class="header">
    <h3>app/models/batch_invoice_order.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class BatchInvoiceOrder &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :batch_invoice</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6f7876cc8dc0c78e0b74b2e424a3cf2dead3239d">
  <div class="header">
    <h3>app/models/cart.rb</h3>
    <h4><span class="red">60.0 %</span> covered</h4>
    <div>
      <b>35</b> relevant lines. 
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Cart &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :organization</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :delivery</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :location, -&gt; { visible }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :discount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :organization, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :market, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :delivery, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :items, -&gt; { includes(product: [:prices, :organization]) }, class_name: :CartItem, inverse_of: :cart do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    def for_checkout</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      eager_load(product: [:organization, :prices]).order(&quot;organizations.name, products.name&quot;).group_by do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        item.product.organization.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  def delivery_location</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    if delivery.delivery_schedule.buyer_pickup?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      delivery.delivery_schedule.buyer_pickup_location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      location || organization.shipping_location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def subtotal</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    (@subtotal ||= items.each.sum(&amp;:total_price)).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_valid_discount?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    discount.try(:valid_for_cart?, self) || false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def discount_amount</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    order_total = if discount.try(:seller_organization_id).present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      delivery_fees + items.joins(:product).where(products: {organization_id: discount.seller_organization_id}).each.sum(&amp;:total_price)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      delivery_fees + subtotal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    (@discount_amount ||= discount.try(:valid_for_cart?, self) ? discount.value_for(order_total) : 0).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def discount_code</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    discount.try(:code)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def delivery_fees</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    delivery.delivery_schedule.fees_for_amount(subtotal).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    (subtotal + delivery_fees - discount_amount).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b71115e9c06f79e0e3fecf9a5250368dc6876f2b">
  <div class="header">
    <h3>app/models/cart_item.rb</h3>
    <h4><span class="red">54.29 %</span> covered</h4>
    <div>
      <b>35</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class CartItem &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include ActiveSupport::NumberHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true, associated_with: :cart</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :cart, inverse_of: :items</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :product</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :cart, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :product, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :quantity, numericality: {greater_than_or_equal_to: 0, less_than: 2_147_483_647, only_integer: true}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :validate_minimum_quantity, unless: &quot;errors.has_key? :quantity&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :quantity_is_available, unless: &quot;errors.has_key? :quantity&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  def unit_price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    Orders::UnitPriceLogic.unit_price(product, cart.market, cart.organization, Time.current.end_of_minute, quantity)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def total_price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    return 0.0 unless quantity &amp;&amp; quantity &gt; 0 &amp;&amp; unit_price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    unit_price.sale_price * quantity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def formatted_total_price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    number_to_currency total_price</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def unit_sale_price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    return 0.0 unless unit_price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    unit_price.sale_price</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def as_json(_opts=nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    super(methods: [:total_price, :unit_sale_price, :valid?, :destroyed?, :formatted_total_price])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  def unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    if quantity == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      product.unit_singular</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      product.unit_plural</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_minimum_quantity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    if product &amp;&amp; quantity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      min_purchase_quantity = product.minimum_quantity_for_purchase(organization: cart.organization, market: cart.market)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      if min_purchase_quantity &gt; quantity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        errors.add(:quantity, &quot;: You must order at least #{min_purchase_quantity}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def quantity_is_available</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    if product &amp;&amp; product.available_inventory &lt; quantity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      errors.add(:quantity, &quot;available for purchase: #{product.available_inventory}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b8abd46ac4f9f547810732f7bb83095dbf0c9ed5">
  <div class="header">
    <h3>app/models/category.rb</h3>
    <h4><span class="red">56.25 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Category &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_nested_set order: :name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :products</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_products, lambda {|products| joins(:products).where(products: {id: products}).uniq }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Returns select list options with root Categories as option groups</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # {&quot;Beverages&quot; =&gt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  #    [&quot;Coffee, Tea, &amp; Cocoa / Coffee&quot;, 2518],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  #    [&quot;Beer, Wine, &amp; Spirits / Beer / Ale&quot;, 2521],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  #    [&quot;Beer, Wine, &amp; Spirits / Wine / Red Wine&quot;, 2523],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  #  ]}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_select</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    hash = Hash.new {|h, k| h[k] = [] } # default keys to []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    names = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    each_with_level(root.descendants) do |category, depth|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      names[depth] = category.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      if category.leaf?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        hash[names[1]] &lt;&lt; [names[2..depth].join(&quot; / &quot;), category.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def top_level_category</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="31">
          <span class="hits">18</span>
          
          <code class="ruby">    @top_level_category ||= self_and_ancestors.find_by(depth: 1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a1bbaf91e7964c1847557d0d4f6667e637212e2e">
  <div class="header">
    <h3>app/models/concerns/delivery_status.rb</h3>
    <h4><span class="red">59.09 %</span> covered</h4>
    <div>
      <b>22</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module DeliveryStatus</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def delivery_status_for_user(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    order_items = items_for_seller(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    aggrigate_delivery_status_for_items(order_items)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  def delivered?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    aggrigate_delivery_status_for_items(items) == &quot;delivered&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def undelivered_for_user?(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    delivery_status_for_user(user) == &quot;pending&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def cache_delivery_status</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="18">
          <span class="hits">3</span>
          
          <code class="ruby">    self.delivery_status = aggrigate_delivery_status_for_items(items)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  def statuses_within(statuses, query)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    (query &amp; statuses) == query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def items_for_seller(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    organization_ids = user.managed_organizations.map(&amp;:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    if user.admin? || user.market_manager? || organization_ids.include?(organization_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      items</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      items.joins(:product).where(products: {organization_id: organization_ids})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def aggrigate_delivery_status_for_items(items)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="37">
          <span class="hits">3</span>
          
          <code class="ruby">    statuses = (items.try(:loaded?) ? items.map(&amp;:delivery_status) : items.pluck(:delivery_status)).map(&amp;:downcase).uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="39">
          <span class="hits">3</span>
          
          <code class="ruby">    Orders::DeliveryStatusLogic.overall_status(statuses)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    # TODO: Currently, canceled will only return if all items are canceled, this logic needs to be confirmed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    # if statuses.size &gt; 1 &amp;&amp; statuses.include?(&quot;canceled&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    #   statuses.delete(&quot;canceled&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    # if statuses.size == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    #   statuses.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    # elsif statuses_within(statuses, %w(pending delivered contested))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    #   &quot;contested, partially delivered&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    # elsif statuses.include?(&quot;contested&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    #   &quot;contested&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    # elsif statuses_within(statuses, %w(delivered pending))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    #   &quot;partially delivered&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    # else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    #   &quot;canceled&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="16511fde3c30d5c083ec480a9abf361ca88e8039">
  <div class="header">
    <h3>app/models/concerns/soft_delete.rb</h3>
    <h4><span class="red">64.71 %</span> covered</h4>
    <div>
      <b>17</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module SoftDelete</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  included do</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="5">
          <span class="hits">25</span>
          
          <code class="ruby">    scope :visible, -&gt; { where(visible_conditional) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def soft_delete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    update_attribute(:deleted_at, Time.current)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def undelete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    update_attribute(:deleted_at, nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  module ClassMethods</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    def soft_delete(*ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      records = ids.empty? ? all : where(id: ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      records.update_all(deleted_at: Time.current) if records.any?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      records</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    def soft_delete_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      update_all(deleted_at: Time.current)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    def visible_conditional</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="28">
          <span class="hits">12</span>
          
          <code class="ruby">      arel_table[:deleted_at].eq(nil).or(arel_table[:deleted_at].gt(Time.current.end_of_minute))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b0c319fd45fe3ce704a387af0de8bb20df0ceda4">
  <div class="header">
    <h3>app/models/concerns/sortable.rb</h3>
    <h4><span class="red">46.15 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># To use, implement an arel_column_for_sort class method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># on the model and include this module.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Sortable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  extend ActiveSupport::Concern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  module ClassMethods</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    def arel_column_for_sort(_column_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      raise &quot;method not implemented&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    def for_sort(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      column_name, direction = column_and_direction(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      arel_column = arel_column_for_sort(column_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      direction == &quot;asc&quot; ? order(arel_column.asc) : order(arel_column.desc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    def column_and_direction(string)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      column, direction = string.split(&quot;-&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      direction = &quot;asc&quot; unless direction == &quot;desc&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      [column, direction]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="aadbe6f03a049d0c65f09087b486a2cfc22fd6fb">
  <div class="header">
    <h3>app/models/credit.rb</h3>
    <h4><span class="red">59.62 %</span> covered</h4>
    <div>
      <b>52</b> relevant lines. 
      <span class="green"><b>31</b> lines covered</span> and
      <span class="red"><b>21</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Credit &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include SoftDelete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :order, autosave: false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :paying_org, class: Organization</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  after_save :update_order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  audited associated_with: :order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  PERCENTAGE = &quot;percentage&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  FIXED = &quot;fixed&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  TOTAL = &quot;total&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  SUBTOTAL = &quot;subtotal&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  MARKET = &quot;market&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  ORGANIZATION = &quot;supplier organization&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  AMOUNT_TYPES = [PERCENTAGE, FIXED]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  PAYER_TYPES = [MARKET, ORGANIZATION]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  APPLY_TO_TYPES = [TOTAL, SUBTOTAL]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :order, :user, :amount_type, :amount, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :amount_type, inclusion: {in: AMOUNT_TYPES, message: &quot;Not a valid credit type.&quot;}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :payer_type, inclusion: {in: PAYER_TYPES, message: &quot;Not a valid payer type.&quot;}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :amount, numericality: {greater_than_or_equal_to: 0}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :amount_cannot_exceed_gross_total, :order_must_be_paid_by_po, :amount_cannot_exceed_paying_org_total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def calculated_amount</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    if apply_to == Credit::TOTAL</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      total = order.gross_total + order.delivery_fees</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      total = order.subtotal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    if amount_type == Credit::PERCENTAGE</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      (total * (amount / 100)).round 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    elsif amount_type == Credit::FIXED</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def amount=(value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    write_attribute(:amount, value &amp;&amp; value.to_f.round(2))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_order_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    order.update_total_cost</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  def amount_cannot_exceed_gross_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    if percentage_amount_too_high || fixed_amount_too_high</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      errors.add(:amount, &quot;can&#39;t exceed the order&#39;s gross total&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  def amount_cannot_exceed_paying_org_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    if amount != nil &amp;&amp; payer_type == Credit::ORGANIZATION &amp;&amp; paying_org != nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      seller_items = order.items.select {|i| i.seller == paying_org }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      seller_total = seller_items.sum(&amp;:seller_net_total)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      if calculated_amount &gt; seller_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        errors.add(:amount, &quot;total cannot exceed the net profit of the organization responsible for it&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  def order_must_be_paid_by_po</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    if order &amp;&amp; order.payment_method != &quot;purchase order&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      errors.add(:order, &quot;must be paid for by purchase order&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_order</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    order.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  def percentage_amount_too_high</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    amount != nil &amp;&amp; amount_type == Credit::PERCENTAGE &amp;&amp; amount &gt; 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  def fixed_amount_too_high</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    amount != nil &amp;&amp; order != nil &amp;&amp; amount_type == Credit::FIXED &amp;&amp; amount &gt; order.gross_total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="4f991ff19695b52aebdb2453536bb907dd77e895">
  <div class="header">
    <h3>app/models/delivery.rb</h3>
    <h4><span class="red">65.38 %</span> covered</h4>
    <div>
      <b>26</b> relevant lines. 
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Delivery &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true, associated_with: :delivery_schedule</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :delivery_schedule</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :orders, inverse_of: :delivery</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :upcoming, -&gt; { where(&quot;deliveries.cutoff_time &gt; ?&quot;, Time.current.end_of_minute) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :future, -&gt; { where(&quot;deliveries.buyer_deliver_on &gt;= ?&quot;, Time.current.midnight) } # FIXME: current.midnight is in the past</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :recent, -&gt; { where(deliver_on: (4.weeks.ago..Time.current.end_of_minute)) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :with_undelivered_orders, -&gt; { joins(orders: {items: :product}).where(order_items: {delivery_status: &quot;pending&quot;}).group(&quot;deliveries.id&quot;) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :with_undelivered_orders_for_user, lambda {|user| with_undelivered_orders.where(products: {organization_id: user.organization_ids}) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :active, -&gt; { joins(:delivery_schedule).where(DeliverySchedule.visible_conditional) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.current_selected(market, id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    return nil unless id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    active.for_market(market).find_by(id: id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_market(market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    joins(:delivery_schedule).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    where(delivery_schedules: {market_id: market.id})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_seller(seller)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    joins(:delivery_schedule).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    where(delivery_schedules: {market_id: [seller.markets.pluck(:id)]})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.upcoming_for_seller(seller)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    ids = Order.undelivered_orders_for_seller(seller).upcoming_delivery.pluck(:delivery_id).uniq</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    where(id: ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def products_available_for_sale(organization)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    delivery_schedule.products_available_for_sale(organization, deliver_on)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  def requires_location?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    delivery_schedule &amp;&amp; !delivery_schedule.buyer_pickup?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_accept_orders?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    cutoff_time &gt; Time.current.end_of_minute</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="13544cd42bc470d0e882cf253a78e74d2941cb22">
  <div class="header">
    <h3>app/models/delivery_note.rb</h3>
    <h4><span class="yellow">88.89 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class DeliveryNote &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">	audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">	include SoftDelete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">	validates :supplier_org, :buyer_org, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :supplier, class_name: &quot;Organization&quot;, foreign_key: &quot;supplier_org&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :buyer, class_name: &quot;Organization&quot;, foreign_key: &quot;buyer_org&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">	belongs_to :order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">	def self.alphabetical_by_supplier_org</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">		order(supplier_org: :asc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="97def70c5f28df0dc2428a1d0ab2a61122027fa9">
  <div class="header">
    <h3>app/models/delivery_schedule.rb</h3>
    <h4><span class="red">74.79 %</span> covered</h4>
    <div>
      <b>119</b> relevant lines. 
      <span class="green"><b>89</b> lines covered</span> and
      <span class="red"><b>30</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class DeliverySchedule &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true, associated_with: :market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include SoftDelete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  WEEKDAYS = %w(Sunday Monday Tuesday Wednesday Thursday Friday Saturday)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  WEEKDAY_ABBREVIATIONS = %w(Su M Tu W Th F Sa)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  WeekdayValidation = {presence: true, numericality: {greater_than_or_equal_to: 0, less_than_or_equal_to: 6,   allow_nil: true}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market, inverse_of: :delivery_schedules</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :seller_fulfillment_location, class: MarketAddress</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :buyer_pickup_location,       class: MarketAddress</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :deliveries</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :product_deliveries</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :products, through: :product_deliveries</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :day,                            WeekdayValidation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :buyer_day,                      WeekdayValidation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :order_cutoff, presence: true, numericality: {greater_than_or_equal_to: 0, less_than_or_equal_to: 504, allow_nil: true}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :seller_fulfillment_location_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :seller_delivery_start,          presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :seller_delivery_end,            presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :buyer_pickup_location_id,       presence: true, unless: :direct_to_customer?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :buyer_pickup_end,               presence: true, unless: :direct_to_customer?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :buyer_pickup_start,             presence: true, unless: :direct_to_customer?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :buyer_pickup_end_after_start,                      unless: :direct_to_customer?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :seller_delivery_end_after_start</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :seller_day_and_buyer_day_are_same, if: :direct_to_customer?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  before_validation :ensure_days_are_set</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  # used on Sales by Fulfillment report where OrderItems are filtered by type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  # (Seller to Buyer or Market to Buyer) or pickup location</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  ransacker :fulfillment_type do |_|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    Arel.sql(&lt;&lt;-SQL</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      CASE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        WHEN (delivery_schedules.seller_fulfillment_location_id != 0) AND (delivery_schedules.buyer_pickup_location_id = 0) THEN &#39;S2B&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        WHEN (delivery_schedules.seller_fulfillment_location_id = 0)  AND (delivery_schedules.buyer_pickup_location_id = 0) THEN &#39;M2B&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">        ELSE delivery_schedules.buyer_pickup_location_id::TEXT</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      END</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    SQL</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def products_available_for_sale(organization, deliver_on_date=Time.current.end_of_minute)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    participating_products.available_for_sale(market, organization, deliver_on_date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def participating_products</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    scope = if require_delivery? &amp;&amp; require_cross_sell_delivery?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      Product</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    elsif require_delivery?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      Product.joins(&quot;LEFT JOIN product_deliveries ON products.id = product_deliveries.product_id&quot;).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">              where(&quot;(market_organizations.cross_sell_origin_market_id IS NULL) OR product_deliveries.delivery_schedule_id = :id&quot;, id: id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    elsif require_cross_sell_delivery?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      Product.joins(&quot;LEFT JOIN product_deliveries ON products.id = product_deliveries.product_id&quot;).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">              where(&quot;(market_organizations.cross_sell_origin_market_id IS NOT NULL) OR product_deliveries.delivery_schedule_id = :id&quot;, id: id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      products</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    scope.for_market_id(market_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  def active?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    deleted_at == nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  def buyer_pickup?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    has_seller_fulfillment_location? and has_buyer_pickup_location?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  def direct_to_customer?</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="77">
          <span class="hits">26</span>
          
          <code class="ruby">    !has_seller_fulfillment_location?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  def hub_to_customer?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    has_seller_fulfillment_location? and !has_buyer_pickup_location?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_seller_fulfillment_location?</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="85">
          <span class="hits">26</span>
          
          <code class="ruby">    seller_fulfillment_location_id != nil and seller_fulfillment_location_id != 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_buyer_pickup_location?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    buyer_pickup_location_id != nil and buyer_pickup_location_id != 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  def seller_fulfillment_address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    if (address = seller_fulfillment_location)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">      &quot;#{address.address}, #{address.city}, #{address.state} #{address.zip}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      &quot;Direct to customer&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  def weekday</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    seller_weekday</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">  def seller_weekday</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    WEEKDAYS[day]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">  def buyer_weekday</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    WEEKDAYS[buyer_day]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">  def next_delivery_date</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="113">
          <span class="hits">4</span>
          
          <code class="ruby">    @next_delivery_date ||= calc_next_delivery_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">  def next_buyer_delivery_date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">    @next_buyer_delivery_date ||= calc_next_buyer_delivery_date(next_delivery_date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">  def timezone</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="121">
          <span class="hits">2</span>
          
          <code class="ruby">    market.timezone || Time.zone</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">  def next_delivery</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">    delivery = find_next_delivery</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">    unless delivery</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">      delivery = deliveries.create!(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">        deliver_on: next_delivery_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        buyer_deliver_on: next_buyer_delivery_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">        cutoff_time: next_order_cutoff_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">    delivery</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">  def next_delivery_for_date(date)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    deliveries.create!(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      deliver_on: date.change(hour:17,min:0,sec:0),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      buyer_deliver_on: date.change(hour:6,min:0,sec:0),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      cutoff_time: date.change(hour:3,min:0,sec:0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_next_delivery</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">    deliveries.find_by(deliver_on: next_delivery_date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">  def next_order_cutoff_time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    next_delivery_date - order_cutoff.hours</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">  def free_delivery?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">    (fee_type == &quot;fixed&quot; &amp;&amp; fee == 0) || fee.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">  def required?(organization)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">    (require_delivery? &amp;&amp; organization.market_organizations.not_cross_selling.where(market_id: market_id).exists?) ||</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">    (require_cross_sell_delivery? &amp;&amp; organization.market_organizations.cross_selling.where(market_id: market_id).exists?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">  def fees_for_amount(amount)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">    case fee_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    when &quot;fixed&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      fee || 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    when &quot;percent&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">      amount * ((fee || 0) / 100)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">      0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">  def buyer_pickup_end_after_start</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">    validate_time_after(:buyer_pickup_end, buyer_pickup_end, buyer_pickup_start, &quot;must be after buyer pickup start&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="178">
          <span class="hits">1</span>
          
          <code class="ruby">  def seller_delivery_end_after_start</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="179">
          <span class="hits">5</span>
          
          <code class="ruby">    validate_time_after(:seller_delivery_end, seller_delivery_end, seller_delivery_start, &quot;must be after delivery start&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_time_after(field, before, after, message)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="183">
          <span class="hits">5</span>
          
          <code class="ruby">    errors.add(field, message) if before &amp;&amp; after &amp;&amp; Time.parse(before) &lt;= Time.parse(after)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">  def seller_day_and_buyer_day_are_same</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="187">
          <span class="hits">5</span>
          
          <code class="ruby">    if day != buyer_day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">      errors.add(:day, &quot;must match Day when fulfillment method is Direct to Customer&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_days_are_set</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="193">
          <span class="hits">5</span>
          
          <code class="ruby">    if day and buyer_day.nil?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="194">
          <span class="hits">2</span>
          
          <code class="ruby">      self.buyer_day = day</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="195">
          <span class="hits">3</span>
          
          <code class="ruby">    elsif buyer_day and day.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">      self.day = buyer_day</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">  # day, seller_delivery_start</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="201">
          <span class="hits">1</span>
          
          <code class="ruby">  def calc_next_delivery_date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">    Time.use_zone timezone do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">      current_time = Time.current.end_of_minute</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="204">
          <span class="hits">1</span>
          
          <code class="ruby">      beginning = current_time.beginning_of_week(:sunday) - 1.week</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="205">
          <span class="hits">1</span>
          
          <code class="ruby">      date = (beginning + day.days).to_date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="206">
          <span class="hits">1</span>
          
          <code class="ruby">      d = Time.zone.parse(&quot;#{date} #{seller_delivery_start}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">      d += 1.week while (d - self.order_cutoff.hours) &lt; current_time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">      return d</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="212">
          <span class="hits">1</span>
          
          <code class="ruby">  def calc_next_buyer_delivery_date(delivery_time)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="213">
          <span class="hits">1</span>
          
          <code class="ruby">    time_of_day = if buyer_pickup_start.present? and !direct_to_customer?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">                    buyer_pickup_start</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">                  else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">                    seller_delivery_start</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">                  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">    Time.use_zone timezone do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">      current_time = Time.current.end_of_minute</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">      beginning = current_time.beginning_of_week(:sunday) - 1.week</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">      date = (beginning + buyer_day.days).to_date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="222">
          <span class="hits">1</span>
          
          <code class="ruby">      d = Time.zone.parse(&quot;#{date} #{time_of_day}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">      d += 1.week while d &lt; delivery_time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">      return d</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a6a9309fc1b17fae353e7277f63ed6615ea18310">
  <div class="header">
    <h3>app/models/discount.rb</h3>
    <h4><span class="red">60.34 %</span> covered</h4>
    <div>
      <b>58</b> relevant lines. 
      <span class="green"><b>35</b> lines covered</span> and
      <span class="red"><b>23</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Discount &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include SoftDelete</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include Sortable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  self.inheritance_column = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :buyer_organization, class_name: &quot;Organization&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :seller_organization, class_name: &quot;Organization&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  enum payer: {market: 0, seller: 1}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  enum type: {percentage: 0, fixed: 1}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :code, presence: true, uniqueness: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :type, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :discount, numericality: {greater_than_or_equal_to: 0, less_than: 2_147_483_647}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :minimum_order_total, numericality: {greater_than_or_equal_to: 0, less_than: 2_147_483_647}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :maximum_order_total, numericality: {greater_than_or_equal_to: 0, less_than: 2_147_483_647}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :maximum_uses, numericality: {greater_than_or_equal_to: 0, less_than: 2_147_483_647}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :maximum_organization_uses, numericality: {greater_than_or_equal_to: 0, less_than: 2_147_483_647}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :starts_before_it_ends</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :future_end_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def value_for(subtotal)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    if percentage?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      (subtotal * (discount / 100)).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    elsif fixed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      [subtotal, discount].min</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      Honeybadger.notify(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        error_class:   &quot;Invalid Discount Code&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        error_message: &quot;Discount code has an unknown type&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">        parameters:    {discount_id: id}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  def active?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    time_now = Time.current.end_of_minute</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    (start_date.nil? || start_date &lt; time_now) &amp;&amp; (end_date.nil? || end_date &gt; time_now)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def valid_for_cart?(cart)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    can_use_in_market?(cart) &amp;&amp;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    can_use_for_buyer?(cart) &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    !less_than_minimum?(cart) &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    !more_than_maximum?(cart) &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    !maximum_uses_hit? &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    !maximum_organization_uses_hit?(cart)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_use_in_market?(cart)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    market_id.nil? || market_id == cart.market_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_use_for_buyer?(cart)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    buyer_organization_id.nil? || buyer_organization_id == cart.organization.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  def less_than_minimum?(cart)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    minimum_order_total &gt; 0 &amp;&amp; minimum_order_total &gt; cart.subtotal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def more_than_maximum?(cart)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    maximum_order_total &gt; 0 &amp;&amp; maximum_order_total &lt; cart.subtotal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  def maximum_uses_hit?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    maximum_uses &gt; 0 &amp;&amp; maximum_uses &lt;= total_uses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  def maximum_organization_uses_hit?(cart)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    maximum_organization_uses &gt; 0 &amp;&amp; maximum_organization_uses &lt;= uses_by_organization(cart.organization)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  def requires_seller_items?(cart)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    seller_organization_id.present? &amp;&amp; cart.items.joins(:product).where(products: {organization_id: seller_organization.id}).none?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  def total_uses</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    Order.where(discount_id: id).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">  def uses_by_organization(organization)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">    Order.where(organization_id: organization.id, discount_id: id).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">  def future_end_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    errors.add(:end_date, &quot;must be in the future&quot;) if end_date &amp;&amp; (!persisted? || end_date_changed?) &amp;&amp; end_date &lt; Time.current.end_of_minute</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  def starts_before_it_ends</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    if end_date.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      if start_date.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        errors.add(:end_date, &quot;must be after start date&quot;) if end_date &lt;= start_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        errors.add(:end_date, &quot;must have a start date&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6d078e7a5bde0cbd1ea4b5b4ab48237c6fcec632">
  <div class="header">
    <h3>app/models/external_product.rb</h3>
    <h4><span class="red">71.43 %</span> covered</h4>
    <div>
      <b>7</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ExternalProduct &lt; ActiveRecord::Base # should associate these with general products TODO</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">	serialize :source_data, JSON</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">	has_one :product # but the product has a general product id </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">	belongs_to :organization </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.contrive_key(fields)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    raise ArgumentError if fields.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    Digest::SHA1.base64digest(fields.join(&quot;--&quot;)).chomp(&quot;=&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="00a1d947a0b8110ffb78e707bbb265c5f9e83c99">
  <div class="header">
    <h3>app/models/fresh_sheet.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class FreshSheet &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="eb4679dffdf4e9ad78f374f74cdd60b5986aef32">
  <div class="header">
    <h3>app/models/general_product.rb</h3>
    <h4><span class="red">66.67 %</span> covered</h4>
    <div>
      <b>30</b> relevant lines. 
      <span class="green"><b>20</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class GeneralProduct &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  extend DragonflyBackgroundResize</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include SoftDelete</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include PgSearch</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :category</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :top_level_category, class: Category</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :second_level_category, class: Category</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :organization, inverse_of: :general_products</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :product</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :image</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :thumb</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  define_after_upload_resize(:image, 1200, 1200, thumb: {width: 150, height: 150})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_property :format, of: :image, in: %w(jpg jpeg png gif)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_property :format, of: :thumb, in: %w(jpg jpeg png gif)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  pg_search_scope :search_by_text,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">                  :against =&gt; :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">                  :associated_against =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">                      :second_level_category =&gt; :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">                      :organization =&gt; :name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">                  },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">                  :using =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">                      :tsearch =&gt; {prefix: true}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">                  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.filter_by_name_or_category_or_supplier(name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    if name &amp;&amp; name.length &gt; 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      where(&quot;upper(general_products.name) LIKE ? OR upper(top_level_category.name) LIKE ? OR upper(second_level_category.name) LIKE ? OR upper(supplier.name) LIKE ?&quot;, &quot;%#{name.upcase}%&quot;, &quot;%#{name.upcase}%&quot;, &quot;%#{name.upcase}%&quot;, &quot;%#{name.upcase}%&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      #search_by_text(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">       all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.filter_by_categories(category_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    if category_ids &amp;&amp; category_ids.length &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      where(&quot;(general_products.category_id IN (?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">              OR general_products.top_level_category_id IN (?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">              OR general_products.second_level_category_id in (?))&quot;, category_ids, category_ids, category_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.filter_by_suppliers(supplier_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    if supplier_ids &amp;&amp; supplier_ids.length &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      where(organization: supplier_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.filter_by_active_org</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    where(&quot;supplier.active = &#39;true&#39; AND market_organizations.deleted_at IS NULL&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7d7018abd3ff9d4285ac176bdf07d656aafd432f">
  <div class="header">
    <h3>app/models/location.rb</h3>
    <h4><span class="red">56.25 %</span> covered</h4>
    <div>
      <b>32</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Location &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true, associated_with: :organization</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include SoftDelete</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :organization, inverse_of: :locations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :address, :city, :state, :zip, :organization, :country, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :default_billing,  uniqueness: {scope: [:organization_id, :deleted_at]}, if: &quot;!!default_billing&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :default_shipping, uniqueness: {scope: [:organization_id, :deleted_at]}, if: &quot;!!default_shipping&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  before_create :set_defaults_if_necessary</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :ensure_default_address_label</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  after_update :set_new_defaults</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_geocodable address: {street: :address, locality: :city, region: :state, postal_code: :zip, country: :country}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.alphabetical_by_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    order(name: :asc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.default_billing</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    find_by(default_billing: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.default_shipping</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    find_by(default_shipping: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_default_address_label</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">   if (not self.name) || self.name == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      self.name = &quot;Default Address&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_defaults_if_necessary</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    if !Location.visible.where(organization_id: organization_id).exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      self.default_shipping = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      self.default_billing = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_new_defaults</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    return true if deleted_at.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    return true unless default_billing || default_shipping</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    loc = Location.visible.where(organization_id: organization_id).order(:id).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    loc.update_attribute(:default_billing, true)  if loc &amp;&amp; default_billing</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    loc.update_attribute(:default_shipping, true) if loc &amp;&amp; default_shipping</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="d0d22f73dc8a03ec724e778c01cc99d70c04f5a4">
  <div class="header">
    <h3>app/models/lot.rb</h3>
    <h4><span class="red">70.37 %</span> covered</h4>
    <div>
      <b>27</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Lot &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true, associated_with: :product</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :product, inverse_of: :lots</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :quantity, numericality: {greater_than_or_equal_to: 0, less_than: 1_000_000}</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="7">
          <span class="hits">10</span>
          
          <code class="ruby">  validates :number, presence: {message: &quot;can&#39;t be blank when &#39;Expiration Date&#39; is present&quot;}, if: lambda {|obj| obj.expires_at.present? }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :number, uniqueness: {scope: :product_id, allow_blank: true}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :expires_at_is_in_future</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :good_from_before_expires_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :available, lambda { |time=Time.current.end_of_minute|</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="13">
          <span class="hits">8</span>
          
          <code class="ruby">    where(&quot;(lots.good_from IS NULL OR lots.good_from &lt; :time) AND (lots.expires_at IS NULL OR lots.expires_at &gt; :time) AND quantity &gt; 0&quot;, time: time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # This ransacker method exposes the functionality of available? and available_quantity to </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # the product search filters, as those model method calls are inaccessible in that context</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  ransacker :sellable_quantity do |parent|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # Sellable quantity is a function of three fields:</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    Arel.sql(&lt;&lt;-SQL</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      CASE WHEN (</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        -- The actual count...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        quantity &gt; 0 AND </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        -- ...and the two product viability dates</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        (expires_at IS NULL OR expires_at &gt; CURRENT_DATE) AND</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        ( good_from IS NULL OR  good_from &lt; CURRENT_DATE)) </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      -- If the criteria pass, then return the quantity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      THEN quantity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      -- Otherwise return zero</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      ELSE 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      END</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    SQL</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def available?(time=Time.current.end_of_minute)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    (expires_at.nil? || expires_at &gt; time) &amp;&amp; (good_from.nil? || good_from &lt; time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def available_quantity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    available? ? quantity : 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def simple?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    number.nil? &amp;&amp; good_from.nil? &amp;&amp; expires_at.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def expires_at_is_in_future</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="54">
          <span class="hits">9</span>
          
          <code class="ruby">    return if expires_at.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    if persisted?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      errors.add(:expires_at, &quot;must be after #{created_at.strftime(&quot;%m/%d/%Y&quot;)}&quot;) if expires_at &lt;= created_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      errors.add(:expires_at, &quot;must be in the future&quot;) if expires_at.past?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  def good_from_before_expires_at</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="64">
          <span class="hits">9</span>
          
          <code class="ruby">    if good_from &amp;&amp; expires_at &amp;&amp; good_from &gt; expires_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      errors.add(:good_from, &quot;cannot be after expires at date&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="9c87cf54a46084f347a52462903219622dfb478d">
  <div class="header">
    <h3>app/models/managed_market.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ManagedMarket &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="bdb2384df877367fa7ccd308a595fe278b273f65">
  <div class="header">
    <h3>app/models/market.rb</h3>
    <h4><span class="red">57.53 %</span> covered</h4>
    <div>
      <b>146</b> relevant lines. 
      <span class="green"><b>84</b> lines covered</span> and
      <span class="red"><b>62</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Market &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :stripe_tok</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_update :process_cross_sells_change, if: :allow_cross_sell_changed?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before_update :process_plan_change, if: :plan_id_changed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  extend DragonflyBackgroundResize</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  include Sortable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  include Util::TrimText</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  include PgSearch</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  paginates_per 50</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  trimmed_fields :contact_email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, :subdomain, presence: true, uniqueness: true, length: {maximum: 255, allow_blank: true}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :subdomain, exclusion: {in: %w(app www mail ftp smtp imap docs calendar community knowledge service support)}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :tagline, length: {maximum: 255, allow_blank: true}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :local_orbit_seller_fee, :local_orbit_market_fee, :market_seller_fee, :credit_card_seller_fee, :credit_card_market_fee, :ach_seller_fee, :ach_market_fee, presence: true, numericality: {greater_than_or_equal_to: 0, less_than: 100, allow_blank: true}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :ach_fee_cap, presence: true, numericality: {greater_than_or_equal_to: 0, less_than: 10_000, allow_blank: true}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :contact_name, :contact_email, :country, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :po_payment_term, presence: true, numericality: {greater_than_or_equal_to: 0, less_than: 366}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :require_payment_method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :managed_markets</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :managers, through: :managed_markets, source: :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :market_cross_sells, class_name: &quot;MarketCrossSells&quot;, foreign_key: :source_market_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :cross_sells, through: :market_cross_sells</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :market_organizations</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="34">
          <span class="hits">16</span>
          
          <code class="ruby">  has_many :organizations, -&gt; { extending(MarketOrganization::AssociationScopes).excluding_deleted }, through: :market_organizations # XXX prefer the merge in the line below to this partially and incorrectly implemened .excluding_deleted scope?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  # TODO has_many :organizations, -&gt; { merge(MarketOrganization.visible) }, through: :market_organizations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :addresses, class_name: MarketAddress</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :delivery_schedules, inverse_of: :market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :newsletters</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :promotions, inverse_of: :market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :order_templates</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :plan, inverse_of: :markets</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :plan_bank_account, class_name: &quot;BankAccount&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :bank_accounts, as: :bankable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  serialize :twitter, TwitterUser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :logo</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :photo</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  define_after_upload_resize(:logo, 1200, 1200)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  define_after_upload_resize(:photo, 1800, 1800)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_property :format, of: :logo,  in: %w(jpg jpeg png gif)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_property :format, of: :photo, in: %w(jpg jpeg png gif)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :sort, method: :for_sort, ignore_blank: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :search, method: :for_search, ignore_blank: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  pg_search_scope :search_by_name, against: :name, using: {tsearch: {prefix: true}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :active, -&gt; { where(active: true) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :managed_by, lambda { |user|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="64">
          <span class="hits">4</span>
          
          <code class="ruby">    if user.admin?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="65">
          <span class="hits">4</span>
          
          <code class="ruby">      all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      where(id: user.managed_markets.pluck(:id))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_search(query)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    search_by_name(query)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.possible_countries</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="76">
          <span class="hits">5</span>
          
          <code class="ruby">    [[&#39;United States&#39;, &#39;US&#39;], [&#39;Canada&#39;, &#39;CA&#39;]]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.arel_column_for_sort(column_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    case column_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    when &quot;contact&quot;   then arel_table[:contact_name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    when &quot;subdomain&quot; then arel_table[:subdomain]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      arel_table[:name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_order_items(order_items)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    joins(:orders).where(orders: {id: order_items.map(&amp;:order_id)}).uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  # Called as the last in a scope chain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.sort_service_payment</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    all.sort do |a,b|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      if a.next_service_payment_at &amp;&amp; b.next_service_payment_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        a.next_service_payment_at &lt;=&gt; b.next_service_payment_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">      elsif a.next_service_payment_at.nil? &amp;&amp; b.next_service_payment_at.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        a.name.downcase &lt;=&gt; b.name.downcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      elsif a.next_service_payment_at.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        -1 # Means order is wrong</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        1 # Means order is correct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">  # NOTE: We&#39;re transitioning from per-market payment fee config to provider-based payment structures.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  # We still need to indicate whether Market or Seller must pay, so for now we&#39;re re-using the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  # existing numeric fee fields to determine who&#39;s paying.  TODO: cleanup and remodel the markets table</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  # to better represent what&#39;s actually going on.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">  def credit_card_payment_fee_payer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    credit_card_market_fee != 0 ? &#39;market&#39; : &#39;seller&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_credit_card_payment_fee_payer(payer_string)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">    payment_fees = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      credit_card_market_fee: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      credit_card_seller_fee: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      ach_market_fee: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      ach_seller_fee: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">    if payer_string == &#39;market&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      payment_fees[:credit_card_market_fee] = 1 # amount is irrelevant; this just needs to be non-zero</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      payment_fees[:credit_card_seller_fee] = 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    self.update(payment_fees)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">  def balanced_customer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    Balanced::Customer.find(balanced_customer_uri)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">  def stripe_customer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    Stripe::Customer.retrieve(stripe_customer_id) if stripe_customer_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">  def stripe_account</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    Stripe::Account.retrieve(stripe_account_id) if stripe_account_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">  def fulfillment_locations(default_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">    addresses.visible.order(:name).map {|a| [a.name, a.id] }.unshift([default_name, 0])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">  def domain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">    &quot;#{subdomain}.#{Figaro.env.domain!}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">  def seller_net_percent</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">    subtract_amt = (local_orbit_seller_fee + market_seller_fee)/100 # These fees come as rates, numbers 100x bigger and need to be converted to percents</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">    cc_rate = PaymentProvider.approximate_credit_card_rate(payment_provider)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">    if credit_card_payment_fee_payer == &#39;seller&#39; and allow_credit_cards?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">      subtract_amt += BigDecimal(cc_rate)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">    (BigDecimal(1) - subtract_amt)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  # LO&#39;s % take as a true decimal: eg, if local_orbit_seller_fee = 2.0 and local_orbit_market_fee  = 1.0 then this method returns 0.03 as a BigDecimal</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">  def local_orbit_seller_and_market_fee_fraction</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    (local_orbit_seller_fee + local_orbit_market_fee) / 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">  def products</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">    Product.where(organization_id: organizations.pluck(:id))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">  def deliveries</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">    Delivery.for_market(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="177">
          <span class="hits">1</span>
          
          <code class="ruby">  def next_delivery</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">    delivery_schedules.visible.map(&amp;:next_delivery).min {|a, b| a.deliver_on &lt;=&gt; b.deliver_on }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">  def only_delivery</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">    schedules = delivery_schedules.visible.to_a</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">    schedules.first.next_delivery if schedules.size == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">  def upcoming_deliveries_for_user(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    scope = deliveries.future.with_undelivered_orders.order(&quot;deliver_on&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">    scope = scope.with_undelivered_orders_for_user(user) unless user.market_manager? || user.admin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">    scope</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">  def featured_promotion(buyer)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">    promotion = promotions.active.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">    product = promotion.try(:product)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">    if product.present? &amp;&amp; product.available_inventory &gt; 0 &amp;&amp; product.prices_for_market_and_organization(self, buyer).any?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">      promotion</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">  def close!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">    update!(closed: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">  def open!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">    update!(closed: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">  def next_service_payment_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">    return nil unless plan_start_at &amp;&amp; plan_interval</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">    return plan_start_at if plan_start_at &gt; Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">    @next_service_payment_at ||= begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">      plan_payments = Payment.successful.not_refunded.made_after(plan_start_at).where(payer: self, payment_type: &quot;service&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">      (plan_interval * plan_payments.count).months.from_now(plan_start_at)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">  def last_service_payment_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">    Payment.successful.not_refunded.where(payer: self, payment_type: &quot;service&quot;).order(&quot;created_at DESC&quot;).first.try(:created_at)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">  def plan_payable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">    plan_fee &amp;&amp; plan_fee &gt; 0 &amp;&amp; plan_bank_account.try(:usable_for?, :debit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="229">
          <span class="hits">1</span>
          
          <code class="ruby">  def on_statement_as</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">    name.sub(/[^0-9a-zA-Z\.\-_ \^\`\|]/, &#39;&#39;)[0, 22]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">  def primary_payment_provider</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">    self.payment_provider</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">  def deposit_account</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">    self.bank_accounts.visible.deposit_accounts.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="243">
          <span class="hits">1</span>
          
          <code class="ruby">  def require_payment_method</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="244">
          <span class="hits">17</span>
          
          <code class="ruby">    unless allow_purchase_orders? || allow_credit_cards? || allow_ach?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">      errors.add(:payment_method, &quot;At least one payment method is required for the market&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">  def process_cross_sells_change</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">    remove_cross_selling_from_market unless allow_cross_sell?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">  def process_plan_change</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">    remove_cross_selling_from_market unless plan.cross_selling</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">    products.each {|p| p.disable_advanced_inventory(self) } unless plan.advanced_inventory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_cross_selling_from_market</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">    update_column(:allow_cross_sell, false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">    MarketOrganization.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">      where(cross_sell_origin_market_id: id).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">      each(&amp;:soft_delete)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">    MarketOrganization.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">      where.not(cross_sell_origin_market_id: nil).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">      where(market_id: id).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">      each(&amp;:soft_delete)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">    MarketCrossSells.where(source_market_id: id).destroy_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="adfd9c51a7a2491e54cbcc4cdeb7856ab81846b1">
  <div class="header">
    <h3>app/models/market_address.rb</h3>
    <h4><span class="red">56.41 %</span> covered</h4>
    <div>
      <b>39</b> relevant lines. 
      <span class="green"><b>22</b> lines covered</span> and
      <span class="red"><b>17</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class MarketAddress &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true, associated_with: :market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include SoftDelete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market, inverse_of: :addresses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :address, :city, :state, :zip, :market, :country, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_geocodable address: {street: :address, locality: :city, region: :state, postal_code: :zip, country: :country}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :ensure_single_default</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :ensure_single_billing</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :ensure_single_remit_to</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :ensure_default_address_label</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.alphabetical_by_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    order(name: :asc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_default_address_label</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="21">
          <span class="hits">12</span>
          
          <code class="ruby">  	if (not self.name) || self.name == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      self.name = &quot;Default Address&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # Helper methods for before_save-s to ensure a single default/billing address per market.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def falsify_all_others_default(mkt_addr_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    MarketAddress.where( default:true ).where(market_id:&quot;#{mkt_addr_id}&quot;.to_i).each do |ma|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      if ma.id != self.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        ma.default = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        ma.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def falsify_all_others_billing(mkt_addr_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    MarketAddress.where( billing:true ).where(market_id:&quot;#{mkt_addr_id}&quot;.to_i).each do |ma| </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      if ma.id != self.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        ma.billing = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        ma.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  def falsify_all_others_remit_to(mkt_addr_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    MarketAddress.where( remit_to:true ).where(market_id:&quot;#{mkt_addr_id}&quot;.to_i).each do |ma|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      if ma.id != self.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">        ma.remit_to = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        ma.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_single_default</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="55">
          <span class="hits">12</span>
          
          <code class="ruby">    if self.default # if the about to be saved market address is default</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      falsify_all_others_default(self.market_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_single_billing</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="61">
          <span class="hits">12</span>
          
          <code class="ruby">    if self.billing </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      falsify_all_others_billing(self.market_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_single_remit_to</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="67">
          <span class="hits">12</span>
          
          <code class="ruby">    if self.remit_to</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      falsify_all_others_remit_to(self.market_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="59997c0af36745d874a2774b9d76046e397079c2">
  <div class="header">
    <h3>app/models/market_cross_sells.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class MarketCrossSells &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market, class_name: &quot;Market&quot;, foreign_key: :source_market_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :cross_sell, class_name: &quot;Market&quot;, foreign_key: :destination_market_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f2e93fcdda5bd3811037fc42d61653e2a3b1bd44">
  <div class="header">
    <h3>app/models/market_organization.rb</h3>
    <h4><span class="yellow">90.0 %</span> covered</h4>
    <div>
      <b>20</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class MarketOrganization &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module AssociationScopes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    def including_deleted</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      unscope(market_organizations: :deleted_at)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    def excluding_deleted</code>
        </li>
      
        <li class="covered" data-hits="127" data-linenumber="10">
          <span class="hits">127</span>
          
          <code class="ruby">      where(market_organizations: {deleted_at: nil})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    def not_cross_selling</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="14">
          <span class="hits">87</span>
          
          <code class="ruby">      where(market_organizations: {cross_sell_origin_market_id: nil})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    def cross_selling</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      where.not(market_organizations: {cross_sell_origin_market_id: nil})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    def mo_join_market_id(market_id)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="22">
          <span class="hits">16</span>
          
          <code class="ruby">      where(market_organizations: {market_id: market_id})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  include SoftDelete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :organization</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :cross_sell_origin_market, class_name: :Market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :cross_selling,     -&gt; { where.not(cross_sell_origin_market_id: nil) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_cross_selling, -&gt; { where(cross_sell_origin_market_id: nil) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :excluding_deleted, -&gt; { where(deleted_at: nil) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="64c68558034ccf6b504f831069f89a71ad835622">
  <div class="header">
    <h3>app/models/metric.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Metric &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6569bd35eb2e41aea5ada6ce0bb0ea39ce10e0f4">
  <div class="header">
    <h3>app/models/newsletter.rb</h3>
    <h4><span class="red">41.18 %</span> covered</h4>
    <div>
      <b>17</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Newsletter &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true, associated_with: :market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :subject, :header, :body, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :image</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_property :format, of: :image,  in: %w(jpeg png gif)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def recipients</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    newsletter_type = SubscriptionType::Keywords::Newsletter</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    subscribers = User.in_market(market).subscribed_to(newsletter_type).includes(:subscriptions)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    recipients = Set.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    if buyers?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      recipients += subscribers.buyers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    if sellers?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      recipients += subscribers.sellers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    if market_managers?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      recipients += market.managers.subscribed_to(newsletter_type).includes(:subscriptions)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    recipients</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="04d65295c1d339b6637b4f0f8c1cd4f3a4719179">
  <div class="header">
    <h3>app/models/order.rb</h3>
    <h4><span class="red">56.84 %</span> covered</h4>
    <div>
      <b>234</b> relevant lines. 
      <span class="green"><b>133</b> lines covered</span> and
      <span class="red"><b>101</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Order &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include SoftDelete</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include DeliveryStatus</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include Sortable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  INVOICE_STATUSES = %w(due overdue).freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  paginates_per 50</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_paid_at</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_payment_status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :cache_delivery_status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  before_update :update_order_item_payment_status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  before_update :update_total_cost</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  has_associated_audits</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :invoice_pdf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :credit_card, :bank_account</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market, inverse_of: :orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :organization, inverse_of: :orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :delivery, inverse_of: :orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :placed_by, class: User</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :discount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :items, inverse_of: :order, class: OrderItem, autosave: true, dependent: :destroy do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    def for_checkout</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      eager_load(product: [:organization, :prices]).order(&quot;organizations.name, products.name&quot;).group_by do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        item.product.organization.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :order_payments, inverse_of: :order</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :payments, through: :order_payments, inverse_of: :orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :products, through: :items</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :sellers, through: :products, class_name: Organization</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :delivery_notes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :credit, -&gt; {visible}, autosave: false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :billing_address, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :billing_city, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :billing_organization_name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :billing_state, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :billing_zip, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :delivery_address, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :delivery_city, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :delivery_fees, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :delivery_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :delivery_state, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :delivery_zip, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :market_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :order_number, presence: true, uniqueness: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :organization_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :payment_method, presence: true, inclusion: {in: Payment::PAYMENT_METHODS.keys, allow_blank: true}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :payment_status, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :placed_at, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :total_cost, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :recent, -&gt; { visible.order(&quot;created_at DESC&quot;).limit(15) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :upcoming_delivery, -&gt; { visible.joins(:delivery).where(&quot;deliveries.deliver_on &gt; ?&quot;, Time.current.end_of_minute) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :upcoming_buyer_delivery, -&gt; { visible.joins(:delivery).where(&quot;deliveries.buyer_deliver_on &gt; ?&quot;, Time.current.end_of_minute) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :uninvoiced, -&gt; { visible.purchase_orders.where(invoiced_at: nil) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :invoiced, -&gt; { visible.purchase_orders.where.not(invoiced_at: nil) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :unpaid, -&gt; { visible.where(payment_status: &quot;unpaid&quot;) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :paid, -&gt; { visible.where(payment_status: &quot;paid&quot;) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :delivered, -&gt; { visible.where(&quot;order_items.delivery_status = ?&quot;, &quot;delivered&quot;).group(&quot;orders.id&quot;) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :undelivered, -&gt; { visible.where(&quot;order_items.delivery_status = ?&quot;, &quot;pending&quot;).group(&quot;orders.id&quot;) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :paid_with, lambda {|method| visible.where(payment_method: method) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :purchase_orders, -&gt; { where(payment_method: &quot;purchase order&quot;) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :payment_overdue, -&gt; { unpaid.where(&quot;invoice_due_date &lt; ?&quot;, (Time.current - 1.day).end_of_day) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :payment_due, -&gt; { unpaid.where(&quot;invoice_due_date &gt;= ?&quot;, (Time.current - 1.day).end_of_day) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :paid_between, lambda {|range| paid.where(paid_at: range) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :due_between, lambda {|range| invoiced.where(invoice_due_date: range) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :clean_payment_records, -&gt; { where(arel_table[:placed_at].gt(Time.parse(&quot;2014-01-01&quot;))) }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="81">
          <span class="hits">2</span>
          
          <code class="ruby">  scope :for_seller, -&gt; (user) { orders_for_seller(user) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :on_automate_plan, -&gt; { joins(market: :plan).where(plans: {name: &#39;Automate&#39;}) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_on_automate_plan, -&gt; { joins(market: :plan).where.not(plans: {name: &#39;Automate&#39;}) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :balanced,     -&gt; { where(payment_provider: PaymentProvider::Balanced.id.to_s) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_balanced, -&gt; { where.not(payment_provider: PaymentProvider::Balanced.id.to_s) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :stripe,       -&gt; { where(payment_provider: PaymentProvider::Stripe.id.to_s) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_stripe,   -&gt; { where.not(payment_provider: PaymentProvider::Stripe.id.to_s) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :placed_between, lambda {|range| visible.where(placed_at: range) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :sort, method: :for_sort, ignore_blank: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :payment_status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :items, allow_destroy: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.delivered_between(range)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    delivered.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      having(&quot;MAX(order_items.delivered_at) &gt;= ?&quot;, range.begin).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      having(&quot;MAX(order_items.delivered_at) &lt; ?&quot;, range.end)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.fully_delivered</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    joins(:items).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      having(&quot;BOOL_AND(order_items.delivery_status IN (?)) AND BOOL_OR(order_items.delivery_status = ?)&quot;, [&quot;delivered&quot;, &quot;canceled&quot;], &quot;delivered&quot;).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">      group(&quot;orders.id&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.not_paid_for(payment_type, type=:payee)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">    where.not(id: OrderPayment.market_paid_orders_subselect(payment_type, type))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.payable(current_time:nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    # This is a slightly fuzzy match right now.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    # TODO: Implement delivery_end on deliveries for greater accuracy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">    buyer_deliver_on = Delivery.arel_table[:buyer_deliver_on]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    joins(:delivery).where(buyer_deliver_on.not_eq(nil))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.payment_status(status)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    case status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    when &quot;overdue&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">      payment_overdue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    when &quot;due&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      payment_due</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    when &quot;uninvoiced&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      uninvoiced</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">      all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.used_lo_payment_processing</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    where(payment_method: [&quot;credit card&quot;, &quot;ach&quot;, &quot;paypal&quot;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.balanced_payable_to_market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    balanced.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      paid.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      fully_delivered.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      used_lo_payment_processing.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      not_paid_for(&quot;market payment&quot;).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">      without_payments_made_to_sellers.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      clean_payment_records.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      not_on_automate_plan.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      preload(:items, :market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.payments_to_sellers_subselect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">    %|SELECT 1 FROM payments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">      INNER JOIN order_payments ON order_payments.order_id = orders.id AND order_payments.payment_id = payments.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      WHERE payments.payee_type = &#39;Organization&#39; AND payments.payee_id = products.organization_id|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.with_payments_made_to_sellers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">    joins(items: :product).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">    where(&quot;EXISTS(#{payments_to_sellers_subselect})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.without_payments_made_to_sellers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    joins(items: :product).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">    where(&quot;NOT EXISTS(#{payments_to_sellers_subselect})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.payable_to_sellers(current_time:Time.current.end_of_minute, seller_organization_id:nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    res = select(&quot;orders.*, products.organization_id as seller_id&quot;).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      fully_delivered.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">      payable(current_time: current_time).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">      without_payments_made_to_sellers.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      group(&quot;seller_id&quot;).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      order(:order_number).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">      includes(:market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">    if seller_organization_id.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      res = res.where(products: { organization_id: seller_organization_id })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">    res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.payable_to_automate_sellers(current_time:Time.current.end_of_minute, seller_organization_id:nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">    balanced.payable_to_sellers(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      current_time: current_time,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">      seller_organization_id: seller_organization_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">    ).not_paid_for(&quot;market payment&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.payable_lo_fees</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">    balanced.fully_delivered.purchase_orders.payable.not_paid_for(&quot;lo fee&quot;, :payer)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">  # Scope: For Markets on Automate plan, get all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">  # Orders with payable market fees.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">  # Options:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">  #   current_time: Delivery must be earlier than 48 hrs before this time.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">  #                 Default: Time.current.end_of_minute</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">  #   market_id: If present, narrow the results based on one or more Market ids.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">  #              Default: nil (include all Markets on Automate)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">  #   order_id: If present, narrow the results to one or more specific Order ids.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">  #             Default: nil (nil all matching orders).</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.payable_market_fees(current_time: Time.current.end_of_minute, market_id: nil, order_id: nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">    res = balanced.clean_payment_records.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">      on_automate_plan.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">      fully_delivered.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">      used_lo_payment_processing.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">      payable(current_time: current_time).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">      not_paid_for(&quot;hub fee&quot;).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      not_paid_for(&quot;market payment&quot;).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">      order(:order_number)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">    if market_id.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">      res = res.where(market_id: market_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">    if order_id.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">      res = res.where(id: order_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">    res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.arel_column_for_sort(column_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">    case column_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">    when &quot;owed&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">      # FIXME: need to sort by amount owed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">      arel_table[:id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">    when &quot;date&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">      arel_table[:placed_at]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">    when &quot;buyer&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">      arel_table[:payment_status]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">    when &quot;seller&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">      # FIXME: need to sort by the seller paid status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">      arel_table[:id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">    when &quot;delivery_status&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      # FIXME: need to sort by order-wide delivery status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">      arel_table[:id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">      arel_table[:order_number]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">  # def self.filter_by_user_markets(user, orders)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">  #   result = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">  #   orders.each do |o|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">  #     if user.markets.include?(o.market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">  #       result &lt;&lt; o</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">  #     end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">  #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">  #   result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.orders_for_buyer(user)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="254">
          <span class="hits">3</span>
          
          <code class="ruby">    if user.admin?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="255">
          <span class="hits">3</span>
          
          <code class="ruby">      all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">      where(buyer_orders_arel(user).or(manager_orders_arel(user))).uniq.where(market_id: user.markets)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="261">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.orders_for_seller(user)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="262">
          <span class="hits">2</span>
          
          <code class="ruby">    if user.admin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">      all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="265">
          <span class="hits">2</span>
          
          <code class="ruby">      joins(:products).where(seller_orders_arel(user).or(manager_orders_arel(user))).uniq.where(market_id: user.markets)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="269">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.undelivered_orders_for_seller(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">    scope = orders_for_seller(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">    scope = scope.joins(:order_items) if user.admin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">    scope.where(order_items: {delivery_status: &quot;pending&quot;})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="275">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.buyer_orders_arel(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">    arel_table[:organization_id].in(UserOrganization.where(user_id: user.id).select(:organization_id).arel)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="279">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.seller_orders_arel(user)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="280">
          <span class="hits">2</span>
          
          <code class="ruby">    Product.arel_table[:organization_id].in(UserOrganization.where(user_id: user.id).select(:organization_id).arel)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="283">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.manager_orders_arel(user)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="284">
          <span class="hits">2</span>
          
          <code class="ruby">    arel_table[:market_id].in(ManagedMarket.where(user_id: user.id).select(:market_id).arel)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">  # def self.add_notes_reference(notes_arr) # TODO check aeren</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">  #   #org = current_organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">  #   #binding.pry</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">  #   self.delivery_notes = notes_arr.select{|n| n if n.supplier_org == current_organization.id}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">  # def delivery_notes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">  #   self.delivery_notes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="297">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_cart_items(cart_items, deliver_on)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">    cart_items.each do |cart_item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">      add_cart_item(cart_item, deliver_on)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="303">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_cart_item(cart_item, deliver_on)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">    items &lt;&lt; OrderItem.create_with_order_and_item_and_deliver_on_date(self, cart_item, deliver_on)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="307">
          <span class="hits">1</span>
          
          <code class="ruby">  def delivered_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">    items.maximum(:delivered_at) if self.delivered?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="311">
          <span class="hits">1</span>
          
          <code class="ruby">  def discount_code</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">    discount.try(:code)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="315">
          <span class="hits">1</span>
          
          <code class="ruby">  def discount_amount</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">    @discount_amount ||= items.sum(:discount_market) + items.sum(:discount_seller)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="319">
          <span class="hits">1</span>
          
          <code class="ruby">  def invoice</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">    self.invoiced_at      = Time.current</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">    self.invoice_due_date = market.po_payment_term.days.from_now(invoiced_at)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="324">
          <span class="hits">1</span>
          
          <code class="ruby">  def invoiced?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">    invoiced_at.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="328">
          <span class="hits">1</span>
          
          <code class="ruby">  def paid_seller_ids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">    @paid_seller_ids ||= payments.seller_payments.pluck(:payee_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="332">
          <span class="hits">1</span>
          
          <code class="ruby">  def sellers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">    items.map(&amp;:seller).uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="336">
          <span class="hits">1</span>
          
          <code class="ruby">  def sellers_with_changes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">    uuid = audits.last.try(:request_uuid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">    sellers = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">    if uuid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">      Audit.where(request_uuid: uuid, auditable_type: &quot;OrderItem&quot;).map do |audit|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="342">
          
          
          <code class="ruby">        if audit.audited_changes[&quot;quantity&quot;] &amp;&amp; audit.audited_changes[&quot;quantity&quot;].second &gt;0 &amp;&amp; audit.action != &quot;destroy&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">          # If auditable is there, use the seller, or else find it from the product in the changes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">          sellers &lt;&lt; audit.try(:auditable).try(:seller) || Product.find_by(id: audit.audited_changes[&quot;product_id&quot;]).try(:organization)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">    sellers.compact.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="351">
          <span class="hits">1</span>
          
          <code class="ruby">  def sellers_with_cancel</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">    uuid = audits.last.try(:request_uuid)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">    sellers = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">    if uuid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">      Audit.where(request_uuid: uuid, auditable_type: &quot;OrderItem&quot;).map do |audit|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">        if (audit.audited_changes[&quot;quantity&quot;] &amp;&amp; audit.audited_changes[&quot;quantity&quot;].second == 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">          # If auditable is there, use the seller, or else find it from the product in the changes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="359">
          
          
          <code class="ruby">          sellers &lt;&lt; audit.try(:auditable).try(:seller) || Product.find_by(id: audit.audited_changes[&quot;product_id&quot;]).try(:organization)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">    sellers.compact.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="366">
          <span class="hits">1</span>
          
          <code class="ruby">  def subtotal</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">    @subtotal ||= items.each.sum(&amp;:gross_total)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">  # Market payable calculations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="372">
          <span class="hits">1</span>
          
          <code class="ruby">  def payable_to_market</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">    @payable_to_market ||= payable_subtotal - market_payable_local_orbit_fee - market_payable_payment_fee - items.sum(:discount_market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="376">
          <span class="hits">1</span>
          
          <code class="ruby">  def payable_subtotal</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">    @payable_subtotal ||= delivery_fees + items.delivered.each.sum(&amp;:gross_total)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="380">
          <span class="hits">1</span>
          
          <code class="ruby">  def payable_lo_fees</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">    delivery_fees * (market.local_orbit_seller_fee + market.local_orbit_market_fee) / 100 +</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">      items.each.sum {|i| i.local_orbit_seller_fee + i.local_orbit_market_fee }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="385">
          <span class="hits">1</span>
          
          <code class="ruby">  def market_payable_market_fee</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">    @market_payable_market_fee ||= items.delivered.sum(:market_seller_fee)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="389">
          <span class="hits">1</span>
          
          <code class="ruby">  def market_payable_local_orbit_fee</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">    @market_payable_local_orbit_fee ||= items.delivered.sum(&quot;local_orbit_seller_fee + local_orbit_market_fee&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="393">
          <span class="hits">1</span>
          
          <code class="ruby">  def market_payable_payment_fee</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">    @market_payable_payment_fee ||= items.delivered.sum(&quot;payment_seller_fee + payment_market_fee&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="397">
          <span class="hits">1</span>
          
          <code class="ruby">  def apply_delivery_address(address)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">    self.delivery_address = address.address</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">    self.delivery_city    = address.city</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">    self.delivery_state   = address.state</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">    self.delivery_zip     = address.zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">    self.delivery_phone   = address.phone</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="405">
          <span class="hits">1</span>
          
          <code class="ruby">  def usable_items</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">    items.reject {|i| i.destroyed? || i.marked_for_destruction? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="409">
          <span class="hits">1</span>
          
          <code class="ruby">  def gross_total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">    # binding.pry</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">    usable_items.sum(&amp;:gross_total)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="414">
          <span class="hits">1</span>
          
          <code class="ruby">  def credit_amount</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="415">
          
          
          <code class="ruby">    if credit &amp;&amp; credit.valid?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="416">
          
          
          <code class="ruby">      credit.calculated_amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">      0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="422">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_localeyes_order?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">    market.plan.has_procurement_managers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="426">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_total_cost</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="427">
          
          
          <code class="ruby">    cost = gross_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">    if credit &amp;&amp; credit.apply_to == &quot;subtotal&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">      cost = gross_total - credit_amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">    self.delivery_fees = calculate_delivery_fees(cost).round(2) unless delivery_fees == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">    self.total_cost    = calculate_total_cost(cost).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="435">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="437">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_paid_at</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="438">
          <span class="hits">3</span>
          
          <code class="ruby">    self.paid_at ||= Time.current if payment_status == &quot;paid&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="441">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_payment_status</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="442">
          <span class="hits">3</span>
          
          <code class="ruby">    statuses = items.map(&amp;:payment_status).uniq</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="443">
          <span class="hits">3</span>
          
          <code class="ruby">    self.payment_status = &quot;refunded&quot; if statuses == [&quot;refunded&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="446">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_order_item_payment_status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby">    return unless payment_status_changed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">    items.where(payment_status: [&quot;pending&quot;, &quot;unpaid&quot;]).update_all(payment_status: payment_status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="450">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="451">
          <span class="hits">1</span>
          
          <code class="ruby">  def calculate_delivery_fees(gross)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="452">
          
          
          <code class="ruby">    if gross &gt; 0.0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="453">
          
          
          <code class="ruby">      delivery.delivery_schedule.fees_for_amount(gross)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="454">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="455">
          
          
          <code class="ruby">      0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="456">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="459">
          <span class="hits">1</span>
          
          <code class="ruby">  def calculate_total_cost(gross)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="460">
          
          
          <code class="ruby">    if gross &gt; 0.0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="461">
          
          
          <code class="ruby">      if credit &amp;&amp; credit.apply_to == &quot;subtotal&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="462">
          
          
          <code class="ruby">        gross + delivery_fees - discount_amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="464">
          
          
          <code class="ruby">        gross + delivery_fees - discount_amount - credit_amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="466">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="467">
          
          
          <code class="ruby">      0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="470">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="d5c01b3984d4a4bc0f5b428156f55658a8453b3f">
  <div class="header">
    <h3>app/models/order_item.rb</h3>
    <h4><span class="red">58.59 %</span> covered</h4>
    <div>
      <b>128</b> relevant lines. 
      <span class="green"><b>75</b> lines covered</span> and
      <span class="red"><b>53</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class OrderItem &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  DELIVERY_STATUSES = %w(pending canceled delivered)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_create :consume_inventory</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_quantity_ordered</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_quantity_delivered</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_delivery_status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_delivered_at</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_consumed_inventory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true, associated_with: :order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :deliver_on_date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :_destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :order, inverse_of: :items</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :product</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :lots, inverse_of: :order_item, class: OrderItemLot, autosave: true, dependent: :destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :product, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :seller_name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :quantity, presence: true, numericality: {greater_than_or_equal_to: 0, less_than: 2_147_483_647}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :quantity_delivered, numericality: {greater_than_or_equal_to: 0, less_than: 2_147_483_647, allow_nil: true}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :unit, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :unit_price, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :delivery_status, presence: true, inclusion: {in: DELIVERY_STATUSES}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :product_availability, on: :create</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :delivered,    -&gt; { where(delivery_status: &quot;delivered&quot;) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :undelivered,  -&gt; { where(delivery_status: &quot;pending&quot;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :seller, through: :product, class_name: Organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_delivery(delivery)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    joins(order: :delivery).where(orders: {delivery_id: delivery.id})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.create_with_order_and_item_and_deliver_on_date(order, item, deliver_on_date)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      deliver_on_date: deliver_on_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      order: order,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      product: item.product,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      name: item.product.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      quantity: item.quantity,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      unit: item.unit,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      unit_price: item.unit_price.sale_price,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      seller_name: item.product.organization.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      delivery_status: &quot;pending&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_delivery_and_user(delivery, user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    ids = user.managed_organization_ids_including_deleted</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    OrderItem.for_delivery(delivery).joins(:product).where(products: {organization_id: ids})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_user_purchases(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    joins(:order).where(orders: {organization_id: user.managed_organization_ids_including_deleted})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_user(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    if user.buyer_only?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      for_user_purchases(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      joins(:product).where(products: {organization_id: user.managed_organization_ids_including_deleted})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  def buyer_payment_status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    payment_status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  def seller_net_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    gross_total - market_seller_fee - local_orbit_seller_fee - payment_seller_fee - discount_seller</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  def gross_total</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="80">
          <span class="hits">3</span>
          
          <code class="ruby">    if quantity_delivered.present?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="81">
          <span class="hits">3</span>
          
          <code class="ruby">      unit_price * quantity_delivered</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      unit_price * quantity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">  def discount</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">    discount_market + discount_seller</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  def discounted_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    gross_total - discount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  def product_availability</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="96">
          <span class="hits">4</span>
          
          <code class="ruby">    return unless product.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="98">
          <span class="hits">4</span>
          
          <code class="ruby">    quantity_available = product.lots_by_expiration.available.sum(:quantity)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="100">
          <span class="hits">4</span>
          
          <code class="ruby">    if quantity_available &lt; quantity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      errors[:inventory] = &quot;there are only #{quantity_available} #{product.name.pluralize(quantity_available)} available.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">  def seller</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    product.organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">  def seller_payment_status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">    @seller_payment_status ||= order.paid_seller_ids.include?(product.organization_id) ? &quot;Paid&quot; : &quot;Unpaid&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">  def delivered?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    delivery_status == &quot;delivered&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">  def consume_inventory</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="120">
          <span class="hits">4</span>
          
          <code class="ruby">    consume_inventory_amount(quantity)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_delivered_at</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="124">
          <span class="hits">8</span>
          
          <code class="ruby">    if delivery_status_changed? &amp;&amp; delivery_status == &quot;delivered&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      self.delivered_at ||= Time.current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_unit_price</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="130">
          <span class="hits">4</span>
          
          <code class="ruby">    if order &amp;&amp; order.market &amp;&amp; order.organization</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      new_price = Orders::UnitPriceLogic.unit_price(product, order.market, order.organization, order.created_at, quantity)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      if new_price != nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">        self.unit_price = new_price.sale_price</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_quantity_ordered</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="139">
          <span class="hits">8</span>
          
          <code class="ruby">    if quantity_changed?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="140">
          <span class="hits">4</span>
          
          <code class="ruby">      update_unit_price</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="141">
          <span class="hits">4</span>
          
          <code class="ruby">      if quantity.present? &amp;&amp; delivery_status == &quot;pending&quot; &amp;&amp; quantity == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">        self.delivery_status = &quot;canceled&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">        self.payment_status = &quot;refunded&quot; if refundable?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_quantity_delivered</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="149">
          <span class="hits">8</span>
          
          <code class="ruby">    if should_update_delivery_status?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      self.delivery_status = quantity_delivered &gt; 0 ? &quot;delivered&quot; : &quot;canceled&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      self.payment_status = &quot;refunded&quot; if quantity_delivered == 0 &amp;&amp; refundable?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">  def should_update_delivery_status?</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="156">
          <span class="hits">8</span>
          
          <code class="ruby">    quantity_delivered_changed? &amp;&amp; quantity_delivered.present? &amp;&amp; delivery_status_was == &quot;pending&quot; &amp;&amp; delivery_status != &quot;contested&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_delivery_status</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="160">
          <span class="hits">8</span>
          
          <code class="ruby">    if persisted? &amp;&amp; delivery_status_changed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">      if delivery_status == &quot;delivered&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">        self.quantity_delivered ||= quantity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">      elsif delivery_status == &quot;canceled&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">        self.quantity_delivered = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">        self.payment_status = &quot;refunded&quot; if refundable?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">  def consume_inventory_amount(amount)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="171">
          <span class="hits">4</span>
          
          <code class="ruby">    product.lots_by_expiration.available(deliver_on_date).each do |lot|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="172">
          <span class="hits">4</span>
          
          <code class="ruby">      break unless amount &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="174">
          <span class="hits">4</span>
          
          <code class="ruby">      num_to_consume = [lot.quantity, amount].min</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="175">
          <span class="hits">4</span>
          
          <code class="ruby">      lot.decrement!(:quantity, num_to_consume)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="177">
          <span class="hits">4</span>
          
          <code class="ruby">      lots.build(lot: lot, quantity: num_to_consume)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="178">
          <span class="hits">4</span>
          
          <code class="ruby">      amount -= num_to_consume</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">  def return_inventory_amount(amount)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">    lots.order(created_at: :desc).each do |lot|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">      break unless amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">      num_to_return = [lot.quantity, amount].min</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">      lot.lot.increment!(:quantity, num_to_return)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">      amount -= num_to_return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_consumed_inventory</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="194">
          <span class="hits">8</span>
          
          <code class="ruby">    if persisted? &amp;&amp; quantity_changed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      quantity_remaining = changes[:quantity][1] - (changes[:quantity][0] || 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">      if quantity_remaining &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">        consume_inventory_amount(quantity_remaining)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">        return_inventory_amount(quantity_remaining.abs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="205">
          <span class="hits">1</span>
          
          <code class="ruby">  def refundable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">    [&quot;pending&quot;, &quot;paid&quot;].include?(payment_status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">  def share_of_credit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">    seller = find_applicable_seller</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">    if order.credit &amp;&amp; order.credit.paying_org == nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">      if order.credit.amount_type == &quot;fixed&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">        (order.credit_amount / (order.sellers.count || 1)).round 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">        (gross_total / order.gross_total * order.credit_amount).round 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">    elsif seller.nil? || order.credit.paying_org.id == seller.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">      # When a user belongs to more than one organization that are on the order,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">      # the display will be confusing because they won&#39;t know which organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">      # is paying the credit.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">      order.credit_amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">      0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="227">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_applicable_seller</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">    if order.credit &amp;&amp; order.credit.paying_org</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">      order.sellers.each do |s|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">        if s.id == order.credit.paying_org.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">          s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="41d30a20534252f2048a2b63dd219cbded33bc68">
  <div class="header">
    <h3>app/models/order_item_lot.rb</h3>
    <h4><span class="red">80.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class OrderItemLot &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :order_item, inverse_of: :lots</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :lot</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  before_destroy :return_inventory_to_lot</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    lot.number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def return_inventory_to_lot</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    lot.increment!(:quantity, quantity)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="0cc922615abf97a04cb473c9ad5895a343f05071">
  <div class="header">
    <h3>app/models/order_number.rb</h3>
    <h4><span class="red">42.86 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>12</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class OrderNumber</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(market)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    @market = market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    @order_number ||= &quot;LO-#{order_namespace}-#{order_id}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.relinquish(order_number)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    order_string = (order_number.instance_of? String) ? order_number : order_number.order_number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    order_without_LO = order_string.partition(&#39;LO-&#39;).last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    partitioned_order = order_without_LO.rpartition(&#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    name = partitioned_order.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    order_id = partitioned_order.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    Sequence.decrement_for(&quot;order-#{name}&quot;, order_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  def order_namespace</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    &quot;#{year}-#{market_id}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  def order_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    &quot;%07d&quot; % Sequence.increment_for(&quot;order-#{order_namespace}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def market_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    @market.subdomain.upcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def year</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    Time.now.in_time_zone(@market.timezone).strftime(&quot;%y&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="74cf7f909043ce0e96ff09efe843dfbf5beea4af">
  <div class="header">
    <h3>app/models/order_payment.rb</h3>
    <h4><span class="yellow">83.33 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class OrderPayment &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true, associated_with: :order</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :order</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :payment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.market_paid_orders_subselect(payment_type, type=:payee)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    select(:order_id).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      joins(:payment).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      where.not(payments: {status: &quot;failed&quot;}).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      where(payments: {payment_type: payment_type, &quot;#{type}_type&quot; =&gt; &quot;Market&quot;}).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      where(Payment.arel_table[&quot;#{type}_id&quot;].eq(Order.arel_table[:market_id])).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="cc42b90bf3a480559c14e2918ed2b14afb4a24af">
  <div class="header">
    <h3>app/models/order_printable.rb</h3>
    <h4><span class="red">62.5 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class OrderPrintable &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :pdf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_user, -&gt; (user) {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    if user.admin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      where user: user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="cefe9b10f584e8fbb0f3fe69abdffda387ea7c03">
  <div class="header">
    <h3>app/models/order_template.rb</h3>
    <h4><span class="red">60.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class OrderTemplate &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :items, class_name: :OrderTemplateItem, inverse_of: :order_template</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :market, :name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, uniqueness: {scope: :market}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.create_from_cart!(cart, name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    template = OrderTemplate.create!(name: name, market: cart.market)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    cart.items.each do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      OrderTemplateItem.create!(product: item.product, quantity: item.quantity, order_template: template)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    template</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="046242a63b971550bceca68f446b0417e1944096">
  <div class="header">
    <h3>app/models/order_template_item.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class OrderTemplateItem &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :order_template</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :product</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :order_template, :product, :quantity, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2ce6038d932a7aea729bad90c5e40c6ff9dffc4b">
  <div class="header">
    <h3>app/models/organization.rb</h3>
    <h4><span class="red">66.67 %</span> covered</h4>
    <div>
      <b>93</b> relevant lines. 
      <span class="green"><b>62</b> lines covered</span> and
      <span class="red"><b>31</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Organization &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  extend DragonflyBackgroundResize</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include Sortable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  include PgSearch</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :market_organizations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :user_organizations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :users, through: :user_organizations</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="11">
          <span class="hits">14</span>
          
          <code class="ruby">  has_many :all_markets, -&gt; { extending(MarketOrganization::AssociationScopes).excluding_deleted },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">           through: :market_organizations,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">           source: :market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="15">
          <span class="hits">72</span>
          
          <code class="ruby">  has_many :markets, -&gt; { extending(MarketOrganization::AssociationScopes).excluding_deleted.not_cross_selling },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">           through: :market_organizations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :cross_sells, -&gt; { extending(MarketOrganization::AssociationScopes).excluding_deleted.cross_selling },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">           through: :market_organizations,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">           source: :market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :orders, inverse_of: :organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :general_products, inverse_of: :organization, autosave: true, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :products, inverse_of: :organization, autosave: true, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :general_products, inverse_of: :organization, autosave: true, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :carts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :locations, inverse_of: :organization, dependent: :destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :bank_accounts, as: :bankable, dependent: :destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true, length: {maximum: 255, allow_blank: true}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :require_payment_method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="36">
          <span class="hits">4</span>
          
          <code class="ruby">  scope :active,  -&gt; { where(active: true) }</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="37">
          <span class="hits">14</span>
          
          <code class="ruby">  scope :selling, -&gt; { where(can_sell: true) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :buying,  -&gt; { where(can_sell: false) } # needs a new boolean</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :visible, -&gt; { where(show_profile: true) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :with_products, -&gt; { joins(:products).select(&quot;DISTINCT organizations.*&quot;).order(name: :asc) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :buyers_for_orders, lambda {|orders| joins(:orders).where(orders: {id: orders}).uniq }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :with_a_market, -&gt; { joins(user_organizations: {organization: :markets}).group(&quot;organizations.id&quot;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="44">
          <span class="hits">30</span>
          
          <code class="ruby">  scope :not_deleted, -&gt; { joins(:markets) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  serialize :twitter, TwitterUser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  accepts_nested_attributes_for :locations, reject_if: :reject_location</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :photo</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  define_after_upload_resize(:photo, 1200, 1200)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_property :format, of: :photo, in: %w(jpeg png gif)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :market, method: :for_market_id, ignore_blank: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :can_sell, method: :for_can_sell, ignore_blank: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :sort, method: :for_sort, ignore_blank: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :search, method: :for_search, ignore_blank: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  pg_search_scope :search_by_name, against: :name, using: {tsearch: {prefix: true}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_search(query)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    search_by_name(query)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_market_id(market_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    orgs = !all.to_sql.include?(&quot;market_organizations&quot;) ? joins(:market_organizations) : all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    orgs.where(market_organizations: {market_id: [market_id]})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_can_sell(can_sell)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    where(can_sell: can_sell)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.arel_column_for_sort(column_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    case column_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    when &quot;can_sell&quot;   then arel_table[:can_sell]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    when &quot;registered&quot; then arel_table[:created_at]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">      arel_table[:name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.managed_by_market_ids(market_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    select(&quot;organizations.*&quot;).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    joins(:market_organizations).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    where(market_organizations: {market_id: market_ids}).</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="87">
          <span class="hits">27</span>
          
          <code class="ruby">    where(market_organizations: {cross_sell_origin_market_id: nil})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.all_for_market_ids(market_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    select(&quot;organizations.*&quot;).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    joins(:market_organizations).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    where(market_organizations: {market_id: market_ids})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">  def shipping_location</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">    locations.visible.default_shipping</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  def billing_location</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    locations.visible.default_billing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_cross_sell?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">    can_sell? &amp;&amp; markets.joins(:plan).where(allow_cross_sell: true, plans: {cross_selling: true}).any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_product_delivery_schedules</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    reload.products.each(&amp;:save) if persisted?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_cross_sells!(from_market: nil, to_ids: [])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    ids = to_ids.map(&amp;:to_i)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">    original_cross_sells  = market_organizations.visible.where(cross_sell_origin_market: from_market)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">    cross_sells_to_remove = original_cross_sells.where.not(market_id: ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    new_cross_sell_ids = ids - original_cross_sells.map(&amp;:market_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    # Create the new ones</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">    new_cross_sell_ids.each do |new_cross_sell_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      market_organizations.create(market_id: new_cross_sell_id, cross_sell_origin_market: from_market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    # Destroy the old ones</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    cross_sells_to_remove.soft_delete_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    update_product_delivery_schedules</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">  def balanced_customer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    Balanced::Customer.find(balanced_customer_uri)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">  def original_market</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    (markets.includes(:markets).empty? ? cross_sells : markets).order(&quot;market_organizations.id ASC&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">  def cross_selling?(from: nil, to: nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    market_organizations.excluding_deleted.where(cross_sell_origin_market: from, market: to).exists?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_market?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    markets.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">  def primary_payment_provider</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">    if m = markets.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">      m.primary_payment_provider</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">  def stripe_customer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    Stripe::Customer.retrieve(stripe_customer_id) if stripe_customer_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">  def all_markets_for_select</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">    all_markets.map do |market|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">      [market.name, market.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">  def reject_location(attributed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    #attributed[&quot;name&quot;].blank? ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    attributed[&quot;address&quot;].blank? ||</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">      attributed[&quot;city&quot;].blank? ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">      attributed[&quot;state&quot;].blank? ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      attributed[&quot;zip&quot;].blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">  def require_payment_method</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="174">
          <span class="hits">9</span>
          
          <code class="ruby">    unless allow_purchase_orders? || allow_credit_cards? || allow_ach?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      errors.add(:payment_method, &quot;At least one payment method is required for the organization&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6f239ab72547f1f4efddb8b536ad5b167d665811">
  <div class="header">
    <h3>app/models/packing_labels_printable.rb</h3>
    <h4><span class="red">62.5 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class PackingLabelsPrintable &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :delivery</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :pdf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_user, -&gt; (user) {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    if user.admin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      where user: user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a3781be5cd84f6e7b76fa5783d44c130a497e6a8">
  <div class="header">
    <h3>app/models/payment.rb</h3>
    <h4><span class="red">78.57 %</span> covered</h4>
    <div>
      <b>42</b> relevant lines. 
      <span class="green"><b>33</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Payment &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  PAYMENT_TYPES = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">    &quot;hub fee&quot; =&gt; &quot;Market Fee&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    &quot;lo fee&quot; =&gt; &quot;LO Fee&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    &quot;market payment&quot; =&gt; &quot;Market Payment&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    &quot;order&quot; =&gt; &quot;Order&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    &quot;order refund&quot; =&gt; &quot;Order Refund&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    &quot;seller payment&quot; =&gt; &quot;Seller Payment&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    &quot;service&quot; =&gt; &quot;Service Fee&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    &quot;service refund&quot; =&gt; &quot;Service Refund&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  }.freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  PAYMENT_METHODS = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    &quot;ach&quot; =&gt; &quot;ACH&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    &quot;cash&quot; =&gt; &quot;Cash&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    &quot;check&quot; =&gt; &quot;Check&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    &quot;credit card&quot; =&gt; &quot;Credit Card&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    &quot;purchase order&quot; =&gt; &quot;Purchase Order&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  }.freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :payee, polymorphic: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :payer, polymorphic: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :bank_account</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :parent, class_name: &quot;Payment&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  # Add organization-specifc payer and payee associations so we can</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  # search payments by payer and payee attributes.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :organization_payer,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">             -&gt; { where(payments: {payer_type: &quot;Organization&quot;}) },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">             class_name: &quot;Organization&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">             foreign_key: &quot;payer_id&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :organization_payee,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">             -&gt; { where(payments: {payee_type: &quot;Organization&quot;}) },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">             class_name: &quot;Organization&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">             foreign_key: &quot;payee_id&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :from_organization, class_name: &quot;Organization&quot;, foreign_key: :payer_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :from_market, class_name: &quot;Market&quot;, foreign_key: :payer_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :order_payments, inverse_of: :payment</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :orders, through: :order_payments, inverse_of: :payments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :amount, presence: true, numericality: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :payee_or_payer_is_set</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :successful, -&gt; { where(status: %w(paid pending)) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_refunded, -&gt; { where(arel_table[:amount].gt(arel_table[:refunded_amount])) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :refundable, -&gt; { successful.not_refunded.where(payment_type: &quot;order&quot;) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :buyer_payments, -&gt; { where(payment_type: [&quot;order&quot;, &quot;order refund&quot;]) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_orders, lambda {|orders| joins(:order_payments).where(order_payments: {order_id: orders}) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :seller_payments, -&gt; { where(payment_type: &quot;seller payment&quot;) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :made_after, -&gt;(start_at) { where(arel_table[:created_at].gt(start_at)) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  ransacker :update_at_date do |_|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    Arel::Nodes::NamedFunction.new(&quot;DATE&quot;, [arel_table[:updated_at]])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  ransacker :payer_type_id do |_|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    Arel.sql(&quot;NULLIF(payer_type || payer_id, &#39;&#39;)&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  ransacker :payee_type_id do |_|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    Arel.sql(&quot;NULLIF(payee_type || payee_id, &#39;&#39;)&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  def unrefunded_amount</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    amount - refunded_amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  def balanced_transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    # Will return the appropriate transaction type for any transaction</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    Balanced::Transaction.find(balanced_uri) if balanced_uri.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  def refund?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    [&quot;order refund&quot;, &quot;service refund&quot;].include? payment_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  def payee_or_payer_is_set</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    if payee_id.nil? &amp;&amp; payer_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      errors.add(:base, &quot;A Payee or Payer must be specified&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="55b0ad17f327102082a079eb72ce27b07af52438">
  <div class="header">
    <h3>app/models/plan.rb</h3>
    <h4><span class="red">80.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Plan &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :markets, inverse_of: :plan</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.options_for_select</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    order(:name).pluck(:name, :id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="70af20f3bee585688e8bb736fe0eccbe48254cfd">
  <div class="header">
    <h3>app/models/price.rb</h3>
    <h4><span class="red">63.64 %</span> covered</h4>
    <div>
      <b>22</b> relevant lines. 
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Price &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include SoftDelete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :product, inverse_of: :prices</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :view_sorted, lambda {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    visible</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    .joins(&quot;LEFT JOIN markets ON prices.market_id = markets.id LEFT JOIN organizations ON prices.organization_id = organizations.id&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    .order(&quot;markets.name NULLS FIRST, organizations.name NULLS FIRST, min_quantity&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_product_and_market_and_org_at_time, lambda {|product, market, organization, order_time|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    where(&quot;product_id = ?&quot;, product.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    .where(&quot;updated_at &lt;= ?&quot;, order_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    .where(&quot;deleted_at IS NULL OR deleted_at &gt;= ?&quot;, order_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    .where(&quot;market_id IS NULL OR market_id = ?&quot;, market.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    .where(&quot;organization_id IS NULL OR organization_id = ?&quot;, organization.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_market_and_org, lambda { |market, organization|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    visible</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    .where(&quot;market_id IS NULL OR market_id = ?&quot;, market.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    .where(&quot;organization_id IS NULL OR organization_id = ?&quot;, organization.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :min_quantity, :sale_price, presence: true, numericality: {greater_than: 0, less_than: 1_000_000, allow_blank: true}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :min_quantity, uniqueness: {scope: [:product_id, :market_id, :organization_id, :deleted_at]}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  def net_price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    ((sale_price || 0) * net_percent).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def net_percent</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    if market</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      market.seller_net_percent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      product.organization.all_markets.map{|mkt| mkt.seller_net_percent}.min</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  def for_market_and_organization?(market, organization)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    (market_id.nil? || market_id == market.id) &amp;&amp; (organization_id.nil? || organization_id == organization.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b386c520a52dd0b7ab147ce21e59ec28b95a866a">
  <div class="header">
    <h3>app/models/product.rb</h3>
    <h4><span class="red">58.78 %</span> covered</h4>
    <div>
      <b>296</b> relevant lines. 
      <span class="green"><b>174</b> lines covered</span> and
      <span class="red"><b>122</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Product &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  extend DragonflyBackgroundResize</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include SoftDelete</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include PgSearch</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  include Sortable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  paginates_per 50</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_cached_categories</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_delivery_schedules</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_general_product</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true, associated_with: :organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :category</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :top_level_category, class: Category</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :second_level_category, class: Category</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :organization, inverse_of: :products</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :location</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :unit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :external_product, inverse_of: :product</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :general_product</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="22">
          <span class="hits">20</span>
          
          <code class="ruby">  default_scope { includes(:general_product) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # transient properties for conveniently adding sibling (product) units</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :sibling_id, :sibling_unit_id, :sibling_unit_description, :sibling_product_code</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="27">
          <span class="hits">7</span>
          
          <code class="ruby">  has_many :lots, -&gt; { order(&quot;created_at&quot;) }, inverse_of: :product, autosave: true, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="28">
          <span class="hits">5</span>
          
          <code class="ruby">  has_many :lots_by_expiration, -&gt; { order(&quot;expires_at, good_from, created_at&quot;) }, class_name: Lot, foreign_key: :product_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :product_deliveries, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :delivery_schedules, through: :product_deliveries</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :order_items</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :orders, through: :order_items</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :prices, -&gt; {visible},  autosave: true, inverse_of: :product, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :promotions, inverse_of: :product</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :market_organizations, through: :organization, class_name: MarketOrganization</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :markets, through: :market_organizations, class_name: Market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :image do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    copy_to(:thumb){|a| a.thumb(&#39;150x150#&#39;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :thumb</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  #define_after_upload_resize(:image, 1200, 1200, thumb: {width: 150, height: 150})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_property :format, of: :image, in: %w(jpg jpeg png gif)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_property :format, of: :thumb, in: %w(jpg jpeg png gif)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :unit, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :category_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :organization_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :short_description, presence: true, length: {maximum: 50}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :long_description, length: {maximum: 500}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :location, presence: true, if: :overrides_organization?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :ensure_organization_can_sell</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :name, to: :organization, prefix: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :market, method: :for_market_id, ignore_blank: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :organization, method: :for_organization_id, ignore_blank: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :category, method: :for_category_id, ignore_blank: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :sort, method: :for_sort, ignore_blank: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :search, method: :for_search, ignore_blank: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  pg_search_scope :search_by_name, against: :name, using: {tsearch: {prefix: true}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  ### GETTERS ###</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  def name</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="70">
          <span class="hits">34</span>
          
          <code class="ruby">    self.general_product &amp;&amp; self.general_product.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  def category_id</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="73">
          <span class="hits">30</span>
          
          <code class="ruby">    self.general_product &amp;&amp; self.general_product.category_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  def organization_id</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="76">
          <span class="hits">30</span>
          
          <code class="ruby">    self.general_product &amp;&amp; self.general_product.organization_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  def who_story</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="79">
          <span class="hits">24</span>
          
          <code class="ruby">    self.general_product &amp;&amp; self.general_product.who_story</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  def how_story</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="82">
          <span class="hits">24</span>
          
          <code class="ruby">    self.general_product &amp;&amp; self.general_product.how_story</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  def location_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    self.general_product &amp;&amp; self.general_product.location_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">  def image_uid</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="88">
          <span class="hits">18</span>
          
          <code class="ruby">    self.general_product &amp;&amp; self.general_product.image_uid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  def top_level_category_id</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="91">
          <span class="hits">6</span>
          
          <code class="ruby">    self.general_product &amp;&amp; self.general_product.top_level_category_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">  def short_description</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="94">
          <span class="hits">54</span>
          
          <code class="ruby">    self.general_product &amp;&amp; self.general_product.short_description</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">  def long_description</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="97">
          <span class="hits">24</span>
          
          <code class="ruby">    self.general_product &amp;&amp; self.general_product.long_description</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">  def use_all_deliveries</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    if self.general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      self.general_product.use_all_deliveries</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      true # Default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">  def thumb_uid</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="107">
          <span class="hits">18</span>
          
          <code class="ruby">    self.general_product &amp;&amp; self.general_product.thumb_uid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">  def second_level_category_id</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="110">
          <span class="hits">6</span>
          
          <code class="ruby">    self.general_product &amp;&amp; self.general_product.second_level_category_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  ### SETTERS ###</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">  def name=(input)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="115">
          <span class="hits">6</span>
          
          <code class="ruby">    write_attribute(:name, input)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="116">
          <span class="hits">6</span>
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="117">
          <span class="hits">6</span>
          
          <code class="ruby">    self.general_product.name = input</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="118">
          <span class="hits">6</span>
          
          <code class="ruby">    input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">  def category_id=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    write_attribute(:category_id, input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">    self.general_product.category_id = input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">  def category=(input)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="126">
          <span class="hits">6</span>
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="127">
          <span class="hits">6</span>
          
          <code class="ruby">    self.general_product.category_id = if input.present?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="128">
          <span class="hits">6</span>
          
          <code class="ruby">      input.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="132">
          <span class="hits">6</span>
          
          <code class="ruby">    association(:category).writer(input)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">  def organization_id=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">    write_attribute(:organization_id, input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    self.general_product.organization_id = input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">  def organization=(input)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="140">
          <span class="hits">6</span>
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="141">
          <span class="hits">6</span>
          
          <code class="ruby">    self.general_product.organization_id = if input.present?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="142">
          <span class="hits">6</span>
          
          <code class="ruby">      input.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="146">
          <span class="hits">6</span>
          
          <code class="ruby">    association(:organization).writer(input)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">  def who_story=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">    write_attribute(:who_story, input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">    self.general_product.who_story = input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">  def how_story=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    write_attribute(:how_story, input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">    self.general_product.how_story = input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">  def location_id=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">    write_attribute(:location_id, input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">    self.general_product.location_id = input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">  def location=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">    self.general_product.location_id = if input.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">      input.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">    association(:location).writer(input)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">  def image_uid=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">    write_attribute(:image_uid, input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">    self.general_product.image_uid = input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="177">
          <span class="hits">1</span>
          
          <code class="ruby">  def top_level_category_id=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">    write_attribute(:top_level_category_id, input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    self.general_product.top_level_category_id = input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">  def top_level_category=(input)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="183">
          <span class="hits">18</span>
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="184">
          <span class="hits">18</span>
          
          <code class="ruby">    self.general_product.top_level_category_id = if input.present?</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="185">
          <span class="hits">18</span>
          
          <code class="ruby">      input.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="189">
          <span class="hits">18</span>
          
          <code class="ruby">    association(:top_level_category).writer(input)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">  def short_description=(input)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="192">
          <span class="hits">6</span>
          
          <code class="ruby">    write_attribute(:short_description, input)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="193">
          <span class="hits">6</span>
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="194">
          <span class="hits">6</span>
          
          <code class="ruby">    self.general_product.short_description = input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">  def long_description=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">    write_attribute(:long_description, input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">    self.general_product.long_description = input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="201">
          <span class="hits">1</span>
          
          <code class="ruby">  def use_all_deliveries=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">    write_attribute(:use_all_deliveries, input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">    self.general_product.use_all_deliveries = input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="206">
          <span class="hits">1</span>
          
          <code class="ruby">  def thumb_uid=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">    write_attribute(:thumb_uid, input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">    self.general_product.thumb_uid = input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">  def second_level_category_id=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">    write_attribute(:second_level_category_id, input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">    self.general_product.second_level_category_id = input</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">  def second_level_category=(input)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="217">
          <span class="hits">12</span>
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="218">
          <span class="hits">12</span>
          
          <code class="ruby">    self.general_product.second_level_category_id = if input.present?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="219">
          <span class="hits">12</span>
          
          <code class="ruby">      input.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="223">
          <span class="hits">12</span>
          
          <code class="ruby">    association(:second_level_category).writer(input) </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">  def general_product_id=(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">    gp = GeneralProduct.find(input)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">    if gp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">      self.general_product = gp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">      self.general_product.id = input</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">      write_attribute(:general_product_id, input)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="234">
          <span class="hits">1</span>
          
          <code class="ruby">  def general_product=(input)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="235">
          <span class="hits">6</span>
          
          <code class="ruby">    association(:general_product).writer(input)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="236">
          <span class="hits">6</span>
          
          <code class="ruby">    self.general_product.assign_attributes(input.as_json)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">  pg_search_scope :search_by_text,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">    :against =&gt; :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">    :associated_against =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">      :second_level_category =&gt; :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">      :organization =&gt; :name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">    :using =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">      :tsearch =&gt; {prefix: true}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.available_for_market(market)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">    return none unless market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">    visible.seller_can_sell.where(organization: market.organization_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">  # Does not explicitly scope to the market. Use in conjunction with available_for_market.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="256">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.available_for_sale(market, buyer=nil, deliver_on_date=Time.current.end_of_minute)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">    visible.seller_can_sell.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">      with_available_inventory(deliver_on_date).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">      priced_for_market_and_buyer(market, buyer).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">      group(&quot;products.id&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="264">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.priced_for_market_and_buyer(market, buyer=nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">    price_table = Price.arel_table</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">    on_cond = arel_table[:id].eq(price_table[:product_id]).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">              and(price_table[:market_id].eq(market.id).or(price_table[:market_id].eq(nil)))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">    if buyer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">      on_cond = on_cond.and(price_table[:organization_id].eq(buyer.id).or(price_table[:organization_id].eq(nil)))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">      on_cond = on_cond.and(price_table[:organization_id].eq(nil))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">    price_join = arel_table.create_join(price_table, arel_table.create_on(on_cond))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">    joins(price_join)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="279">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.with_visible_pricing</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">    where(&quot;prices.deleted_at IS NULL&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="283">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.seller_can_sell</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">    joins(:organization).where(organizations: {can_sell: true, active: true})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_market_id(market_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">    joins(organization: :market_organizations).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">      extending(MarketOrganization::AssociationScopes).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">      excluding_deleted.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">      mo_join_market_id(market_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="294">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_organization_id(organization_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">    where(organization_id: organization_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="298">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_category_id(category_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">    where(top_level_category_id: category_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="302">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_sort(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">    column, direction = column_and_direction(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">    case column</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">    when &quot;price&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">      for_sort_by_price(direction)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">    when &quot;stock&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">      for_sort_by_stock(direction)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">    when &quot;seller&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">      order_by_seller_name(direction)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">    when &quot;market&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">      joins(organization: {market_organizations: :market}).order_by_market_name(direction)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">      order_by_name(direction)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="318">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_search(query)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">    search_by_name(query)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="322">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.with_available_inventory(deliver_on_date=Time.current.end_of_minute)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">    lot_table = Lot.arel_table</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">    on_cond = arel_table[:id].eq(lot_table[:product_id]).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">              and(lot_table[:good_from].eq(nil).or(lot_table[:good_from].lt(deliver_on_date))).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">              and(lot_table[:expires_at].eq(nil).or(lot_table[:expires_at].gt(deliver_on_date))).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">              and(lot_table[:quantity].gt(0))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">    join_on = arel_table.create_on(on_cond)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">    joins(arel_table.create_join(Lot.arel_table, join_on))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="333">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_use_simple_inventory?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">    use_simple_inventory? || !lots.where(&quot;(expires_at IS NULL OR expires_at &gt; ?) AND quantity &gt; 0&quot;, Time.current.end_of_minute).exists?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="337">
          <span class="hits">1</span>
          
          <code class="ruby">  def simple_inventory</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">    lots.last.try(:available_quantity) || 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="341">
          <span class="hits">1</span>
          
          <code class="ruby">  def simple_inventory=(val)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="342">
          
          
          <code class="ruby">    return val unless use_simple_inventory?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">    lot = lots.to_a.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">    lot = lots.build unless lot.try(:simple?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">    lot.quantity = val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="349">
          <span class="hits">1</span>
          
          <code class="ruby">  def available_inventory(deliver_on_date=Time.current.end_of_minute)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">    if lots.loaded?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">      lots.to_a.sum {|l| l.available?(deliver_on_date) ? l.quantity : 0 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">      lots.available(deliver_on_date).sum(:quantity)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="357">
          <span class="hits">1</span>
          
          <code class="ruby">  def minimum_quantity_for_purchase(opts={})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">    prices.for_market_and_org(opts[:market], opts[:organization]).minimum(&quot;min_quantity&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="361">
          <span class="hits">1</span>
          
          <code class="ruby">  def market_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">    organization.original_market.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="365">
          <span class="hits">1</span>
          
          <code class="ruby">  def net_percent</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">    @net_percent ||= organization.original_market.seller_net_percent # TODO not this (?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="369">
          <span class="hits">1</span>
          
          <code class="ruby">  def organization_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">    organization.try(:name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="373">
          <span class="hits">1</span>
          
          <code class="ruby">  def plural_units_with_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">    unit.plural ? &quot;#{unit.plural} of #{name}&quot; : name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="377">
          <span class="hits">1</span>
          
          <code class="ruby">  def unit_plural</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">    unit_with_description(:plural)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="381">
          <span class="hits">1</span>
          
          <code class="ruby">  def unit_singular</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">    unit_with_description(:singular)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="385">
          <span class="hits">1</span>
          
          <code class="ruby">  def unit_with_description(singular_or_plural)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">    if unit_description.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">      &quot;#{unit.try(singular_or_plural)}, #{unit_description}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">      unit.try(singular_or_plural)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="393">
          <span class="hits">1</span>
          
          <code class="ruby">  def prices_for_market_and_organization(market, organization)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">    if prices.loaded?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">      prices.inject({}) do |final_prices, price|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">        if price.for_market_and_organization?(market, organization) &amp;&amp; (price.organization_id || !final_prices.key?(price.min_quantity))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">          final_prices[price.min_quantity] = price</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">        final_prices</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">      end.values.sort {|a, b| a.min_quantity &lt;=&gt; b.min_quantity }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">      prices.where(market_id: [market.id, nil], organization_id: [organization.id, nil]).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">        order(&quot;min_quantity, organization_id desc nulls first&quot;).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">        index_by {|price| price.min_quantity }.values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="409">
          <span class="hits">1</span>
          
          <code class="ruby">  def disable_advanced_inventory(market)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">    advanced_inventory = organization.markets.reject{|m| m == market }.any? {|m| m.reload.plan.advanced_inventory }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">    if !advanced_inventory &amp;&amp; lots.count &gt; 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">      update_column(:use_simple_inventory, true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby">      current_available_inventory = available_inventory</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="414">
          
          
          <code class="ruby">      lots.delete_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="415">
          
          
          <code class="ruby">      lots.build(quantity: current_available_inventory).save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="419">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="421">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_product_has_a_general_product</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="422">
          <span class="hits">66</span>
          
          <code class="ruby">    unless self.general_product</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="423">
          <span class="hits">6</span>
          
          <code class="ruby">      self.general_product = GeneralProduct.new</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="424">
          <span class="hits">6</span>
          
          <code class="ruby">      self.general_product.use_all_deliveries = true</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="425">
          <span class="hits">6</span>
          
          <code class="ruby">      self.general_product.product &lt;&lt; self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="429">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_general_product</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="430">
          <span class="hits">12</span>
          
          <code class="ruby">    ensure_product_has_a_general_product</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="431">
          <span class="hits">12</span>
          
          <code class="ruby">    self.general_product.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="434">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.order_by_name(direction)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="435">
          
          
          <code class="ruby">    direction == &quot;asc&quot; ? order(name: :asc) : order(name: :desc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="438">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.order_by_market_name(direction)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="439">
          
          
          <code class="ruby">    direction == &quot;asc&quot; ? order(&quot;markets.name asc&quot;) : order(&quot;markets.name desc&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="442">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.order_by_seller_name(direction)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="443">
          
          
          <code class="ruby">    direction == &quot;asc&quot; ? order(&quot;organizations.name asc&quot;) : order(&quot;organizations.name desc&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="446">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.order_by_stock(direction)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby">    direction == &quot;asc&quot; ? order(&quot;stock asc nulls first, name asc&quot;) : order(&quot;stock desc nulls last, name desc&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="448">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="450">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.order_by_price(direction)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="451">
          
          
          <code class="ruby">    direction == &quot;asc&quot; ? order(&quot;price asc&quot;) : order(&quot;price desc&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="454">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_sort_by_price(direction)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby">    joins(&quot;left outer join prices on products.id = prices.product_id&quot;).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="456">
          
          
          <code class="ruby">      select(&quot;products.*, coalesce(MAX(prices.sale_price), 0) as price&quot;).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="457">
          
          
          <code class="ruby">      group(&quot;products.id&quot;).order_by_price(direction)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="460">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_sort_by_stock(direction)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="461">
          
          
          <code class="ruby">    lot = Lot.arel_table</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="462">
          
          
          <code class="ruby">    expires_condition = lot[:expires_at].gt(Time.current.end_of_minute).or(lot[:expires_at].eq(nil))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="463">
          
          
          <code class="ruby">    good_from = lot[:good_from].lt(Time.current.end_of_minute).or(lot[:good_from].eq(nil))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">    joins(&quot;LEFT OUTER JOIN lots ON products.id = lots.product_id AND #{expires_condition.and(good_from).to_sql}&quot;).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby">      select(&quot;products.*, SUM(lots.quantity) as stock&quot;).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="466">
          
          
          <code class="ruby">      group(&quot;products.id&quot;).order_by_stock(direction)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="469">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_organization_can_sell</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="470">
          <span class="hits">24</span>
          
          <code class="ruby">    unless organization.present? &amp;&amp; organization.can_sell?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="471">
          
          
          <code class="ruby">      errors.add(:organization, &quot;must be able to sell products&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="475">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_cached_categories</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="476">
          <span class="hits">12</span>
          
          <code class="ruby">    if category_id_changed?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="477">
          <span class="hits">12</span>
          
          <code class="ruby">      self.top_level_category = category.top_level_category</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="478">
          <span class="hits">12</span>
          
          <code class="ruby">      self.second_level_category = category.self_and_ancestors.find_by(depth: 2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="480">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="481">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="482">
          <span class="hits">1</span>
          
          <code class="ruby">  def overrides_organization?</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="483">
          <span class="hits">24</span>
          
          <code class="ruby">    who_story.present? || how_story.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="484">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="485">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="486">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_delivery_schedules</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="487">
          <span class="hits">12</span>
          
          <code class="ruby">    markets = organization.all_markets.excluding_deleted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="488">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="489">
          <span class="hits">12</span>
          
          <code class="ruby">    if self.use_all_deliveries?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="490">
          <span class="hits">12</span>
          
          <code class="ruby">      self.delivery_schedule_ids = markets.map do |market|</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="491">
          <span class="hits">10</span>
          
          <code class="ruby">        market.delivery_schedules.visible.map(&amp;:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby">      end.flatten</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="494">
          
          
          <code class="ruby">      ids = markets.map(&amp;:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="495">
          
          
          <code class="ruby">      self.delivery_schedules = delivery_schedules.select {|ds| ids.include?(ds.market.id) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="496">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="498">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="499">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="385b1b972fc33be56187342a1359983f9f92ff29">
  <div class="header">
    <h3>app/models/product_delivery.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ProductDelivery &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :product</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :delivery_schedule</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e5f0eab211128bdc1fcce9cd3256130db80822df">
  <div class="header">
    <h3>app/models/promotion.rb</h3>
    <h4><span class="red">69.23 %</span> covered</h4>
    <div>
      <b>26</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Promotion &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  extend DragonflyBackgroundResize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :product, inverse_of: :promotions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :market, inverse_of: :promotions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :title, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :market, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :product, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :one_active_per_market, if: &quot;market.present? &amp;&amp; active?&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  dragonfly_accessor :image</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  define_after_upload_resize(:image, 1200, 1200)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_property :format, of: :image, in: %w(jpeg png gif)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :active, -&gt; { where(active: true) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  def featureable?(market, buyer, delivery)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    inventory = product.available_inventory(delivery.deliver_on)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    product.prices.any? {|price| price.for_market_and_organization?(market, buyer) &amp;&amp; price.min_quantity &lt;= inventory }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.promotions_for_user(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    if user.admin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      market_ids = user.markets.map(&amp;:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      where(market_id: market_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  def one_active_per_market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    if (self.persisted? &amp;&amp; market.promotions.active.where.not(id: id).any?) ||</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">       (self.new_record? &amp;&amp; market.promotions.active.any?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      errors.add(:active, &quot;There can only be one active promotion per market&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="0b8e25199e4ada04358ea4aff98aec0dcd26d12a">
  <div class="header">
    <h3>app/models/registration.rb</h3>
    <h4><span class="red">44.83 %</span> covered</h4>
    <div>
      <b>29</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Registration</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include ActiveModel::Model</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :market,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">                :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">                :contact_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">                :email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">                :password,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">                :password_confirmation,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">                :address_label,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">                :address,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">                :city,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">                :state,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">                :zip,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">                :phone,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">                :fax,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">                :buyer,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">                :seller,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">                :user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">                :organization,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">                :terms_of_service</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :market, :name, :contact_name, :address,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">            :city, :state, :zip, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :terms_of_service, acceptance: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    if valid?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      self.organization = Organization.new(organization_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      organization.markets = [market]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      organization.locations.build(location_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      organization.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      # create the user second so we have the organization available</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      # to the confirmation email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      self.user = User.find_by(email: email) || User.new(user_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      user.organizations &lt;&lt; organization</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      user.attempt_set_password(user_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      user.invitation_token=nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def organization_params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      name: name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      can_sell: (seller == &quot;1&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      allow_credit_cards: market.default_allow_credit_cards,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      allow_purchase_orders: market.default_allow_purchase_orders,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      allow_ach: market.default_allow_ach</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def user_params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      name: contact_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      email: email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      password: password,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      password_confirmation: password_confirmation,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      terms_of_service: terms_of_service</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def location_params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      name: address_label || &quot;Default Address&quot;, # if nil, Default Address</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      address: address,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      city: city,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      state: state,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      zip: zip,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      phone: phone,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      fax: fax</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  # Stub methods for Devise::Model::Validatable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.validates_uniqueness_of(*_args)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  def email_changed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  include Devise::Models::Validatable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="fd10ecfe6f989458ffc0550d4c28f353475af99b">
  <div class="header">
    <h3>app/models/sequence.rb</h3>
    <h4><span class="red">33.33 %</span> covered</h4>
    <div>
      <b>12</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Sequence &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.increment_for(name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    sequence = find_or_create_by!(name: name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    find_by_sql([&quot;UPDATE sequences SET value = value + 1 WHERE id=? RETURNING value&quot;, sequence.id]).first.value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  rescue ActiveRecord::RecordNotUnique</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    retry</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.decrement_for(name, value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    sequence = find_by!(name: name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    if(sequence.value == value.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      find_by_sql([&quot;UPDATE sequences SET value = value - 1 WHERE id=? RETURNING value&quot;, sequence.id]).first.value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.set_value_for!(name, value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    find_or_create_by(name: name).update_attributes!(value: value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="17011d2e8bb228d2df047e467b0a63b07cf01d59">
  <div class="header">
    <h3>app/models/subscription.rb</h3>
    <h4><span class="red">70.59 %</span> covered</h4>
    <div>
      <b>17</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Subscription &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include SoftDelete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :subscription_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  before_create do |sub|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    sub.token = SecureRandom.hex(32).upcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.unsubscribe_by_token(token)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    if token and subscription = Subscription.find_by(token: token)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      return subscription.soft_delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.ensure_user_has_subscription_link_to(user, subscription_type_keyword:)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="20">
          <span class="hits">16</span>
          
          <code class="ruby">    if user.subscription_types.where(keyword: subscription_type_keyword).count == 0</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="21">
          <span class="hits">16</span>
          
          <code class="ruby">      if sub_type = SubscriptionType.find_by(keyword: subscription_type_keyword)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        user.subscription_types &lt;&lt; sub_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.ensure_user_has_subscription_links_to_fresh_sheet_and_newsletter(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    [ SubscriptionType::Keywords::FreshSheet,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      SubscriptionType::Keywords::Newsletter </code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="31">
          <span class="hits">8</span>
          
          <code class="ruby">    ].each do |keyword|</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="32">
          <span class="hits">16</span>
          
          <code class="ruby">      Subscription.ensure_user_has_subscription_link_to(user, subscription_type_keyword: keyword)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e64251f9f113262be1de8425cce3cb81476e4880">
  <div class="header">
    <h3>app/models/subscription_type.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class SubscriptionType &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Keywords</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    FreshSheet = &quot;fresh_sheet&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    Newsletter = &quot;newsletter&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :subscriptions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :users, through: :subscriptions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="4a7d923c20db2b57a1c5524b804ad23f5e2e2f87">
  <div class="header">
    <h3>app/models/twitter_user.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>7</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class TwitterUser</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.dump(value)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="3">
          <span class="hits">17</span>
          
          <code class="ruby">    clean_username(value.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.load(value)</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="7">
          <span class="hits">35</span>
          
          <code class="ruby">    value.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.clean_username(username)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="11">
          <span class="hits">17</span>
          
          <code class="ruby">    username.sub(/^@/, &quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="663b79d7a1f8e6453bbc613242cd2c0950dd0e3a">
  <div class="header">
    <h3>app/models/unit.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Unit &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :for_display, -&gt; { order(:plural) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="0e5f82fe4ec822a3ad073ce032e2b8868f51340f">
  <div class="header">
    <h3>app/models/user.rb</h3>
    <h4><span class="red">50.0 %</span> covered</h4>
    <div>
      <b>220</b> relevant lines. 
      <span class="green"><b>110</b> lines covered</span> and
      <span class="red"><b>110</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class User &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include PgSearch</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include Sortable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  include Util::TrimText</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # Include default devise modules. Others available are:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # :lockable, :timeoutable and :omniauthable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  devise :invitable, :database_authenticatable, :registerable,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">         :recoverable, :rememberable, :trackable, :validatable,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">         :confirmable, :masqueradable, :timeoutable, :omniauthable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  trimmed_fields :email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :managed_markets_join, class_name: &quot;ManagedMarket&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  #has_many :audits</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  before_create do |user|</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="19">
          <span class="hits">8</span>
          
          <code class="ruby">    if user.subscription_types.empty?</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="20">
          <span class="hits">8</span>
          
          <code class="ruby">      Subscription.ensure_user_has_subscription_links_to_fresh_sheet_and_newsletter(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # prefer Market.managed_by(user) over (user.admin? ? Market.all : user.managed_markets)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :managed_markets, through: :managed_markets_join, source: :market do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    def can_manage_organization?(org)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      joins(:organizations).where(organizations: {id: org.id}).exists?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :user_organizations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :organizations, -&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    not_deleted.</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="35">
          <span class="hits">19</span>
          
          <code class="ruby">    where(user_organizations: {enabled: true}).distinct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  }, through: :user_organizations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :organizations_including_suspended, -&gt; {</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="39">
          <span class="hits">10</span>
          
          <code class="ruby">    not_deleted.distinct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  }, through: :user_organizations, source: :organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :suspended_organizations, -&gt; { where(user_organizations: {enabled: false}) }, through: :user_organizations, source: :organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :carts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :subscriptions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :subscription_types, through: :subscriptions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :terms_of_service</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :terms_of_service, acceptance: true, on: :create</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="52">
          <span class="hits">12</span>
          
          <code class="ruby">  validates :name, presence: true, if: -&gt; { name.present? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  pg_search_scope :search_by_name_and_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">                  against: {name: &quot;A&quot;, email: &quot;B&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">                  using: {tsearch: {prefix: true}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :sort, method: :for_sort, ignore_blank: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  scope_accessible :search, method: :for_search, ignore_blank: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :buyers, -&gt; { joins(:organizations).merge(Organization.buying) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :sellers, -&gt; { joins(:organizations).merge(Organization.selling) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :in_market, -&gt;(market) {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    market_id = case market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">                when Market</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">                  market.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">                else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">                  market.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    joins(organizations: :market_organizations).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    where(market_organizations: {market_id: market_id}).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    merge(MarketOrganization.visible)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  # TODO: this needs a spec if we&#39;re to bring it in:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  # scope :managing_market, -&gt;(market) {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  #   market_id = case market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  #               when Market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  #                 market.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  #               else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  #                 market.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  #               end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  #   joins(:managed_markets).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  #   where(managed_markets: {market_id: market_id})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  # }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :subscribed_to, -&gt;(subscription) {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    where_opts = case subscription</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">             when SubscriptionType</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">               {subscription_types: {id: subscription.id}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">             when Fixnum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">               {subscription_types: {id: subscription}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">             else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">               {subscription_types: {keyword: subscription.to_s}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">             end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    joins(subscriptions: :subscription_type).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    where(where_opts).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    merge(Subscription.visible)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.with_primary_market(market)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    User.all.select {|u| u.primary_market == market }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.arel_column_for_sort(column_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">    if column_name == &quot;email&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">      arel_table[:email]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">      arel_table[:name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">  def member_of_organization?(target)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">    target &amp;&amp; user_organizations.find { |o| o.organization_id == target.id } != nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">  def active_subscriptions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">    subscriptions.visible</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">  def active_subscription_types</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">    subscription_types.merge(Subscription.visible)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">  def subscribe_to(s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    keyword = case s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">              when SubscriptionType</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">                s.keyword</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">                s.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">    st = SubscriptionType.find_by(keyword: keyword)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    raise &quot;No SubscriptionType found for keyword #{keyword.inspect}&quot; unless st</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">    if sub = subscriptions.find_by(subscription_type: st)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">      sub.undelete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">      subscription_types &lt;&lt; st</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">    active_subscription_types</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">  def unsubscribe_from(s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">    keyword = case s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">              when SubscriptionType</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">                s.keyword</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">                s.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    st = SubscriptionType.find_by(keyword: keyword)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">    raise &quot;No SubscriptionType found for keyword #{keyword.inspect}&quot; unless st</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">    if sub = subscriptions.find_by(subscription_type: st)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">      sub.soft_delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">    active_subscription_types</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">  def unsubscribe_token(subscription_type:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    subscription_type_id = subscription_type.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    subscriptions.each.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">      select { |s| s.subscription_type_id == subscription_type_id }.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      first.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      try(:token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">  def affiliations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">    @affiliations ||= begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">      collection = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">      collection += managed_markets</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">      collection += organizations_including_suspended.order(name: :asc).select {|o| o.has_market? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">      collection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="178">
          <span class="hits">1</span>
          
          <code class="ruby">  def terms_of_service=(terms_of_service)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">    @terms_of_service = terms_of_service</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    @accepted_terms_of_service_at = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_search(query)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">    search_by_name_and_email(query)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_auth_token(token)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">    return if token.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">    hsh = auth_token_verifier.verify(token)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">    User.find_by(id: hsh[:id]) if hsh[:expires] &gt; Time.now.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">  rescue ActiveSupport::MessageVerifier::InvalidSignature</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.auth_token_verifier</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">    Rails.application.message_verifier(:user_auth_token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">  def auth_token(expires_in=1.hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    self.class.auth_token_verifier.generate(a: rand(100), id: id, expires: expires_in.from_now.to_i, b: rand(100))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="204">
          <span class="hits">1</span>
          
          <code class="ruby">  def admin?</code>
        </li>
      
        <li class="covered" data-hits="229" data-linenumber="205">
          <span class="hits">229</span>
          
          <code class="ruby">    role == &quot;admin&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_manage?(resource)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">    self.send(&quot;can_manage_#{resource.class.name.underscore}?&quot;, resource)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="212">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_manage_organization?(org)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">    admin? || managed_organizations.include?(org)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_manage_market?(market)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="217">
          <span class="hits">12</span>
          
          <code class="ruby">    admin? || managed_markets.all.include?(market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_manage_user?(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">    admin? || user.organizations_including_suspended.any? {|org| can_manage_organization?(org) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">  def enabled_for_organization?(org)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">    user_organizations.find_by(organization: org).try(:enabled?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">  def suspended_from_all_orgs?(market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">    # return if organizations.nil?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="230">
          <span class="hits">3</span>
          
          <code class="ruby">    return if market.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="232">
          <span class="hits">3</span>
          
          <code class="ruby">    (market.organizations &amp; organizations).empty? &amp;&amp; !(market.organizations &amp; suspended_organizations).empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">  def market_manager?</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="236">
          <span class="hits">30</span>
          
          <code class="ruby">    managed_markets.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">  def seller?</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="240">
          <span class="hits">13</span>
          
          <code class="ruby">    organizations.selling.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="243">
          <span class="hits">1</span>
          
          <code class="ruby">  def admin_or_mm?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">    market_manager? || admin?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">  def buyer_only?</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="248">
          <span class="hits">36</span>
          
          <code class="ruby">    !admin? &amp;&amp; !market_manager? &amp;&amp; !seller?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_seller_with_purchase?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">    seller? &amp;&amp; Order.where(organization_id: organization_ids).exists?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_localeyes_buyer? # this really aligns with procurement_manager role and should probably be refactored when that is complete.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="256">
          <span class="hits">1</span>
          
          <code class="ruby">    intersect = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">    localeyes_mkts = markets.joins(:plan).where(&quot;has_procurement_managers = &#39;t&#39;&quot;).all</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="258">
          <span class="hits">2</span>
          
          <code class="ruby">    intersect = managed_organizations.select{|o| o.can_sell? == false} &amp; localeyes_mkts.flat_map{|lm| lm.organizations}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="259">
          <span class="hits">1</span>
          
          <code class="ruby">    return intersect.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="262">
          <span class="hits">1</span>
          
          <code class="ruby">  def managed_organizations(opts={})</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="263">
          <span class="hits">45</span>
          
          <code class="ruby">    defaults = {include_suspended: false}</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="264">
          <span class="hits">45</span>
          
          <code class="ruby">    opts = defaults.merge!(opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="266">
          <span class="hits">45</span>
          
          <code class="ruby">    org_membership_scope = opts[:include_suspended] ? organizations_including_suspended : organizations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="268">
          <span class="hits">45</span>
          
          <code class="ruby">    @managed_organizations ||= {include_suspended: {true =&gt; nil, false =&gt; nil}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="270">
          <span class="hits">45</span>
          
          <code class="ruby">    @managed_organizations[:include_suspended][opts[:include_suspended]] ||= Organization.managed_by_market_ids(ids_for_managed_organizations).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">      where(market_organizations: {deleted_at: nil}).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">      where.not(market_organizations: {id: nil}).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">      union(org_membership_scope).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">      joins(:market_organizations).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">      distinct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="278">
          <span class="hits">1</span>
          
          <code class="ruby">  def managed_organizations_including_cross_sellers(opts={})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">    defaults = {include_suspended: false}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">    opts = defaults.merge!(opts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">    org_membership_scope = opts[:include_suspended] ? organizations_including_suspended : organizations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">    @managed_organizations_including_cross_sellers ||= {include_suspended: {true =&gt; nil, false =&gt; nil}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">    @managed_organizations_including_cross_sellers[:include_suspended][opts[:include_suspended]] ||= Organization.all_for_market_ids(ids_for_managed_organizations).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">      where(market_organizations: {deleted_at: nil}).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">      where.not(market_organizations: {id: nil}).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">      union(org_membership_scope).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">      joins(:market_organizations).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      distinct.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">      order(:name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="295">
          <span class="hits">1</span>
          
          <code class="ruby">  def managed_organizations_including_deleted</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">    if admin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">      Organization.all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">      market_ids = managed_markets_join.map(&amp;:market_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">      Organization.managed_by_market_ids(market_ids).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">        union(organizations).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">        joins(:market_organizations).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">        order(:name).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">        distinct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="309">
          <span class="hits">1</span>
          
          <code class="ruby">  def managed_organization_ids_including_deleted</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">    managed_organizations_including_deleted.map(&amp;:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="313">
          <span class="hits">1</span>
          
          <code class="ruby">  def managed_organizations_within_market_including_crossellers(market)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">    if admin? || market.length &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">      market.each do |m|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">        result = m.organizations.extending(MarketOrganization::AssociationScopes).excluding_deleted.mo_join_market_id(m)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">        if @r</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">          @r = @r + result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">          @r = result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">      @r.uniq.sort_by{|e| e[:name]}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">      organizations.extending(MarketOrganization::AssociationScopes).joins(:market_organizations).excluding_deleted.mo_join_market_id(market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="329">
          <span class="hits">1</span>
          
          <code class="ruby">  def managed_organizations_within_market(market)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="330">
          <span class="hits">16</span>
          
          <code class="ruby">    if admin? || managed_markets.include?(market)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="331">
          <span class="hits">12</span>
          
          <code class="ruby">      market.organizations.extending(MarketOrganization::AssociationScopes).excluding_deleted.not_cross_selling.mo_join_market_id(market.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="333">
          <span class="hits">4</span>
          
          <code class="ruby">      organizations.extending(MarketOrganization::AssociationScopes).joins(:market_organizations).excluding_deleted.not_cross_selling.mo_join_market_id(market.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="337">
          <span class="hits">1</span>
          
          <code class="ruby">  def multi_organization_membership?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="338">
          <span class="hits">1</span>
          
          <code class="ruby">    return @multi_organization_membership if defined?(@multi_organization_membership)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="339">
          <span class="hits">1</span>
          
          <code class="ruby">    @multi_organization_membership = managed_organizations.count &gt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">  # shortcut for grabbing the &quot;primary&quot; market for things like email layout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">  # when we don&#39;t know. We can make this more intelligent later.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">  # confirmation email needs the organizations bit.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="345">
          <span class="hits">1</span>
          
          <code class="ruby">  def primary_market</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">    admin? ? nil : markets.order(:created_at).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="349">
          <span class="hits">1</span>
          
          <code class="ruby">  def markets</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">    @markets ||= if admin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">      Market.all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="353">
          <span class="hits">5</span>
          
          <code class="ruby">      markets_for_non_admin</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="354">
          <span class="hits">6</span>
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="357">
          <span class="hits">1</span>
          
          <code class="ruby">  def multi_market_membership?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">    markets.count &gt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="361">
          <span class="hits">1</span>
          
          <code class="ruby">  def managed_products</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">    org_ids = managed_organizations.map(&amp;:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">    Product.visible.seller_can_sell.where(organization_id: org_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="366">
          <span class="hits">1</span>
          
          <code class="ruby">  def buyers_for_select</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">    for_select = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">    markets.each do |m|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">      by_market = m.organizations.map {|o| [o.name, o.id] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">      for_select |= (by_market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">    for_select.sort {|a, b| a[0] &lt;=&gt; b[0] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="375">
          <span class="hits">1</span>
          
          <code class="ruby">  def markets_for_select</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">    for_select = markets.map do |m|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">      [m.name, m.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">    for_select.sort {|a, b| a[0] &lt;=&gt; b[0] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="382">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_import_password_reset_instructions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">    raw, enc = Devise.token_generator.generate(self.class, :reset_password_token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">    self.reset_password_token   = enc</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">    self.reset_password_sent_at = Time.now.utc + 3.weeks # 4 week expiration for imported users</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">    save(validate: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">    if !Rails.env.staging?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">      send_devise_notification(:reset_import_password_instructions, raw, {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">    elsif email == &quot;anna+manager@localorb.it&quot; || email == &quot;chris.rittersdorf+buyer@collectiveidea.com&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">      send_devise_notification(:reset_import_password_instructions, raw, {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">    raw</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="397">
          <span class="hits">1</span>
          
          <code class="ruby">  def pretty_email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">    &quot;#{name.to_s.inspect} &lt;#{email}&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="401">
          <span class="hits">1</span>
          
          <code class="ruby">  def default_market</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">    if admin?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby">      admin_market = markets.select do |m| m.subdomain == &quot;admin&quot; end.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">      if admin_market</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">        admin_market</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">        markets.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">      markets.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="414">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_confirmed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="415">
          
          
          <code class="ruby">    confirmed_at != nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="418">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_invited?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="419">
          
          
          <code class="ruby">    invitation_token != nil &amp;&amp; confirmed_at == nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="422">
          <span class="hits">1</span>
          
          <code class="ruby">  def attempt_set_password(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">    p = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby">    p[:password] = params[:password]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">    p[:password_confirmation] = params[:password_confirmation]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="426">
          
          
          <code class="ruby">    update_attributes(p)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="429">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="431">
          <span class="hits">1</span>
          
          <code class="ruby">  def markets_for_non_admin</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="432">
          <span class="hits">5</span>
          
          <code class="ruby">    managed_market_ids = managed_markets.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="434">
          <span class="hits">5</span>
          
          <code class="ruby">    organization_member_market_ids = organizations.map(&amp;:all_market_ids).flatten</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="435">
          <span class="hits">5</span>
          
          <code class="ruby">    Market.where(id: (managed_market_ids + organization_member_market_ids))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="438">
          <span class="hits">1</span>
          
          <code class="ruby">  def ids_for_managed_organizations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby">    @ids ||= begin</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="440">
          <span class="hits">19</span>
          
          <code class="ruby">      if admin?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="441">
          <span class="hits">12</span>
          
          <code class="ruby">        Market.all.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">      elsif market_manager?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="443">
          
          
          <code class="ruby">        managed_markets_join.map(&amp;:market_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="445">
          <span class="hits">27</span>
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5c36890f87b7331f1b02acb68da270f8e930f3cc">
  <div class="header">
    <h3>app/models/user_organization.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class UserOrganization &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  audited allow_mass_assignment: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2607de79e6bd874cb1d120893a224984cc3914da">
  <div class="header">
    <h3>app/presenters/buyer_order_presenter.rb</h3>
    <h4><span class="red">69.57 %</span> covered</h4>
    <div>
      <b>23</b> relevant lines. 
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class BuyerOrderPresenter</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include Search::DateFormat</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include Search::MarketAndOrganization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_reader :start_date, :end_date, :query</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(user, market, request_params={}, query=nil)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="7">
          <span class="hits">3</span>
          
          <code class="ruby">    @user   = user</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="8">
          <span class="hits">3</span>
          
          <code class="ruby">    @market = market</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="9">
          <span class="hits">3</span>
          
          <code class="ruby">    @request_params = request_params</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="10">
          <span class="hits">3</span>
          
          <code class="ruby">    @query = Search::QueryDefaults.new(query[:q] || {}, &#39;placed_at&#39;).query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="12">
          <span class="hits">3</span>
          
          <code class="ruby">    @start_date = format_date(@query[&quot;placed_at_date_gteq&quot;.to_s])</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="13">
          <span class="hits">3</span>
          
          <code class="ruby">    @end_date = format_date(@query[&quot;placed_at_date_lteq&quot;.to_s])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def template</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="17">
          <span class="hits">3</span>
          
          <code class="ruby">    if @user.admin?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="18">
          <span class="hits">3</span>
          
          <code class="ruby">      &quot;admin&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    elsif @user.market_manager?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      &quot;market_manager&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    elsif @user.seller?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      &quot;seller&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      &quot;buyer&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def pending_orders</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    # TODO: Should scope by pending seller payment once payments are implemented</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    @pending_orders ||= Order.orders_for_seller(@user).periscope(@request_params).order(&quot;placed_at DESC&quot;).limit(15)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def upcoming_deliveries</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    @upcoming_deliveries ||= @market.upcoming_deliveries_for_user(@user).periscope(@request_params).decorate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="c6f05c0045a5643d00160d01187d9ba9322c3b5e">
  <div class="header">
    <h3>app/presenters/market_search_presenter.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class MarketSearchPresenter</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include Search::DateFormat</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include Search::MarketAndOrganization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_reader :start_date, :end_date, :query</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(query, user, date_search_attr=nil)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    @query = Search::QueryDefaults.new(query[:q] || {}, date_search_attr).query</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    @user = user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    @start_date = format_date(@query[&quot;#{date_search_attr}_date_gteq&quot;.to_s])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    @end_date = format_date(@query[&quot;#{date_search_attr}_date_lteq&quot;.to_s])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="07db43b1544874d05f2837a99275682f49b00905">
  <div class="header">
    <h3>app/presenters/order_presenter.rb</h3>
    <h4><span class="red">54.17 %</span> covered</h4>
    <div>
      <b>24</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module OrderPresenter</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include TotalsPresenter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.included(base)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    base.class_eval do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :items</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      delegate :id, :delivery, :billing_organization_name, :billing_address, :billing_city,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">               :billing_state, :billing_zip, :billing_phone, :delivery_address, :delivery_city,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">               :delivery_state, :delivery_zip, :delivery_fees,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">               :invoice_due_date, :invoiced_at, :invoiced?, :market, :notes, :order_number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">               :organization, :payment_method, :payment_note, :payment_status, :placed_at,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">               to: :@order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def grouped_items</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @items.group_by do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      item.seller_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  # todo add method to determine what order item id is THE order item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  # then controller will do the order item find</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # save it in an instance variable in the show route so it can be rendered</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  # inst variable that can be passed into that view</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # which should then be renderable in the modal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # hitting order item controller edit method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  # in that controller, there would be a method to </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  # call the show in the orderitems controller with that id that you get via edit link</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  # add show -- that does find by id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  # basically puts in @order_item that would be used in the view for rendering the modal form</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # so basically that edit link calls the route for the show in order_item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  # maybe write an edit also? can show edit them? it should go to the modal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  # define a custom order_edit route </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  # is in routes -- orders/order_items</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  # should be able to validate this route with a view renderable in orders that references the order_item route when modal form is rendered</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  def display_delivery_fees?(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    user.admin? || user.market_manager? || user.buyer_only?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  def buyer_payment_status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    @order.payment_status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    @order.errors</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def items_attributes=(_)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def refund?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    [&quot;ach&quot;, &quot;credit card&quot;].include?(@order.payment_method) &amp;&amp; refund_for_changes &amp;&amp; refund_for_changes &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  def refund_for_changes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    @refund_for_changes ||= begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      if @order.audits.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        total_cost_update = @order.audits.last.audited_changes[&quot;total_cost&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        if total_cost_update.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">          total_cost_update[0] - total_cost_update[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="9662f19389d7771cd51b1b026ec3b7149e4d2697">
  <div class="header">
    <h3>app/presenters/seller_order.rb</h3>
    <h4><span class="red">40.0 %</span> covered</h4>
    <div>
      <b>40</b> relevant lines. 
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>24</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class SellerOrder</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include ActiveModel::Model</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include DeliveryStatus</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include OrderPresenter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :display_delivery_or_pickup,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    :display_delivery_address,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    :delivery_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    :delivery_status,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    :organization_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    :credit,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    :sellers,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    :errors,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    to: :@order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_reader :seller</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(order, seller)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @order = order.decorate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    @seller = seller</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    if @seller.is_a?(User)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      @items = order.items.select(&quot;order_items.*&quot;).joins(:product).where(&quot;products.organization_id&quot; =&gt; @seller.managed_organization_ids_including_deleted).order(&quot;order_items.name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    elsif @seller.is_a?(Organization)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      @items = order.items.select(&quot;order_items.*&quot;).joins(:product).where(&quot;products.organization_id&quot; =&gt; @seller.id).order(&quot;order_items.name&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.find(seller, id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    order = Order.orders_for_seller(seller).find(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    new(order, seller)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def credit_amount_visible_to_current_seller</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    if credit.paying_org == nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      if credit.amount_type == &quot;fixed&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        (@order.credit_amount / (@order.sellers.count || 1)).round 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        (gross_total / @order.gross_total * @order.credit_amount).round 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    elsif credit.paying_org == @seller || (@seller.is_a?(User) &amp;&amp; @seller.member_of_organization?(credit.paying_org))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      # When a user belongs to more than one organization that are on the order,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      # the display will be confusing because they won&#39;t know which organization</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      # is paying the credit.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      @order.credit_amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  def credit_amount</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    if credit_paid_by_sellers?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      credit_amount_visible_to_current_seller</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  def total_cost</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    if credit_amount &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      gross_total - discount - credit_amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      gross_total - discount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  def items_attributes=(_)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  def delivery_fees</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  def seller_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    @seller.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  def credit_paid_by_sellers?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    @order.credit_amount &gt; 0 &amp;&amp; credit.payer_type == Credit::ORGANIZATION</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f7d3ceea3da3b12510721a44416b1b0e25aee488">
  <div class="header">
    <h3>app/presenters/totals_presenter.rb</h3>
    <h4><span class="red">29.27 %</span> covered</h4>
    <div>
      <b>41</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>29</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module TotalsPresenter</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def discount</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    totals[:discount]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def discount_seller</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    totals[:discount_seller]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def discount_market</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    totals[:discount_market]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def gross_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    totals[:gross]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def net_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    totals[:net]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def payment_fees</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    totals[:payment]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def transaction_fees</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    totals[:transaction]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def market_fees</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    totals[:market]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def discounted_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    totals[:discounted_total]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  def delivery_fees</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    totals[:delivery]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def totals</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    return @totals if @totals</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    @totals = {discount: 0, discount_seller: 0, gross: 0, discounted_total: 0, transaction: 0, net: 0, payment: 0, market: 0, delivery: 0}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    @order_ids = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    non_cancelled_items = items.where(&quot;order_items.delivery_status != &#39;canceled&#39;&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    non_cancelled_items.each do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      @order_ids.push(item.order_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      @totals[:discount]    += item.discount</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      @totals[:gross]       += item.gross_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      @totals[:discounted_total] += item.discounted_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      @totals[:net]         += item.seller_net_total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    if self.instance_of?(SellerOrder)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      @totals[:net] = @totals[:net] - credit_amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    @totals[:discount_seller] = non_cancelled_items.sum(:discount_seller)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    @totals[:discount_market] = non_cancelled_items.sum(:discount_market)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    @totals[:transaction] = non_cancelled_items.sum(:local_orbit_seller_fee)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    @totals[:payment] = non_cancelled_items.sum(:payment_seller_fee)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    @totals[:market] = non_cancelled_items.sum(:market_seller_fee)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    @totals[:delivery] = Order.where(id: @order_ids.uniq).sum(:delivery_fees)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    @totals</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="31d1497423a9595722cacb04f10d24ea1309ac13">
  <div class="header">
    <h3>lib/constraints/non_market_domain.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class NonMarketDomain</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def matches?(request)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="3">
          <span class="hits">15</span>
          
          <code class="ruby">    subdomain = request.subdomains(Figaro.env.domain.count(&quot;.&quot;)).try(:first)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="4">
          <span class="hits">15</span>
          
          <code class="ruby">    request.host != Figaro.env.domain &amp;&amp; subdomain != &quot;app&quot; &amp;&amp; !market_exists?(subdomain)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  def market_exists?(subdomain)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="8">
          <span class="hits">15</span>
          
          <code class="ruby">    Market.where(subdomain: SimpleIDN.to_unicode(subdomain)).exists?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e462a8e3204d76e0bd1754415ef64e83e7902163">
  <div class="header">
    <h3>lib/devise/strategies/token_auth.rb</h3>
    <h4><span class="red">60.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Devise</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Strategies</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class TokenAuth &lt; Authenticatable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">      def valid?</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="5">
          <span class="hits">32</span>
          
          <code class="ruby">        params[:auth_token].present? &amp;&amp; mapping.to.respond_to?(:for_auth_token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      def authenticate!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">        # if the authentication header is an acceptible value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        if (resource = mapping.to.for_auth_token(params[:auth_token]))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">          env[&quot;devise.skip_storage&quot;] = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">          success!(resource, &quot;success&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">          fail(:not_found_in_database)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b2e45e97ae71dccef403a9b7241e9b9e65a35ce3">
  <div class="header">
    <h3>lib/dragonfly_background_resize.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module DragonflyBackgroundResize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # Sets up a background task to resize the upload to a suitable max size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # Optionally setup smaller images to generate after upload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # accessor: the main dragonfly attachment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # max_width: used to resize upload if needed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # max_height: used to resize upload if needed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # thumbs: hash of dimension hashes to define the smaller images that should be generated off this image</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # example:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # define_after_upload_resize(:photo, 1200, 1200, photo_small: {width: 150, height: 150})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def define_after_upload_resize(accessor, max_width, max_height, thumbs={})</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="13">
          <span class="hits">5</span>
          
          <code class="ruby">    class_eval &lt;&lt;-EOS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      around_save :post_process_#{accessor}, prepend: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      def resize_#{accessor}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        return true unless #{accessor}.width &gt; #{max_width} || #{accessor}.height &gt; #{max_height}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        self.#{accessor} = #{accessor}.thumb(&#39;#{max_width}x#{max_height}&gt;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        save(validate: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      def post_process_#{accessor}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        if #{accessor}_changed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">          yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">          if #{accessor}_stored? &amp;&amp; (#{accessor}.width &gt; #{max_width} || #{accessor}.height &gt; #{max_height})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">            delay.resize_#{accessor}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">          yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    EOS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="34">
          <span class="hits">5</span>
          
          <code class="ruby">    thumbs.each do |thumb_accessor, dimensions|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      class_eval &lt;&lt;-EOS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        around_save :generate_#{thumb_accessor}_for_#{accessor}, prepend: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        def generate_#{thumb_accessor}_from_#{accessor}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          self.#{thumb_accessor} = #{accessor}.thumb(&#39;#{dimensions[:width]}x#{dimensions[:height]}&gt;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          save(validate: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">        def generate_#{thumb_accessor}_for_#{accessor}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">          if #{accessor}_changed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">            self.#{thumb_accessor} = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">            yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">            # We have an image and it doesn&#39;t need to be resized</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">            if #{accessor}_stored? &amp;&amp; !(#{accessor}.width &gt; #{max_width} || #{accessor}.height &gt; #{max_height})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">              delay.generate_#{thumb_accessor}_from_#{accessor}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">            yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      EOS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5a1368d77a95813fbe9b624ad4e92a8cb6b411ce">
  <div class="header">
    <h3>lib/event_tracker.rb</h3>
    <h4><span class="red">52.0 %</span> covered</h4>
    <div>
      <b>25</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>12</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">module EventTracker</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  cattr_accessor :capture_events, :previously_captured_events</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  self.previously_captured_events = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  self.capture_events = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # EVENT TYPES</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  EventType = Struct.new(:name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  ViewedOrder             = EventType.new(&quot;viewed-order&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  ViewedInvoices          = EventType.new(&quot;viewed-invoices&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  DownloadedPackingLabels = EventType.new(&quot;downloaded-packing-labels&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  DownloadedPosters       = EventType.new(&quot;downloaded-posters&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  DownloadedTableTents    = EventType.new(&quot;downloaded-table-tents&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  PreviewedBatchInvoices  = EventType.new(&quot;previewed-batch-invoices&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # METHODS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.track_event_for_user(user, event, metadata={})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    if(self.capture_events)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      self.previously_captured_events &lt;&lt; {user: user, event: event, metadata: metadata}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        self.find_or_create_user!(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        Intercom::Event.create event_name: event, created_at: Time.now.to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">          metadata: metadata, email: user.email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      rescue Exception =&gt; ex</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        puts ex.message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        puts ex.backtrace.join(&quot;\n&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        Honeybadger.notify_or_ignore(ex,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">          context: {user: user.inspect, event: event, metadata: metadata})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.find_or_create_user!(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      intercom_record_of_user = Intercom::User.find(email: user.email)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    rescue Intercom::ResourceNotFound</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      intercom_record_of_user = Intercom::User.create(email: user.email)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    intercom_record_of_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a83a1a4e7893e6e56f5b7872b082d0c2edad746d">
  <div class="header">
    <h3>lib/feature_access.rb</h3>
    <h4><span class="red">48.78 %</span> covered</h4>
    <div>
      <b>41</b> relevant lines. 
      <span class="green"><b>20</b> lines covered</span> and
      <span class="red"><b>21</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">class FeatureAccess</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    def stripe_standalone?(market:)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="5">
          <span class="hits">3</span>
          
          <code class="ruby">      market.stripe_standalone</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    def order_templates?(market:)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="9">
          <span class="hits">8</span>
          
          <code class="ruby">      market.plan.name == &quot;LocalEyes&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    def can_edit_order?(user:, order:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      return (user.admin? || user.managed_markets.include?(order.market))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    def order_printables?(user:, order:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      market = order.market</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      user_belongs_to_market = user.markets.include?(market)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      user_organization_bought_order = user.organizations.include?(order.organization)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      can_view = (user.admin? or (user_belongs_to_market and market.plan.order_printables and (user.can_manage_market?(market) or user_organization_bought_order)))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    def packing_labels?(user_delivery_context:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      return true if user_delivery_context.is_admin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      return (user_delivery_context.packing_labels_feature and (user_delivery_context.is_seller or user_delivery_context.is_market_manager))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    def master_packing_slips?(user_delivery_context:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      (user_delivery_context.is_admin or user_delivery_context.is_market_manager)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    def edit_ordered_quantity?(user_order_item_context:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      return false if !user_order_item_context.delivery_pending</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      edit_order_stuff?(user_order_item_context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    def edit_delivered_quantity?(user_order_item_context:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      edit_order_stuff?(user_order_item_context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    def delete_order_item?(user_order_item_context:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      return false if !user_order_item_context.delivery_pending</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      edit_order_stuff?(user_order_item_context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    def order_action_links?(user_order_context:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      edit_order_stuff?(user_order_context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_order_items?(user_order_context:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      edit_order_stuff?(user_order_context)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">    def sellers_edit_orders_feature_available?(market:)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="56">
          <span class="hits">2</span>
          
          <code class="ruby">      !!market.plan.try(:sellers_edit_orders?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    def has_procurement_managers?(market:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      !!market.plan.try(:has_procurement_managers?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    def edit_order_stuff?(context)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      return true if context.is_admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      return true if context.is_market_manager</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      return true if context.is_seller &amp;&amp; context.sellers_edit_orders_feature</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      return true if context.is_localeyes_buyer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f67aee6c518d4c17173c04281cbcac499e10477f">
  <div class="header">
    <h3>lib/financials.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">module Financials</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="dca1943c128a974f10b34b789c16455343fab874">
  <div class="header">
    <h3>lib/financials/payment_executor.rb</h3>
    <h4><span class="red">24.24 %</span> covered</h4>
    <div>
      <b>33</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>25</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Financials</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  class PaymentExecutor</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    cattr_accessor :capture_payments, :previously_captured_payments</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    self.previously_captured_payments = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    self.capture_payments = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">      def execute_credit(payment: nil, payment_attributes: nil, description: nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        if payment.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">          if payment_attributes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">            payment = Payment.create!(payment_attributes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">            raise &quot;Must provide either :payment or :payment_attributes keyword arg&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">          if capture_payments</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">            previously_captured_payments &lt;&lt; {payment:payment, description:description}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">            return payment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">          if bank_account = payment.bank_account</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">            if balanced_uri = payment.bank_account.balanced_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">              balanced_account = Balanced::BankAccount.find(balanced_uri)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">              credit = balanced_account.credit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">                amount:                  Financials::MoneyHelpers.amount_to_cents(payment.amount),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">                appears_on_statement_as: payment.market.try(:on_statement_as),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">                description:             description</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">              )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">              # Amend the Payment record with a link to the Balanced transaction:</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">              payment.update_column(:balanced_uri, credit.uri)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">              handle_payment_error payment, &quot;BankAccount not linked to a Balanced account: balanced_uri not set&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">            handle_payment_error payment, &quot;No BankAccount associated with this Payment&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          payment</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        rescue Exception =&gt; e </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">          handle_payment_error payment, e.message, e.try(:category_code)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">          payment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">      def handle_payment_error(payment, error_message, category_code=nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        note = &quot;ERROR: #{error_message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        if category_code</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">          note = &quot;#{note} - Error Code: #{category_code}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">          if payment.note.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">            note = &quot;#{payment.note} - #{note}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        payment.update_columns(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">          status: &quot;failed&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">          note:   note</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          </code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2145744d58fb0b37255d224f07bc9060525687a6">
  <div class="header">
    <h3>lib/import_legacy_taxonomy.rb</h3>
    <h4><span class="green">92.11 %</span> covered</h4>
    <div>
      <b>38</b> relevant lines. 
      <span class="green"><b>35</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &quot;csv&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Import the taxonomy tree from a csv export</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># of the legacy taxonomy data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">class ImportLegacyTaxonomy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.run(filename, opts={})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    new(filename, opts).run</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(filename, opts={})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    @filename       = filename</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    @by_cat_id      = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    @base_nodes     = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    @verbose        = opts[:verbose]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    @original_count = Category.count if @verbose</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def run</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    load_taxonomy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    build_tree</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="21">
          <span class="hits">4</span>
          
          <code class="ruby">    store_tree(@base_nodes.sort_by {|n| n[:order_by].to_i }, Category.root || Category.create!(name: &quot;All&quot;))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    finish</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    if @verbose</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      puts &quot;#{@original_count} Exisiting Categories&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      puts &quot;Created #{Category.count - @original_count} new Categories.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      puts &quot;There were #{@by_cat_id.size} rows detected in the import file&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_taxonomy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    CSV.foreach(@filename, headers: true) do |row|</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="33">
          <span class="hits">74</span>
          
          <code class="ruby">      next if row[&quot;cat_id&quot;] == &quot;1&quot; || row[&quot;parent_id&quot;] == &quot;1&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="35">
          <span class="hits">72</span>
          
          <code class="ruby">      @by_cat_id[row[&quot;cat_id&quot;]] = {name: row[&quot;cat_name&quot;], children: [], parent_id: row[&quot;parent_id&quot;], order_by: row[&quot;order_by&quot;]}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def build_tree</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    @by_cat_id.each_value do |node|</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="41">
          <span class="hits">72</span>
          
          <code class="ruby">      if parent = @by_cat_id[node[:parent_id]]</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="42">
          <span class="hits">69</span>
          
          <code class="ruby">        parent[:children] &lt;&lt; node</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="44">
          <span class="hits">3</span>
          
          <code class="ruby">        @base_nodes &lt;&lt; node</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="48">
          <span class="hits">4</span>
          
          <code class="ruby">    @base_nodes.reject! {|node| node[:parent_id] != &quot;2&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  def store_tree(nodes, parent=nil)</code>
        </li>
      
        <li class="covered" data-hits="73" data-linenumber="52">
          <span class="hits">73</span>
          
          <code class="ruby">    nodes.each do |node|</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="53">
          <span class="hits">72</span>
          
          <code class="ruby">      obj = parent.children.find_or_initialize_by(name: node[:name])</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="54">
          <span class="hits">72</span>
          
          <code class="ruby">      obj.save!</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="55">
          <span class="hits">72</span>
          
          <code class="ruby">      print &quot;.&quot; if @verbose</code>
        </li>
      
        <li class="covered" data-hits="141" data-linenumber="56">
          <span class="hits">141</span>
          
          <code class="ruby">      store_tree(node[:children].sort_by {|n| n[:name] }, obj)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  def finish</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    Category.rebuild! # needed to set proper depths</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">    puts &quot;&quot; if @verbose</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ecb41e8ff4bcfb4601a42dfeb41e82033492af31">
  <div class="header">
    <h3>lib/interactor_ext.rb</h3>
    <h4><span class="yellow">87.5 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Interactor</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def require_in_context(*names)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    context_keys = context.keys</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    names.each do |name|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="5">
          <span class="hits">5</span>
          
          <code class="ruby">      if !context_keys.include?(name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">        raise &quot;Interactor #{self.class.name} requires #{name.inspect} but it wasn&#39;t found in context.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    names.map do |name|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="10">
          <span class="hits">5</span>
          
          <code class="ruby">      self.send(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="fae6a37d5b44f85a58285805d9d00493e153ee0b">
  <div class="header">
    <h3>lib/orders/delivery_status_logic.rb</h3>
    <h4><span class="red">52.63 %</span> covered</h4>
    <div>
      <b>19</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Orders</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class DeliveryStatusLogic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">      ValidDeliveryStatuses = OrderItem::DELIVERY_STATUSES</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      # Delivered: All items are Delivered (perhaps some canceled)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      # Pending: All items are Pending (perhaps some canceled)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      # canceled: All items canceled</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      # Partially Delivered: Some items Delivered, some items Pending (perhaps some canceled)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      # Contested: One or more items are Contested</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      # Contested, Partially Delivered: Some items Contested, some items Delivered, some items Pending</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">      def overall_status(statuses)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="13">
          <span class="hits">3</span>
          
          <code class="ruby">        items = ValidDeliveryStatuses &amp; statuses.map(&amp;:to_s).map(&amp;:downcase).uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="15">
          <span class="hits">3</span>
          
          <code class="ruby">        if items.length == 1</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="16">
          <span class="hits">3</span>
          
          <code class="ruby">          return items.first </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        items -= [&quot;canceled&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        if items.length == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">          return items.first </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        partial = %w(pending delivered)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        if partial == (partial &amp; items)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">          return &#39;partially delivered&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        return &quot;unknown&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      def human_readable(status)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        status.to_s.titleize</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      def overall_status_for_order(order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        overall_status order.items.map(&amp;:delivery_status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b88e8970d515f0eddd2d6775412c5d2a76422d27">
  <div class="header">
    <h3>lib/packing_labels/generator.rb</h3>
    <h4><span class="red">14.81 %</span> covered</h4>
    <div>
      <b>27</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>23</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module PackingLabels</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class Generator</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">      def generate(orders:,request:,product_labels_only:,product_label_format:,print_multiple_labels_per_item:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">        order_infos = PackingLabels::OrderInfo.make_order_infos(orders:orders, host: request.base_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">        # [ </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">        #   { order_number: .... }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">        #   { order_number: .... }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">        #   { order_number: .... }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">        # ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">        labels = PackingLabels::Label.make_labels(order_infos, product_labels_only, product_label_format, print_multiple_labels_per_item)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">        # [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">        #   { template: &quot;...&quot;, data: { ... } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">        #   { template: &quot;...&quot;, data: { ... } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        # ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        pages = PackingLabels::Page.make_pages(labels, product_label_format)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">          # [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">          #   {a: {label} b: {label} ... }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">          #   {a: {label} b: {label} ... }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">          #   {a: {label} b: {label} ... }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">          # ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        if product_label_format == 4</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          label_template = &#39;avery_labels/labels_4&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        elsif product_label_format == 16</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">          label_template = &#39;avery_labels/labels_16&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        if product_label_format &gt; 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">          TemplatedPdfGenerator.generate_pdf(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">            request: request,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">            template: label_template,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">            pdf_settings: TemplatedPdfGenerator::ZeroMargins.merge(page_size: &quot;letter&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">            locals: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">              params: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">                pages: pages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        else # generate ZPL for 1-up label</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          a = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">          pages.each do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">            order_url = Rails.application.routes.url_helpers.qr_code_url(host: request.base_url, id: page[:a][:data][:order][:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">            order_num_font_size = ((25 - (page[:a][:data][:order][:order_number].length/25))*2).round</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">            buyer_font_size = ((36 - (page[:a][:data][:order][:buyer_name].length/5.5))*2).round</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">            if page[:a][:data][:product].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">              a &lt;&lt; [&quot;^XA^FX^CF0,#{buyer_font_size}^FO50,50^FB500,2,,^FD#{page[:a][:data][:order][:buyer_name]}^FS^CF0,30^FO50,150^FDDeliver On:^FS^CF0,60^FO50,175^FD#{page[:a][:data][:order][:deliver_on]}^FS^CF0,30^FO50,250^FDOrder #:^FS^CF0,#{order_num_font_size}^FO50,275^FB500,2,,^FD#{page[:a][:data][:order][:order_number]}^FS^FO50,425^GB500,1,3^FS^FX^FO400,570^BXN,7,200^FD#{order_url}^FS^FO50,550#{page[:a][:data][:order][:zpl_logo]}^FS^XZ&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">              if print_multiple_labels_per_item</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">                qty_str = &quot;^PQ#{page[:a][:data][:product][:quantity].round}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">                qty_str = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">              producer_font_size = ((36 - (page[:a][:data][:product][:producer_name].length/5.5))*2).round</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">              product_font_size = ((36 - (page[:a][:data][:product][:product_name].length/5.5))*2).round</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">              product_detail_font_size = ((25 - ((page[:a][:data][:product][:unit_desc].length + page[:a][:data][:product][:lot_desc].length)/25))*2).round</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">              a &lt;&lt; [&quot;^XA^FX^CF0,#{product_font_size}^FO50,50^FB500,2,,^FD#{page[:a][:data][:product][:product_name]}^FS^CF0,50^FO50,165^FD#{page[:a][:data][:product][:product_code]}^FS^CF0,#{product_detail_font_size}^FO50,220^FD#{page[:a][:data][:product][:unit_desc]}, #{page[:a][:data][:product][:lot_desc]}^FS^FO50,275^GB500,1,3^FS^FX^CF0,#{producer_font_size}^FO50,300^FD#{page[:a][:data][:product][:producer_name]}^FS^FX^CF0,30^FO50,380^FDDeliver On:^FS^CF0,50^FO50,405^FD#{page[:a][:data][:order][:deliver_on]}^FS^CF0,30^FO50,475^FDOrder #:^FS^CF0,#{order_num_font_size}^FO50,500^FB500,2,,^FD#{page[:a][:data][:order][:order_number]}^FS^CF0,30^FO50,590^FDBuyer:^FS^CF0,#{buyer_font_size}^FO50,615^FD#{page[:a][:data][:order][:buyer_name]}^FS^FX^FO400,770^BXN,7,200^FD#{order_url}^FS^FO50,750#{page[:a][:data][:order][:zpl_logo]}^FS#{qty_str}^XZ&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">          a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="3d5696ed0d2ac5c269f03f601554458bf78d5085">
  <div class="header">
    <h3>lib/payment_provider.rb</h3>
    <h4><span class="red">62.26 %</span> covered</h4>
    <div>
      <b>53</b> relevant lines. 
      <span class="green"><b>33</b> lines covered</span> and
      <span class="red"><b>20</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module PaymentProvider</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  Implementations = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">    stripe: PaymentProvider::Stripe,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">    balanced: PaymentProvider::Balanced</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    def for_new_markets</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">      if ENV[&#39;USE_BALANCED_FOR_NEW_MARKETS&#39;] == &#39;YES&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        PaymentProvider::Balanced</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="12">
          <span class="hits">2</span>
          
          <code class="ruby">        PaymentProvider::Stripe</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    def for(payment_provider)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="17">
          <span class="hits">16</span>
          
          <code class="ruby">      raise &quot;No PaymentProvider... payment_provider can&#39;t be nil&quot; if payment_provider.nil?</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="18">
          <span class="hits">16</span>
          
          <code class="ruby">      impl = Implementations[payment_provider.to_sym]</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="19">
          <span class="hits">16</span>
          
          <code class="ruby">      return impl if impl</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      raise &quot;No PaymentProvider for #{payment_provider.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    def is_balanced?(payment_provider)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="24">
          <span class="hits">3</span>
          
          <code class="ruby">      return false if payment_provider.nil?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="25">
          <span class="hits">3</span>
          
          <code class="ruby">      PaymentProvider::Balanced.id == payment_provider.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    def supports_payment_method?(payment_provider, payment_method)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="29">
          <span class="hits">16</span>
          
          <code class="ruby">      PaymentProvider.for(payment_provider).supported_payment_methods.include?(payment_method)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    def can_add_payment_method?(payment_provider, payment_method)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).addable_payment_methods.include?(payment_method)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    def can_add_credit_card_payment_method?(payment_provider)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      can_add_payment_method?(payment_provider, &quot;credit card&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    def can_add_ach_payment_method?(payment_provider)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      can_add_payment_method?(payment_provider, &quot;ach&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    def approximate_credit_card_rate(payment_provider)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).approximate_credit_card_rate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    def default_currency_for_country(payment_provider, country)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).default_currency_for_country(country)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    # Common PaymentProvide interface:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    def place_order(payment_provider, buyer_organization:, user:, order_params:, cart:, request:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).place_order(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">        buyer_organization: buyer_organization,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">        user: user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">        order_params: order_params,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        cart: cart, request: request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    def translate_status(payment_provider, charge:, amount:nil, payment_method:nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).translate_status(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        charge: charge,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        amount: amount,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        payment_method: payment_method)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    def charge_for_order(payment_provider, amount:, bank_account:, market:, order:, buyer_organization:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).charge_for_order(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">                          amount: amount,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">                          bank_account: bank_account,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">                          market: market,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">                          order: order,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">                          buyer_organization: buyer_organization)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    def fully_refund(payment_provider, charge: nil, payment:, order:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).fully_refund(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        charge: charge,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        payment: payment,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        order: order)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    def store_payment_fees(payment_provider, order:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).store_payment_fees(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        order: order)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    def create_order_payment(payment_provider, charge:, market_id:, bank_account:, payer:,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">                             payment_method:, amount:, order:, status:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).create_order_payment(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        charge: charge,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        market_id: market_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        bank_account: bank_account,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        payer: payer,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">        payment_method: payment_method,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        amount: amount,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        order: order,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        status: status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">    def create_refund_payment(payment_provider, charge:, market_id:, bank_account:, payer:,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">                                  payment_method:, amount:, order:, status:, refund:, parent_payment:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).create_refund_payment(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        charge: charge,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        market_id: market_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        bank_account: bank_account,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">        payer: payer,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        payment_method: payment_method,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        amount: amount,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">        order: order,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        status: status,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        refund: refund,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        parent_payment: parent_payment)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">    def find_charge(payment_provider, payment:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).find_charge(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        payment: payment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    def refund_charge(payment_provider, charge:, amount:, order:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).refund_charge(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        charge: charge,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">        amount: amount,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">        order: order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_payment_method(payment_provider, entity:, type:, bank_account_params:, representative_params:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).add_payment_method(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        entity: entity,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">        type: type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">        bank_account_params: bank_account_params,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        representative_params: representative_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">    def add_deposit_account(payment_provider, entity:, type:, bank_account_params:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).add_deposit_account(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">        entity: entity,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">        type: type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">        bank_account_params: bank_account_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">    def select_usable_bank_accounts(payment_provider, bank_accounts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).select_usable_bank_accounts(bank_accounts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">    def remove_unused_bank_accounts(payment_provider, account)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      PaymentProvider.for(payment_provider).remove_unused_bank_accounts(account)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e6f477e8126827db4f734301f02809722e60a13b">
  <div class="header">
    <h3>lib/payment_provider/balanced.rb</h3>
    <h4><span class="red">41.3 %</span> covered</h4>
    <div>
      <b>46</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>27</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module PaymentProvider</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class Balanced</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="4">
          <span class="hits">4</span>
          
          <code class="ruby">      def id; :balanced; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      def supported_payment_methods</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">        [ &quot;credit card&quot;, &quot;ach&quot; ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">      def addable_payment_methods</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">        supported_payment_methods #XXX</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">        # TODO []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      def place_order(buyer_organization:, user:, order_params:, cart:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        PlaceOrder.perform(payment_provider: PaymentProvider::Balanced.id, entity: buyer_organization, buyer: user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">                           order_params: order_params, cart: cart)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      def translate_status(charge:, amount:nil, payment_method:nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        if amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">          # ...happens during cart checkout</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">          if amount == 0 || payment_method == &quot;credit card&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">            &quot;paid&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">            &quot;pending&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">          # ...happens during update order</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">          case charge.try(:status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">          when &quot;pending&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">            &quot;pending&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">          when &quot;succeeded&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">            &quot;paid&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">            &quot;failed&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      def charge_for_order(amount:, bank_account:, market:, order:, buyer_organization:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        amount_in_cents = ::Financials::MoneyHelpers.amount_to_cents(amount)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        buyer_organization.balanced_customer.debit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">          amount: amount_in_cents,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">          source_uri: bank_account.balanced_uri,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">          description: &quot;#{market.name} purchase&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">          appears_on_statement_as: market.on_statement_as,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">          meta: {&#39;order number&#39; =&gt; order.order_number}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        ) </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      def fully_refund(charge:nil, payment:, order:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        charge ||= ::Balanced::Debit.find(payment.balanced_uri)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        charge.refund</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">      def store_payment_fees(order:)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">        # Intentional no-op for Balanced provider.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">      def create_order_payment(charge:, market_id:, bank_account:, payer:,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">                                  payment_method:, amount:, order:, status:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        Payment.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">          payment_provider: self.id.to_s,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          market_id: market_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">          bank_account: bank_account,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">          payer: payer,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">          payment_method: payment_method,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">          amount: amount,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">          payment_type: &#39;order&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">          orders: [order],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">          status: status,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">          balanced_uri: charge.try(:uri)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">      def create_refund_payment(charge:, market_id:, bank_account:, payer:, payment_method:, amount:, order:, status:, refund:, parent_payment:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        Payment.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">          payment_provider: self.id.to_s,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">          market_id: market_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">          bank_account: bank_account,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">          payer: payer,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">          payment_method: payment_method,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">          amount: amount,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">          payment_type: &#39;order refund&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">          orders: [order],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">          parent_id: parent_payment.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">          status: status,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">          balanced_uri: refund.try(:uri)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">      def find_charge(payment:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        payment.balanced_transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">      def refund_charge(charge:, amount:, order:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        amount_in_cents = ::Financials::MoneyHelpers.amount_to_cents(amount)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        charge.refund(amount: amount_in_cents)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">      def add_payment_method(type:, entity:, bank_account_params:, representative_params:)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        # raise &quot;add_payment_method not implemented for PaymentProvider::Balanced!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">          entity: entity, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">          bank_account_params: bank_account_params, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">          representative_params: representative_params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        if type == &quot;card&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          AddBalancedCreditCardToEntity.perform(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">          AddBalancedBankAccountToEntity.perform(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">      def add_deposit_account(entity:, type:, bank_account_params:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">        raise &quot;Balanced provider doesn&#39;t implement the concept of Deposit Account!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">      def select_usable_bank_accounts(bank_accounts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">        bank_accounts.reject do |ba| ba.balanced_uri.nil? end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">      def approximate_credit_card_rate # should contain nothing and not raise error (till balanced fully removed)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">        &quot;0.00&quot; # tmp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="c0d91e30f87ab0a9611e2fbac6fd8c6b627255f0">
  <div class="header">
    <h3>lib/payment_provider/fee_estimator.rb</h3>
    <h4><span class="red">71.43 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module PaymentProvider</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module FeeEstimator</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    module Schema</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">      Cents = Integer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">      Rate  = BigDecimal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      BasePlusRate = RSchema.schema {{</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">        style: enum([:base_plus_rate]),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">        base: Cents,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">        rate: Rate</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      }}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">      FeeStructure = RSchema.schema { either(BasePlusRate) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      def estimate_payment_fee(fee_structure, amount_in_cents)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        SchemaValidation.validate!(FeeEstimator::Schema::FeeStructure, fee_structure)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        case fee_structure[:style]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        when :base_plus_rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">          fee_structure[:base] + (amount_in_cents * fee_structure[:rate]).round </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">          raise &quot;Cannot estimate fee on #{amount_in_cents} cents; fee structure style #{fee_structure[:style]} not supported.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="0ceced5f34b4d7de056011c0d55f3d3bbbf70f6c">
  <div class="header">
    <h3>lib/payment_provider/handlers/async_handler.rb</h3>
    <h4><span class="red">50.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module PaymentProvider</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Handlers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class AsyncHandler</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">      HANDLER_IMPLS = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">        &#39;transfer.paid&#39; =&gt; PaymentProvider::Handlers::TransferPaid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      def call(event)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">        handler = HANDLER_IMPLS[event.type]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        if handler</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">          params = handler.extract_job_params(event)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">          Rails.logger.info &quot;Enqueueing job for #{event.type} stripe event with params: #{params.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">          handler.delay.handle(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a695486fab59c7482eab572271450ff54363ca40">
  <div class="header">
    <h3>lib/payment_provider/handlers/transfer_paid.rb</h3>
    <h4><span class="red">38.46 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module PaymentProvider</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Handlers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class TransferPaid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.extract_job_params(event)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">          transfer_id: event.data.object.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">          amount_in_cents: event.data.object.amount,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">          stripe_account_id: event.user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.handle(transfer_id:, stripe_account_id:, amount_in_cents:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        if stripe_account_id and market = Market.where(stripe_account_id: stripe_account_id).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">          order_ids = PaymentProvider::Stripe.order_ids_for_market_payout_transfer(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">            transfer_id: transfer_id, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">            stripe_account_id: stripe_account_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">          payment = PaymentProvider::Stripe.create_market_payment(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">            transfer_id: transfer_id, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">            market: market, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">            order_ids: order_ids, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">            status: &#39;paid&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">            amount: ::Financials::MoneyHelpers.cents_to_amount(amount_in_cents))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          ::Financials::PaymentNotifier.market_payment_received(payment: payment, async: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">          nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">          transfer_id: transfer_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">          stripe_account_id: stripe_account_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">          amount_in_cents: amount_in_cents</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        error_info = ErrorReporting.interpret_exception(e, &quot;Error handling transfer.paid event from Stripe&quot;, {params: params})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        Honeybadger.notify_or_ignore(error_info[:honeybadger_exception])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a613e4ab53ce21a956778b6ed0ae7bf06ba715c9">
  <div class="header">
    <h3>lib/payment_provider/stripe.rb</h3>
    <h4><span class="red">32.05 %</span> covered</h4>
    <div>
      <b>156</b> relevant lines. 
      <span class="green"><b>50</b> lines covered</span> and
      <span class="red"><b>106</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module PaymentProvider</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class Stripe</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    DefaultCurrencies = {&#39;CA&#39; =&gt; &#39;CAD&#39;, &#39;US&#39; =&gt; &#39;USD&#39;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    CreditCardFeeStructure = SchemaValidation.validate!(FeeEstimator::Schema::BasePlusRate,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      style: :base_plus_rate,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      base:  30,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      rate:  BigDecimal.new(&quot;0.029&quot;) #{}&quot;0.029&quot;.to_d, # 2.9% of total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    TransferSchedule = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      delay_days:    5,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      interval:      &#39;weekly&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      weekly_anchor: &#39;wednesday&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    module CardSchema</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      Base = RSchema.schema {{</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        name: String,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        bank_name: String,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        account_type: String,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        last_four: String,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        expiration_month: String,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        expiration_year: String,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        _?(:notes) =&gt; String,</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      }}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      SubmittedParams = RSchema.schema do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">        Base.merge(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">          _?(:id) =&gt; String,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">          _?(:save_for_future) =&gt; String,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">          :stripe_tok =&gt; String</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      NewParams = RSchema.schema do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">        Base.merge(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">          _?(:stripe_id) =&gt; String,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          _?(:deleted_at) =&gt; Time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="45">
          <span class="hits">4</span>
          
          <code class="ruby">      def id; :stripe; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">      def supported_payment_methods</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="48">
          <span class="hits">16</span>
          
          <code class="ruby">        [ &quot;credit card&quot; ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      def addable_payment_methods</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        [ &quot;credit card&quot; ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      def place_order(buyer_organization:, user:, order_params:, cart:, request:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        PlaceStripeOrder.perform(payment_provider: self.id.to_s,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">                                 entity: buyer_organization,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">                                 buyer: user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">                                 order_params: order_params,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">                                 cart: cart, request: request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">      def translate_status(charge:, amount:nil, payment_method:nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        if charge.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">          if amount == 0 and payment_method == &quot;credit card&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">            # Sigh.  The overarching payment processing scheme is to treat CC payments of $0.00 as instantly &quot;paid&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">            # without actually executing a transaction with the provider...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">            return &quot;paid&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">            # ...but generally, missing charge is a sign of failure:</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">            return &quot;failed&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">        case charge.status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">        when &#39;pending&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">          &#39;pending&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        when &#39;succeeded&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">          &#39;paid&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">          &#39;failed&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">      def default_currency_for_country(country)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        if (DefaultCurrencies[country])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">          DefaultCurrencies[country]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">          raise ArgumentError, &quot;#{country} is not a supported country.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">      def charge_for_order(amount:, bank_account:, market:, order:, buyer_organization:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        amount_in_cents = ::Financials::MoneyHelpers.amount_to_cents(amount)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        customer = buyer_organization.stripe_customer_id || raise(&quot;Can&#39;t create a charge; Organization #{buyer_organization.name} (#{buyer_organization.id}) has no stripe_customer_id&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        source = bank_account.stripe_id || raise(&quot;Can&#39;t create a charge; BankAccount #{bank_account.bank_name} #{bank_account.last_four} (#{bank_account.id}) has no stripe_id&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        destination = market.stripe_account_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        descriptor = market.on_statement_as</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        fee_in_cents = PaymentProvider::FeeEstimator.estimate_payment_fee CreditCardFeeStructure, amount_in_cents</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        # TODO: once we support ACH via Stripe, this branch will be needed for an alternate estimate of ACH fees:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        # fee_in_cents = if bank_account.credit_card?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">        #                  estimate_credit_card_processing_fee_in_cents(amount_in_cents)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        #                else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        #                  estimate_ach_processing_fee_in_cents(amount_in_cents)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        #                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        metadata = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          market: market.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">          market_id: market.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">          order_number: order.order_number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">          order_id: order.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          buyer_organization: buyer_organization.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">          buyer_organization_id: buyer_organization.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">          bank_account_id: bank_account.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">          market_stripe_account: market.stripe_account_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">        charge_params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">          amount: amount_in_cents,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">          currency: self.default_currency_for_country(market.country).downcase,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">          source: source,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">          customer: customer,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">          destination: destination,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">          statement_descriptor: descriptor,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">          application_fee: fee_in_cents,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">          description: &quot;Charge for #{order.order_number}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">        if destination.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">          data = { charge_params: charge_params, metadata: metadata }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">          message = &quot;Can&#39;t create a Stripe charge! Market &#39;#{market.name}&#39; (#{market.id}) has no Stripe Account.  #{data.to_json}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">          raise message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">        charge = ::Stripe::Charge.create(charge_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">        # Pin some order metadata on the Stripe::Payment object that appears in the managed account:</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">        transfer = ::Stripe::Transfer.retrieve(charge.transfer)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">        payment = ::Stripe::Charge.retrieve(transfer.destination_payment, {stripe_account: transfer.destination})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">        payment[&quot;metadata&quot;][&quot;lo.order_id&quot;] = order.id.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">        payment[&quot;metadata&quot;][&quot;lo.order_number&quot;] = order.order_number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">        payment.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">        return charge</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      rescue ::Stripe::StripeError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">        data = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">          error_json_body: e.json_body,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">          charge_params: charge_params,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">          metadata: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">            market: market.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">            market_id: market.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">            order_number: order.order_number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">            order_id: order.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">            buyer_organization: buyer_organization.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">            buyer_organization_id: buyer_organization.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">            bank_account_id: bank_account.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">            market_stripe_account: market.stripe_account_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">        new_message = &quot;(Status #{e.http_status}) #{e.message} #{data.to_json}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">        new_err = ::Stripe::StripeError.new(new_message, e.http_status, e.http_body, data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">        new_err.set_backtrace(e.backtrace)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">        raise new_err</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">      def fully_refund(charge:nil, payment:, order:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">        charge ||= ::Stripe::Charge.retrieve(payment.stripe_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">        charge.refunds.create(refund_application_fee: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">                              reverse_transfer: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">                              metadata: { &#39;lo.order_id&#39; =&gt; order.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">                                          &#39;lo.order_number&#39; =&gt; order.order_number })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">      def store_payment_fees(order:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">        total_fee = order.payments.where(payment_type: &#39;order&#39;).sum(:stripe_payment_fee)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">        total_fee_cents = ::Financials::MoneyHelpers.amount_to_cents(total_fee)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">        fees = distribute_fee_amongst_order_items(total_fee_cents, order)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">        fee_payer = order.market.credit_card_payment_fee_payer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">        order.items.each do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">          fee_cents = fees[item.id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">          fee = if fee_cents.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">                  0.to_d</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">                else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">                  ::Financials::MoneyHelpers.cents_to_amount(fee_cents)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">          item.update :&quot;payment_#{fee_payer}_fee&quot; =&gt; fee</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">      def create_order_payment(charge:, market_id:, bank_account:, payer:,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">                                  payment_method:, amount:, order:, status:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">        stripe_id = if charge then charge.id else nil end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">        Payment.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">          payment_provider: self.id.to_s,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">          market_id: market_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">          bank_account: bank_account,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">          payer: payer,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">          payment_method: payment_method,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">          amount: amount,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">          payment_type: &#39;order&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">          orders: [order],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">          status: status,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">          stripe_id: stripe_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">          stripe_payment_fee: get_stripe_application_fee_for_charge(charge)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="212">
          <span class="hits">1</span>
          
          <code class="ruby">      def create_refund_payment(charge:, market_id:, bank_account:, payer:,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">                                    payment_method:, amount:, order:, status:, refund:, parent_payment:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">        stripe_id = charge ? charge.id : nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">        stripe_refund_id = refund ? refund.id : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">        payment = Payment.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">          payment_provider: self.id.to_s,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">          market_id: market_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">          bank_account: bank_account,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">          payer: payer,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">          payment_method: payment_method,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">          amount: amount,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">          payment_type: &#39;order refund&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">          orders: [order],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">          parent_id: parent_payment.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">          status: status,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">          stripe_id: stripe_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">          stripe_refund_id: stripe_refund_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">        parent_payment.update stripe_payment_fee: get_stripe_application_fee_for_charge(charge)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">        return payment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">      def find_charge(payment:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">        ::Stripe::Charge.retrieve(payment.stripe_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">      def refund_charge(charge:, amount:, order:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">        amount_in_cents = ::Financials::MoneyHelpers.amount_to_cents(amount)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">        charge.refunds.create(refund_application_fee: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">                              reverse_transfer: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">                              amount: amount_in_cents,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">                              metadata: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">                                &#39;lo.order_id&#39; =&gt; order.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">                                &#39;lo.order_number&#39; =&gt; order.order_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">                              })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">        # TODO: If refund fails - might be due to trying to apply refund against a standalone account, after conversion from managed. Need to trap and use legacy account instead</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="252">
          <span class="hits">1</span>
          
          <code class="ruby">      def add_payment_method(type:, entity:, bank_account_params:, representative_params:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">        if type == &quot;card&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">          AddStripeCreditCardToEntity.perform(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">            entity: entity,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">            bank_account_params: bank_account_params,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">            representative_params: representative_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">          raise &quot;PaymentProvider::Stripe doesn&#39;t support adding payment methods of type #{type.inspect}; only &#39;card&#39; supported currently.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="264">
          <span class="hits">1</span>
          
          <code class="ruby">      def add_deposit_account(entity:, type:, bank_account_params:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">        if type == &#39;checking&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">          AddStripeDepositAccountToMarket.perform(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">            entity: entity,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">            bank_account_params: bank_account_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">          raise &quot;PaymentProvider::Stripe only supports adding Deposit Accounts of type &#39;checking&#39;; dunno what to do with this type: #{type.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="274">
          <span class="hits">1</span>
          
          <code class="ruby">      def approximate_credit_card_rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">        CreditCardFeeStructure[:rate] # should be decimal value 0.029, see above</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">      # NON-PaymentProvider interface:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="283">
          <span class="hits">1</span>
          
          <code class="ruby">      def create_customer(customer_data)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="284">
          <span class="hits">1</span>
          
          <code class="ruby">        ::Stripe::Customer.create(customer_data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_stripe_customer(stripe_customer_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">        ::Stripe::Customer.retrieve(stripe_customer_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="291">
          <span class="hits">1</span>
          
          <code class="ruby">      def create_stripe_card_for_stripe_customer(stripe_customer:nil,stripe_customer_id:nil, stripe_tok:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">        customer = stripe_customer || ::Stripe::Customer.retrieve(stripe_customer_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">        credit_card = customer.sources.create(source: stripe_tok)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">        credit_card</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="297">
          <span class="hits">1</span>
          
          <code class="ruby">      def order_ids_for_market_payout_transfer(transfer_id:, stripe_account_id:)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">        order_ids = enumerate_transfer_transactions(transfer_id: transfer_id, stripe_account_id: stripe_account_id).map do |transaction|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">          if metadata = transaction.try(:source).try(:metadata)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">            order_id = metadata[&#39;lo.order_id&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">            order_id.to_i unless order_id.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">        order_ids.compact.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="308">
          <span class="hits">1</span>
          
          <code class="ruby">      def create_market_payment(transfer_id:, market:, order_ids:, status:, amount:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">        Payment.create!(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">          payment_provider: self.id.to_s,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">          payment_type:   amount &lt; 0 ? &quot;lo fee&quot; : &quot;market payment&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">          amount:         amount,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">          status:         status,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">          stripe_transfer_id: transfer_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">          market:         market,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">          payee:          market,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">          bank_account:   market.deposit_account,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">          orders:         Order.where(id: order_ids),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">          payment_method: &quot;ach&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="323">
          <span class="hits">1</span>
          
          <code class="ruby">      def select_usable_bank_accounts(bank_accounts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">        bank_accounts.reject do |ba| ba.stripe_id.nil? end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="327">
          <span class="hits">1</span>
          
          <code class="ruby">      def remove_unused_bank_accounts(stripe_account)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">        account = ::Stripe::Account.retrieve(stripe_account.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">        bank_accounts = account.bank_accounts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">        bank_accounts.each do |a|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">          if !a.default_for_currency</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">            del_result = a.delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">      # General Stripe getters</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="341">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_stripe_plans(plan = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="342">
          
          
          <code class="ruby">        if plan.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">          ::Stripe::Plan.all.data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">          ::Stripe::Plan.retrieve(plan.upcase)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="349">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_stripe_coupon(coupon)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">        ::Stripe::Coupon.retrieve(coupon)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="353">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_stripe_invoices(customer_filter = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">        ::Stripe::Invoice.all(customer_filter)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="357">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_stripe_account_status(acct)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">        ::Stripe::Account.retrieve(acct)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="361">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_stripe_balance(acct)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">        ::Stripe::Balance.retrieve(stripe_account: acct)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="365">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_stripe_balance_transactions(acct)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">        response = ::Stripe::BalanceTransaction.all({limit: 10}, {stripe_account: acct})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">        response.data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="370">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_stripe_charge_transactions(acct)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">        response = ::Stripe::Charge.all({limit: 10}, {stripe_account: acct})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">        response.data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="375">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_stripe_transfers(acct)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">        response = ::Stripe::Transfer.all({limit: 10}, {stripe_account: acct})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">        response.data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="380">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="382">
          <span class="hits">1</span>
          
          <code class="ruby">      def enumerate_transfer_transactions(transfer_id:, stripe_account_id:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">        response = ::Stripe::BalanceTransaction.all(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">          {limit: 100, type: &#39;payment&#39;, expand: [&#39;data.source&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">            transfer: transfer_id}, {stripe_account: stripe_account_id})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">        response.data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="391">
          <span class="hits">1</span>
          
          <code class="ruby">      def distribute_fee_amongst_order_items(total_fee_cents, order)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">        order_total_cents = ::Financials::MoneyHelpers.amount_to_cents(order.gross_total)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">        LargestRemainder.distribute_shares(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">          to_distribute: total_fee_cents,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">          total:         order_total_cents,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby">          items:         order.usable_items.inject({}) do |memo,item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">                           memo[item.id] = ::Financials::MoneyHelpers.amount_to_cents(item.gross_total)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">                           memo</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">                         end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="404">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_stripe_application_fee_for_charge(charge)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">        return &quot;0&quot;.to_d unless charge</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">        app_fee = ::Stripe::ApplicationFee.retrieve(charge.application_fee)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">        if app_fee</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">          ::Financials::MoneyHelpers.cents_to_amount(app_fee.amount - app_fee.amount_refunded)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">          &quot;0&quot;.to_d</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7ff61436d055397135b0317218206291aa862be4">
  <div class="header">
    <h3>lib/rschema_ext/either.rb</h3>
    <h4><span class="red">38.46 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module RSchema::DSL</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  EitherSchema = Struct.new(:subschemas) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    def schema_walk(value, mapper)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">      errors = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">      subschemas.each do |subschema|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">        value_walked, error = RSchema.walk(subschema, value, mapper)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">        if error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">          errors &lt;&lt; error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">          return value_walked</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      message = errors.map(&amp;:details).join(&quot;, AND &quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      return RSchema::ErrorDetails.new(message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.either(*subschemas)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    EitherSchema.new(subschemas)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="030be7edf78511d6e1efbfdecb4aa5bc740991a8">
  <div class="header">
    <h3>lib/rschema_ext/regexp.rb</h3>
    <h4><span class="red">33.33 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Regexp</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def schema_walk(value, mapper)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    value = value.to_str if value.respond_to?(:to_str)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    if value.is_a?(String) &amp;&amp; value =~ self</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">      return value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      return RSchema::ErrorDetails.new(&quot;is not a String matching #{self.inspect}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="df9f2258febe1ca99aad2d2a5e2118c8c4c9fabd">
  <div class="header">
    <h3>lib/schema_validation.rb</h3>
    <h4><span class="red">53.85 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class SchemaValidation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  cattr_accessor :validation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  self.validation = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.validate!(schema, object)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    if SchemaValidation.validation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      return RSchema.validate!(schema,object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      return object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.with_validation(on_off)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    prior = self.validation </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    self.validation = on_off</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      self.validation = prior</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="441fd0f1f96025e96d622f8781386cd1854f48dc">
  <div class="header">
    <h3>lib/search.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Search</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b8f3ae297f657b2adf839a4a766e24677792ea13">
  <div class="header">
    <h3>lib/search/date_format.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Search</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module DateFormat</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    def format_date(date_string)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="6">
          <span class="hits">8</span>
          
          <code class="ruby">      date_string.present? ? Date.parse(date_string) : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="bdf175fdc5f4c153e53caa3d84b89e9ee002c104">
  <div class="header">
    <h3>lib/search/market_and_organization.rb</h3>
    <h4><span class="red">33.33 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Search</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module MarketAndOrganization</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    def market_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">      @query[:market_id_in].to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    def selling_markets</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      @user.markets.order(:name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    def organization_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      @query[:organization_id_in].to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    def buyer_organizations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      if @filtered_market.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        result = @user.managed_organizations_within_market_including_crossellers(@filtered_market)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        result = @user.managed_organizations_including_cross_sellers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      if !result.is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        result.order(:name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    def seller_organizations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      if @filtered_organization.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        buyer_organizations.where(@filtered_organization)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      elsif buyer_organizations.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        buyer_organizations.where(can_sell: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        @user.managed_organizations.where(id: buyer_organizations.map(&amp;:id), can_sell:true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="cf9c4dc80395b5a17cda5d90f5616761e1a554e4">
  <div class="header">
    <h3>lib/search/query_defaults.rb</h3>
    <h4><span class="yellow">84.62 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Search</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  class QueryDefaults</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :query</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(q, date_search_attr)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="5">
          <span class="hits">4</span>
          
          <code class="ruby">      q = (q || {}).with_indifferent_access.deep_dup</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="6">
          <span class="hits">4</span>
          
          <code class="ruby">      query = {}.with_indifferent_access</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="8">
          <span class="hits">4</span>
          
          <code class="ruby">      if date_search_attr == :invoice_due_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">        query[&quot;#{date_search_attr}_date_gteq&quot;] = q.delete(&quot;#{date_search_attr}_date_gteq&quot;) || 30.days.ago.to_date.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        query[&quot;#{date_search_attr}_date_lteq&quot;] = q.delete(&quot;#{date_search_attr}_date_lteq&quot;) || 30.days.from_now.to_date.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="12">
          <span class="hits">4</span>
          
          <code class="ruby">        query[&quot;#{date_search_attr}_date_gteq&quot;] = q.delete(&quot;#{date_search_attr}_date_gteq&quot;) || 30.days.ago.to_date.to_s</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="13">
          <span class="hits">4</span>
          
          <code class="ruby">        query[&quot;#{date_search_attr}_date_lteq&quot;] = q.delete(&quot;#{date_search_attr}_date_lteq&quot;) || Date.today.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="15">
          <span class="hits">4</span>
          
          <code class="ruby">      query[&quot;order_market_id_eq&quot;] = q.delete(&quot;order_market_id_eq&quot;) unless q[&quot;order_market_id_eq&quot;].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # HACK:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      # Due to order of association loading with ransack, date filters for order</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      # items need to be loaded prior to other filters. To do this, we set them</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      # as the first keys in the query hash.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      # TODO: Find a better way to fix this.</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="22">
          <span class="hits">4</span>
          
          <code class="ruby">      @query = query.merge(q)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="4245d48787b0aff698d0ceef7d15b86c5276f948">
  <div class="header">
    <h3>lib/terms_of_service.rb</h3>
    <h4><span class="red">80.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module TermsOfService</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">	def self.url</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="3">
          <span class="hits">10</span>
          
          <code class="ruby">		&quot;http://localorbit.com/local-orbit-terms-of-service/&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">	def self.accept(user:,time:, ip_addr:)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">		user.update_attributes(accepted_terms_of_service_at:time,accepted_terms_of_service_from:ip_addr)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="656af73318b5e914fe9c673561cf60a660898738">
  <div class="header">
    <h3>lib/util/trim_text.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Util</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module TrimText</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.included base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">      base.extend(ClassMethods)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    module ClassMethods</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      # Register a before-validation handler for the given fields to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      # trim leading and trailing spaces.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      def trimmed_fields *field_list</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="12">
          <span class="hits">2</span>
          
          <code class="ruby">        before_validation do |model|</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="13">
          <span class="hits">28</span>
          
          <code class="ruby">          field_list.each do |n|</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="14">
          <span class="hits">28</span>
          
          <code class="ruby">            model[n] = model[n].strip if model[n].respond_to?(&#39;strip&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
      </div>
    </div>
  </body>
</html>
