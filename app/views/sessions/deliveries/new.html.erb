
<div class="row row--partial">
  <div class="column column--seven-twelfths">
    <%= form_tag [:sessions, :deliveries], method: :post, id: "deliveries" do |f| %>
      <%= hidden_field_tag :redirect_back_to, params[:redirect_back_to] %>

      <h1 class="clear-before">Welcome to <%= current_market.name %></h1>
      <p class="faux-label">Please choose a pick up or deliveryÂ date.</p>

    <% if not current_user.is_localeyes_buyer? %>
      <div class="row"><% @deliveries.each do |d| -%><div class="column column--guttered column--half">
          <div class="conditional field vcard delivery">
            <%= radio_button_tag "delivery_id", d.id %>
            <label for="delivery_id_<%= d.id %>">
              <span class="type"><%= d.type %></span><br>
              <span class="date"><%= d.buyer_display_date %></span><br>
              <span class="time-range"><%= d.buyer_time_range_capitalized %></span>
            </label>

            <% if d.display_locations.count > 1 %>
              <%= select_tag "location_id[#{d.id}]", options_from_collection_for_select(d.display_locations, "id", "address", current_organization.shipping_location.id), class: "mobile-block" %>
            <% else %>
              <%= content_tag_for :div, d.display_locations.first, class: "adr" do |location| %>
                <%= hidden_field_tag "location_id[#{d.id}]", location.id unless d.buyer_pickup? %>
                <span class="fn"><%= location.name %></span><br>
                <span class="street-address"><%= location.address %></span><br>
                <span class="locality"><%= location.city %></span>, <span class="region"><%= location.state %></span> <span class="postal-code"><%= location.zip %></span>
              <% end %>
            <% end %>
          </div>
        </div><%= cycle '', raw('</div><div class="row">') if d != @deliveries.last -%><%- end -%>
      </div>

    <% else %>

      <% delivery_weeks = [1,2,3,4] # always four weeks of arrays, just maybe different numbers%>
      <% week_days = [0,1,2,3,4,5,6] %> <!-- Sunday through Saturday -->

      <% start = @deliveries.first.buyer_deliver_on.wday %>
      <% last = @deliveries.first.buyer_deliver_on + 1.month %>
      <%= @deliveries.length %> <!-- to test -->
      <% first_week = Array.new(week_days.length) # don't actually want index, want day %>
      <% first_week.fill(0,start,start-6) %> <!-- won't (shouldn't) do anything if Sunday start -->
      <% first_week.fill(6-start, @deliveries.first.buyer_deliver_on.day, 1) # day, sequence by 1... this won't work %>
      <% delivery_weeks.fill(first_week) # temp, so all of them are the same as this first week will be. %>
      <% # divvy up the following remainder of the start till last into 7-day (0-6) arrays so delivery_weeks is the correct overall iterable (arr) %>

      <div class="l-main ">
        <section class="calendar" style="display: table;">
            <header style="display: table-row;">
              <div class="cal-date">S</div> <!-- never disabled -->
              <div class="cal-date">M</div>
              <div class="cal-date">T</div>
              <div class="cal-date">W</div>
              <div class="cal-date">T</div>
              <div class="cal-date">F</div>
              <div class="cal-date">S</div>
            </header>
          <% delivery_weeks.each do |w| %> <!-- the weeks included in the-->
            <div style="display: table-row;">
            <% w.each do |d| %>
              <div class="cal-date"><%= d %></div> <!-- should be d.day_number, check enabledness? -->
            <% end %>
            </div>
          <% end %>
        </section>
      </div>

    <% end %>

      <div class="form-actions">
        <%= submit_tag "Start Ordering", class: "mobile-block" %>
      </div>
    <% end %>
  </div>
</div>
