<div class="row row--partial">
  <div class="column column--eleven-twelfths">
    <h1><i class="font-icon" data-icon="&#xe022;"></i>&nbsp; Upcoming Deliveries</h1>

    <% if @pick_list_delivery_schedules.empty? %>
      <h2>You currently have no upcoming deliveries.</h2>
    <% else %>
      <p>Here is a list of all upcoming supplier deliveries and orders for your market.</p>

      <% @pick_list_delivery_schedules.each do |delivery_schedule| %>
        <% if not delivery_schedule.deliveries.empty? and not delivery_schedule.deliveries.future.empty? %>
          <% binding.pry %>
          <% all_deliveries = delivery_schedule.deliveries.future %>
          <% first_delivery = all_deliveries.first.decorate %>
          <div class="upcoming-delivery">
            <span class="market"><%= delivery_schedule.market.name %></span><br><br>
            <span>Drop-off begins:</span><br>
            <h2 class="upcoming-delivery-date"><%= first_delivery.upcoming_delivery_date_heading %></h2>
            <% if FeatureAccess.not_LE_market_manager?(user:current_user, market: current_market) %>
              Deliver to:
              <%= content_tag :div, first_delivery.deliver_to_name, class: "location-name" if first_delivery.deliver_to_name.present? %>
              <div class="location"><%= delivery_schedule.decorate.seller_fulfillment_address %></div>
            <% end %>

            <% dc = UserDeliveryContext.build(user: current_user, delivery: first_delivery) 
               access_master_packing_slips = FeatureAccess.master_packing_slips?(user_delivery_context: dc) && policy(:all_supplier).index?
               access_packing_labels = FeatureAccess.packing_labels?(user_delivery_context: dc)
               tool_count = 3
               tool_count += 1 if access_master_packing_slips
               tool_count += 2 if access_packing_labels
            %> 
          </div>
          <% else %>
          
          <% end %>

        <% end %>
      <% end %>   
      
      

<!--

    <% if @upcoming_deliveries.empty? %>
      <h2>You currently have no upcoming deliveries.</h2>
    <% else %>
      <p>This is a list of all upcoming deliveries for your market.</p>

      <% @upcoming_deliveries.each do |delivery| %>
        <div class="upcoming-delivery">
          <span class="market"><%= delivery.delivery_schedule.market.name %></span><br><br>
          <span>Delivery or Pick-up Begins:</span><br>
          <h2 class="upcoming-delivery-date"><%= delivery.upcoming_delivery_date_heading %></h2>
          <% if FeatureAccess.not_LE_market_manager?(user:current_user, market: current_market) %>
            Deliver to:
            <%= content_tag :div, delivery.deliver_to_name, class: "location-name" if delivery.deliver_to_name.present? %>
            <div class="location"><%= delivery.deliver_to_location %></div>
          <% end %>

          <% dc = UserDeliveryContext.build(user: current_user, delivery: delivery) 
             access_master_packing_slips = FeatureAccess.master_packing_slips?(user_delivery_context: dc) && policy(:all_supplier).index?
             access_packing_labels = FeatureAccess.packing_labels?(user_delivery_context: dc)
             tool_count = 3
             tool_count += 1 if access_master_packing_slips
             tool_count += 2 if access_packing_labels
          %>
          <div class="seller-tools toolbar" data-tools="<%= tool_count %>">
            <% if FeatureAccess.not_LE_market_manager?(user:current_user, market: current_market) %>
              <div class="tool"><%= link_to "Pick List", admin_delivery_tools_pick_list_path(delivery) %></div>
            <% end %>
            <% if access_master_packing_slips %>
              <div class="tool"><%= link_to "Master Packing Slips <span class='note'>for aggregation</span>".html_safe, admin_delivery_tools_pack_list_path(delivery) %></div>
            <% end %>
            <% if FeatureAccess.not_LE_market_manager?(user:current_user, market: current_market) %>
              <div class="tool"><%= link_to policy(:all_supplier).index? ? "Individual Packing Slips <span class='note'>per Supplier</span>".html_safe : "Packing Slips", admin_delivery_tools_individual_pack_list_path(delivery) %></div>
            <% end %>
            <div class="tool"><%= link_to "Order Summary", admin_delivery_tools_order_summary_path(delivery)%></div>
            <% if access_packing_labels %>
              <% target = if Rails.env.test? then "" else "_blank" end %>
                <div class="tool">
                    <%= link_to "Master Labels <span class='note'>per Order</span>".html_safe, admin_delivery_tools_delivery_packing_labels_path(delivery_id: delivery.id, product_only: false), class: "app-labels-link", target: target %>
                </div>
                <div class="tool">
                  <%= link_to "Individual Labels <span class='note'>per Product</span>".html_safe, admin_delivery_tools_delivery_packing_labels_path(delivery_id: delivery.id, product_only: true), class: "app-labels-link", target: target %>
                </div>
            <% end %>
          </div>
          <hr>
        </div>
      <% end %>
    <% end %>

-->

  </div>
</div>
