<%= render "admin/products/header" %>
<%= render "admin/products/tabs" %>
<%= form_for [:admin, @product, @price], html: { class: "row row--partial" } do |f| %>

  <%= product_listing_disclaimer %>

  <div class="column column--three-fourths">
    <%= render "shared/errors", {resource: @price} %>
    <%= render "shared/errors", {resource: @price_with_errors} if @price_with_errors %>

    <% if @product.prices.view_sorted.any? %>
      <%= link_to "Add Price", "#add-row", class: "btn btn--add btn--small pull-right add-toggle#{" is-hidden" if @price.errors.any?}" %>
      <h2 class="clear-after">Add Prices</h2>
      <p>These are your prices. Click on a field to edit it.</p>
      <p><%= button_tag "Delete Selected Prices", class: "btn delete delete-selected is-invisible" %></p>
    <% else %>
      <h2>Add Prices</h2>
      <p>You don't have any prices yet! We've gone ahead and started the entry for you.</p>
    <% end %>

    <%= content_tag :table, border: 0, id: 'pricing_table', data: edit_table_error_payload(@price_with_errors), class: "sortable" do %>
      <thead>
        <tr>
          <%= content_tag :th, raw('<input type="checkbox" class="select-all">') if @product.prices.view_sorted.any? %>
          <%= content_tag(:th, 'Market') if current_user.multi_market_membership? %>
          <th>Buyer</th>
          <th>Min Qty</th>
          <th>Net Price</th>
          <th>Sale Price</th>
          <th></th>
        </tr>

        <tr class="add-price price even <%= @product.prices.view_sorted.any? && @price.errors.none? ? "is-hidden" : "open-row" %>" id="add-row">
          <%= render 'form_row', f: f %>
        </tr>
      </thead>
      <tbody>

      <% @product.prices.view_sorted.decorate.each do |price| %>
        <%= content_tag_for :tr, price, rel: "fields_price_#{price.id}", class: cycle('odd', 'even') do %>
          <td class="delete"><input type="checkbox" name="id[]" value="<%= price.id %>"></td>
          <%= content_tag(:td, price.market_name, class: "market edit-trigger") if current_user.multi_market_membership? %>
          <td class="buyer edit-trigger"><%= price.organization_name %></td>
          <td class="min-qty edit-trigger"><%= price.min_quantity %></td>
          <td class="net-price edit-trigger"><%= number_to_currency price.net_price %></td>
          <td class="sale-price edit-trigger"><%= number_to_currency price.sale_price %></td>
          <td class="edit">
            <%= link_to raw('<i class="font-icon" data-icon="&#xe002;"></i> Edit</span>'), "#fields_price_#{price.id}", class: "edit-trigger edit-price" %>
            <%= link_to raw('<i class="font-icon icon-delete"></i> Delete'), [:admin, @product, price], method: :delete, data: {confirm: 'Are you sure you want to delete this price'}, class: " delete" %>
          </td>
        <% end %>

        <%= content_tag_for :tr, price, :fields, {class: 'price', style: "display: none;", data: {"form-url" => url_for([:admin, @product, price]) }} do %>
          <%= fields_for :price, price, index: price.id do |price_in_table| %>
            <%= render 'form_row', f: price_in_table %>
          <% end %>
        <% end %>
      <% end %>
      </tbody>
    <% end # table %>
    <% if @product.prices.view_sorted.none? %>
      <p>
        When entering a price with advanced pricing, you are able to set prices for specific buyers. Before you do that
        though, you should have a base price that everyone will pay. We have prefilled the information to get you started.
        Set a sale price and click add to add this price. You will notice that the Net Price updates when you enter a Sale
        Price. You can play with these numbers to get the Net Price that you want to receive per unit.
      </p>
    <% end %>
    <div class="form-actions">
    <%= link_to "Return to Products List", admin_products_path, disabled: @product.prices.view_sorted.any? ? nil : "disabled", class: "btn" %>

    <%= link_to "Add Another product", new_admin_product_path, class: "btn btn--add" if @product.prices.view_sorted.none? %>
    </div>
  </div>
<% end # form %>
