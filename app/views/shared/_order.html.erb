<%= render "shared/errors", { resource: order } %>

<%= form_for order, url: admin_order_path(order.id), as: :order, method: :put do |f| %>
<%  user_order_context = UserOrderContext.build(user:current_user, order:order)
      credit_sign = '-'
%>
<div class="order-info">
  <h1>Order info for <%= order.order_number %></h1>
  <div class="order-info-date">Placed On: <strong><%= order.placed_at.strftime "%m/%d/%Y at %l:%M%p" %></strong></div>

  <div class="row">
    <div class="order-buyer">
      <div>Buyer: <strong><%= order.organization.name %></strong></div>

      <h2 class="order-address">Billing Address:</h2>
      <p class="vcard">
        <span class="street-address"><%= order.billing_address %></span><br>
        <span class="locality"><%= order.billing_city %></span>,
        <span class="region"><%= order.billing_state %></span> <span class="postal-code"><%= order.billing_zip %></span><br>
        <%= content_tag :span, order.billing_phone, class: "tel" if order.billing_phone.present? %>
      </p>
      <h2 class="order-address"><%= order.display_delivery_or_pickup.titleize %></h2>
      <div>
        <p class="vcard">
          <%= order.display_delivery_address %><br>
        </p>
        <p class="delivery-time">
          <%= order.delivery.decorate.human_delivery_date %>
        </p>

        <% if @deliveries && can_change_delivery_on_placed_order?(order) %>
          <div id="delivery-changer">
            <span class="change-delivery">
              <%= link_to "Change Delivery", "#", class: "reset btn" %>
            </span>
            <div class="fields is-hidden">
              <%= f.select :delivery_id, @deliveries.
                          map {|d| d.decorate(context: {current_organization: current_organization}) }.
                          sort_by {|d| d.get_buyer_deliver_on }.map{|d| ["#{d.type} - #{d.buyer_display_date} #{d.buyer_time_range}", d.id] } %>
              <br/><br/>
              <%= f.submit "Change Delivery", class: "btn btn--small" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <div style="float: left; margin-right: 50px">
      <h2>Financial Summary</h2>
      <table class="order-totals-table">
        <tbody>
          <% if order.credit_amount > 0 || order.display_delivery_fees?(current_user) %>
          <tr>
            <th class="math-symbol"></th>
            <th>Product Total:</th>
            <td><%= number_to_currency order.gross_total %></td>
          </tr>
          <% if order.discount > 0 %>
          <tr>
            <th class="math-symbol">-</th>
            <th>Discount:</th>
            <td><%= number_to_currency order.discount %></td>
          </tr>
          <% end %>
          <% if order.credit_amount > 0 && order.credit.apply_to == "subtotal" %>
          <tr>
            <th class="math-symbol"><%= credit_sign %></th>
            <th>Credit: <% if order.credit_amount > 0 && order.credit.notes %><span class="tooltip tooltip--naked" data-tooltip="Notes: <%= order.credit.notes %>"><i class="fa fa-file-text-o"></i></span><% end %></th>
            <td><%= number_to_currency order.credit_amount %></td>
            <% if order.payment_status == "unpaid" && current_user.admin_or_mm? %>
            <td class="credit-clear"><%= link_to "", "#", class: "font-icon icon-clear" %></td>
            <% end %>
            <%= f.hidden_field :credit_clear, :value=>nil %>
          </tr>
          <% end %>
          <% if order.display_delivery_fees?(current_user) %>
          <tr>
            <th class="math-symbol">+</th>
            <th><%= order.delivery.delivery_schedule.fee_label %>:</th>
            <td><%= number_to_currency order.delivery_fees %></td>
            <% if order.payment_method=="purchase order" && order.delivery_fees  > 0 && order.payment_status == "unpaid" && current_user.admin_or_mm? %>
            <td class="delivery-clear"><%= link_to "", "#", class: "font-icon icon-clear" %></td>
            <% end %>
            <%= f.hidden_field :delivery_clear, :value=>nil %>
          </tr>
          <% end %>
          <% if order.credit_amount > 0 && order.credit.apply_to == "total" %>
          <tr>
            <th class="math-symbol"><%= credit_sign %></th>
            <th>Credit: <% if order.credit_amount > 0 && order.credit.notes %><span class="tooltip tooltip--naked" data-tooltip="Notes: <%= order.credit.notes %>"><i class="fa fa-file-text-o"></i></span><% end %></th>
            <td><%= number_to_currency order.credit_amount %></td>
            <% if order.payment_status == "unpaid" && current_user.admin_or_mm? %>
            <td class="credit-clear"><%= link_to "", "#", class: "font-icon icon-clear" %></td>
            <% end %>
            <%= f.hidden_field :credit_clear, :value=>nil %>
          </tr>
          <% end %>
          <% end %>
          <tr>
            <th class="math-symbol total-line">=</th>
            <th class="total-line">Order Total:</th>
            <td class="total-line"><%= number_to_currency order.total_cost %></td>
          </tr>
         </tbody>
      </table>
      <% if FeatureAccess.can_edit_order?(user: current_user, order: order) && order.payment_method=="purchase order" && order.payment_status == "unpaid" %>
          <a href="#creditEdit" class="btn btn--small btn--primary modal-toggle app-edit-credit-modal-button"><%= order.credit_amount > 0 ? "Modify" : "Add" %> Credit</a></td>
      <% end %>
    </div>
    <div class="order-info-status-section" style="float: left">
      <h2>Payment Status</h2>
      <table class="order-info-status">
        <tbody>
        <tr>
          <th scope="row">Payment Method: </th>
          <td><%= order.payment_method.titleize %></td>
        </tr>
        <% if order.payment_method == "purchase order" && !order.payment_note.nil? && order.payment_note.length > 0 %>
        <tr>
          <th scope="row">Payment Ref. #: </th>
          <td><%= order.payment_note %></td>
        </tr>
        <% end %>
        <tr>
          <th scope="row">Delivery Status: </th>
          <td><%= order.delivery_status_for_user(current_user).titleize %></td>
        </tr>
        <tr>
          <th scope="row">Buyer Payment: </th>
          <td><%= order.buyer_payment_status.titleize %></td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="row order-data">
    <br/><br/>
    <h2 class="pull-left">Items for Delivery</h2>
    <% if !current_user.buyer_only? && order.undelivered_for_user?(current_user) %>
      <%= button_tag "Mark all delivered", class: 'pull-right btn btn--small btn--primary mobile-block', id: 'mark-all-delivered', type: 'button' %>
    <% end %>
    <div class="table-wrapper">
      <table class="current-sales-table odd order-table-1">
      <thead>
        <tr>
          <th>Product Name</th>
          <th>Product Code</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Total</th>
          <th>Delivery</th>
          <th>Buyer Payment</th>
          <% if !current_user.buyer_only? %>
            <th>Seller Payment</th>
          <% end %>
          <% if FeatureAccess.order_action_links?(user_order_context: user_order_context) %>
            <th></th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <%= f.fields_for :items do |item| %>
          <% user_order_item_context = UserOrderItemContext.build(user: current_user, order_item: item.object) %>
        <tr class="order-item-row">
          <td class="name">
            <span class="product-ordered"><%= item.object.name %></span> <br />
            <span class="seller-name">from <%= item.object.product.organization.name %></span>
          </td>
          <td>
            <% if item.object.product.code.present? %>
              <span><%= item.object.product.code %></span> <br />
            <% else %>
              -
            <% end %>
          </td>
          <td class="quantity">
            <%# if (current_user.admin? || current_user.market_manager?) && item.object.delivery_status == 'pending' %>
            <% if FeatureAccess.edit_ordered_quantity?(user_order_item_context: user_order_item_context) %>
              <%= item.text_field :quantity, :autocomplete => :off, value: Format.quantity(item.object.quantity), class: 'quantity-ordered' %>
            <% else %>
              <span class="quantity-ordered-ro"><%= Format.quantity(item.object.quantity) %></span>
            <% end %> <%= item.object.unit %> (Ordered)<br />

            <% if FeatureAccess.edit_delivered_quantity?(user_order_item_context: user_order_item_context) %>
              <%= item.text_field :quantity_delivered, :autocomplete => :off, value: Format.quantity(item.object.quantity_delivered), class: 'quantity-delivered' %>
            <% else %>
              <span class="quantity-delivered-ro"><%= Format.quantity item.object.quantity_delivered %></span>
            <% end %> <%= item.object.unit %> (Delivered)
          </td>
          <td class="price"><%= number_to_currency item.object.unit_price %><br><strong><%= link_to "EDIT", '#itemPriceEdit', class: 'add-toggle' %></strong></td>  <!-- Want to click on a button for a modal, get a modal form that posts here, accesses this item.object.unit_price, and changes it for this order only -->
          <td class="total"><%= number_to_currency item.object.gross_total %></td>
          <td class="delivery-status">
            <%= item.hidden_field :delivery_status %>
            <%= item.object.delivery_status.titleize %>
          </td>
          <td class="payment-status"><%= item.object.buyer_payment_status.titleize %></td>
          <% if !current_user.buyer_only? %>
            <td class="seller-status"><%= item.object.seller_payment_status %></td>
          <% end %>
          <% if FeatureAccess.order_action_links?(user_order_context: user_order_context) %>
            <td class="action-link">
              <% if FeatureAccess.delete_order_item?(user_order_item_context: user_order_item_context) %>
                <%= item.hidden_field :_destroy %>
                <%= link_to raw('<i class="font-icon icon-delete"></i>'), "#delete" %>
              <% end %>
            </td>
          <% end %>
        </tr>
        <% end %>
      </tbody>

      <% if can_add_products_to_order?(order, user_order_context) && @show_add_items_form %>
        <tbody>
          <% @products_for_sale.each_category_with_products do |category, products| %>
            <tr><th colspan="9"><%= category.name %></th></tr>
            <% products.each do |product| %>
              <tr class="order-item-row">
                <td class="name">
                  <span class="product-ordered"><%= product.name %></span> <br>
                  <span class="seller-name">from <%= product.organization.name %></span>
                </td>
                <td class="quantity">
                  <%= fields_for "items_to_add[]", CartItem.new(product: product) do |item| %>
                    <%= item.hidden_field :product_id, id: "items_to_add_#{product.id}_product_id" %>
                    <%= item.text_field :quantity, id: "items_to_add_#{product.id}_quantity", class: 'quantity-ordered' %>
                  <% end %>
                </td>
                <td class="price">
                  <ul class="tiers">
                    <% product.prices_for_market_and_organization(current_market, order.organization).each do |price| %>
                      <% price = price.decorate %>
                      <% if price.organization_id.present? %>
                        <li class="negotiated"><span class="unit-price"><%= number_to_currency(price.sale_price)%></span> <span class="tier"><%= price.formatted_units %></span><span class="tooltip tooltip--naked tooltip--notice" data-tooltip="This is a negotiated price specific to you!"><i class="font-icon" data-icon="&#xe01f;"></i></span></li>
                      <% else %>
                        <li><span class="unit-price"><%= number_to_currency(price.sale_price)%></span> <span class="tier"><%= price.formatted_units %></span></li>
                      <% end %>
                    <% end %>
                  </ul>
                </td>
                <td class="price" colspan="6">
                  <%= product.available_inventory(order.delivery.deliver_on) %> available
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      <% end %>
    </table>
    </div>

    <% if FeatureAccess.order_action_links?(user_order_context: user_order_context) %>
      <%= f.submit @show_add_items_form ? "Add items and Update quantities" : "Update quantities", class: 'pull-right btn btn--small mobile-block' %>
    <% end %>
    <% if can_add_products_to_order?(order, user_order_context) && !@show_add_items_form %>
      <%= f.submit "Add Items", class: 'pull-right btn btn--small mobile-block' %>
    <% end %>
  </div>
  <% if !current_user.buyer_only? %>
  <div class="order-totals">
    <div class="table-wrapper">
      <h2>Order Totals</h2>
      <table class="current-sales-table odd">
        <thead>
          <tr>
            <th>Product Total</th>
            <% if current_user.can_manage_market?(order.market) %>
            <th>Discount (by Market)</th>
            <th>Discount (by Seller)</th>
            <th><%= order.delivery.delivery_schedule.fee_label %></th>
            <% elsif current_user.seller? %>
            <th>Discount</th>
            <% end %>
            <th>Market Fee</th>
            <th>Transaction Fee</th>
            <th>Payment Processing Fee</th>
            <th>Net Sale</th>
          </tr>
        </thead>
        <tbody>
          <tr class="order-summary-row">
            <td class="gross-total"><%= number_to_currency order.gross_total %></td>
            <% if current_user.can_manage_market?(order.market) %>
              <td class="discount-market"><%= number_to_currency order.discount_market %></td>
              <td class="discount-seller"><%= number_to_currency order.discount_seller %></td>
              <td class="delivery-fees"><%= number_to_currency order.delivery_fees %></td>
            <% elsif current_user.seller? %>
              <td class="discount"><%= number_to_currency order.discount_seller %></td>
            <% end %>
            <td class="market-fees"><%= number_to_currency order.market_fees %></td>
            <td class="transaction-fees"><%= number_to_currency order.transaction_fees %></td>
            <td class="payment-processing"><%= number_to_currency order.payment_fees %></td>
            <td class="net-sale"><%= number_to_currency order.net_total %></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <% end %>
  <% if current_user.can_manage_market?(order.market) %>
    <div class="order-notes">
      <%= f.label :notes %>
      <%= f.text_area :notes, rows: 10 %>
      <%= f.submit "Save Notes", class: 'btn btn--small mobile-block' %>
    </div>
  <% end %>
  <% if current_user.can_manage_market?(order.market) || current_user.is_localeyes_buyer? %>
  <br/><br/>
  <div>
    <div class="table-wrapper">
      <h2>Order History</h2>

      <table class="order-history">
        <thead>
          <tr>
            <th>When</th>
            <th>Changes</th>
            <th>Who</th>
          </tr>
        </thead>
        <tbody>
          <% OrderHistoryPresenter.new(order.id).each_activity do |activity| %>
            <tr>
              <td><%= activity.when %></td>
              <td>
                <% activity.actions.each do |action| %>
                  <p><%= action %></p>
                <% end %>
              </td>
              <td><%= activity.who %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
  <% end %>

</div>
<% end %>

<div> <br>
  <% if !current_user.buyer_only? # TODO move this logic? Order view... %>
    <% if !current_user.can_manage_market?(current_market) %>
     <h2>Delivery Note</h2>
      <% DeliveryNote.where(order_id:order.id,supplier_org:current_organization).visible.each do |n| %>
        <%= n.note %><br>
      <% end %>
    <% else  # all of them - admin powers %>
      <h2>Delivery Notes</h2>
        <% DeliveryNote.where(order_id:order.id).visible.each do |n| %>
          <strong> For <%= Organization.where(id:n.supplier_org).first.name %>:</strong>
          <%= n.note %> <br><br>
        <% end %>
    <% end %>
  <% end %>
</div>

<% if FeatureAccess.order_printables?(user: current_user, order: order) %>
  <%= render :partial=>"table_tents_and_posters/ad", locals: { order: order } %>
<% end %>

<% if FeatureAccess.can_edit_order?(user: current_user, order: order) %>
  <%= react_component('lo.ModifyCreditModal', {
    baseUrl: "#{request.base_url}/api/v1/",
    credit: order.credit,
    grossTotal: order.gross_total.to_f,
    amountTypes: Credit::AMOUNT_TYPES,
    payerTypes: Credit::PAYER_TYPES,
    applyTo: Credit::APPLY_TO_TYPES,
    sellers: order.sellers,
    orderId: order.id
  }) %>
<% end %>

<% render "edit_unit_price_modal" %>