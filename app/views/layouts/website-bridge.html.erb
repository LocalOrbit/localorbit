<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Local Orbit</title>
  <meta name="viewport" content="width=device-width, initial-scale = 1.0" id="viewport">
  <link href='//fonts.googleapis.com/css?family=Open+Sans:400,700,300|Open+Sans+Condensed:700,300' rel='stylesheet' type='text/css'>

  <!-- specified in design documentation -->
  <link href='//fonts.googleapis.com/css?family=Francois+One' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,300italic' rel='stylesheet' type='text/css'>

  <%= stylesheet_link_tag "application", media: "all" %>
  <%= csrf_meta_tags %>
  <style id="viewport-declarations">
    @-ms-viewport{ width: device-width;, zoom: 1.0}
    @-o-viewport{ width: device-width; zoom: 1.0}
    @viewport{ width: device-width; zoom: 1.0}
  </style>
  <% if current_market.present? %>

    <style>
      body {
      <% if current_market.background_color.present? -%>
        background-color: <%= current_market.background_color -%>;
      <% end -%>
      <% if !current_market.background_image.blank? -%>
        background-image: url(<%= asset_path "backgrounds/#{current_market.background_image}" -%>);
      <% else -%>
        background-image: none;
      <% end -%>
    }
    @media screen and (max-width: 640px) {
      body { background-image: none; }
    }
    <% if current_market.text_color.present? -%>
      a,
      button.reset, button.cancel, button.close, button.delete,
      .btn.reset,
      .btn.cancel,
      .btn.close,
      .btn.delete,
      input[type=reset].reset,
      input[type=reset].cancel,
      input[type=reset].close,
      input[type=reset].delete,
      input[type=submit].reset,
      input[type=submit].cancel,
      input[type=submit].close,
      input[type=submit].delete,
      .seller-map-toggle,
      .tagline,
      .nav--sidebar a {
        color: <%= current_market.text_color -%>;
      }

      .l-app-header,
      .l-app-footer,
      .product-category-divider,
      .nav--main > span,
      .btn--primary,
      .btn--add,
      .btn--save,
      input[type=submit],
      input[type=button].btn {
        background-color: <%= current_market.text_color -%>;
        border-color: <%= current_market.text_color -%>;
      }
      .set_filter,
      input[type=date].set_filter,
      input[type=datetime].set_filter,
      input[type=email].set_filter,
      input[type=search].set_filter,
      input[type=tel].set_filter,
      input[type=text].set_filter,
      input[type=number].set_filter,
      input[type=url].set_filter,
      input[type=password].set_filter,
      textarea.set_filter {
        background: <%= hex_to_rgba(current_market.text_color,0.2) %>;
        border: 1px solid <%=current_market.text_color%>;
      }
      .btn--secondary,
      input[type=submit].btn--secondary {
         background:<%= color_mix current_market.text_color, 14 %>;
         border-color:<%= color_mix current_market.text_color, 14 %>;
      }
      .export path {
        fill: <%= current_market.text_color -%>;
      }
      .nav--app a .counter{background-color: <%= current_market.text_color -%>;}
      .sidebar-box{border-color: <%= current_market.text_color -%>;}
      @media screen and (min-width: 601px) {
        a:hover {
          color: <%= color_mix current_market.text_color, 10 %>;
        }
        /*.btn--add:hover,
        .btn--add:active,
        .btn--add.current,*/
        .nav--app a:hover,
        .nav--app a:active,
        .nav--app a.current {
          background: <%= color_mix current_market.text_color, 5.5 %>;
        }
        .nav--main > a:hover {
          background-color: <%= current_market.text_color -%>;
        }
        
        #admin-nav a:hover {
           color: inherit;
        }
        .nav--main a:hover,
        .nav--main a:active,
        .nav--main a.current {
          color: #fff;
        }
      }
      .pdf-download {
        background-color: <%= color_mix current_market.text_color, 70 %>
      }
    <% end %>
    </style>
  <% end %>
</head>

<body id="website-bridge" class="controller-<%= controller.controller_name %> <%= current_user.present? ? "" : "signed-out" %> <%= "request-desktop" if cookies[:request_desktop] && cookies[:request_desktop] == "true"  %>">
  <%= render "shared/analytics" %>

  <div class="page-content">
    <header class="l-app-header stickable" id="top">
      <div class="l-constraint">
        <p class="header header--welcome">Local Orbit</p>
        <% if current_user && 1==0 %>
        <a href="#admin-nav" class="nav-admin-toggle"><%= image_tag asset_path('hamburger.png'), alt: "Toggle Navigation", height: 20 %></a>
        <ul class="l-inline-list nav nav--app">
          <li><%= link_to 'Dashboard', dashboard_path, class: (current_page?(dashboard_path) ? "current hidden-mobile" : "hidden-mobile") %></li
          ><li><%= render "carts/link" %></li
          ><li><%= link_to 'Help', help_path, :target => '_blank' %></li
          ><li><%= link_to 'Sign Out', destroy_user_session_path, method: :delete %></li>
        </ul>
        <% end %>
        <div class="clearfix"></div>
      </div>
    </header>

    <div class="l-constraint l-main">
      <div id="flash-messages">
        <% if notice %>
          <div class="flash flash--notice"><p><%= notice %></p></div>
        <% end %>

        <% if alert.present? %>
          <div class="flash flash--alert"><p><%= alert %></div>
        <% end %>
      </div>

      <%# KXM Shared navigation here will likely be the website nav.  The render code remains here (but commented out) until I know what that means %>
      <%#= render 'shared/navigation' %>

      <%= yield %>

    </div>
    <footer class="l-app-footer">
      <div class="l-constraint">
        <% if current_market.present? %>
          <div class="pull-right market-manager-contact">
            <%= mail_to current_market.contact_email, current_market.contact_name, class: "email" %>, Manager<br>
            <% if current_market.contact_phone.present? %>
              Phone <%= number_to_phone current_market.contact_phone %>
            <% end %>
          </div>
        <% end %>

        <div class="copyright">
          <a href="http://localorbit.com/">
            Powered by <span class="org">Local Orbit</span><br>
            Â© <%= Date.today.year %>
          </a>
          <button class="btn reset mobile-only mobile-block toggle-viewport" id="toggle-desktop">View Desktop Version</button>
        </div>
        <button class="btn reset btn--small hidden-mobile toggle-viewport is-hidden" id="toggle-mobile">View Mobile Version</button>
      </div>
    </footer>
  </div>
  <div class="overlay"></div>

  <script>RAILS_ENV = '<%= Rails.env %>';</script>
  <script>DEPLOY_ENV = '<%= Figaro.env.deploy_env %>';</script>
  <script>DEBUG = <%= Figaro.env.debug == 'ON' ? "true" : "false" %>;</script>
  <%= javascript_include_tag "application" %>
  <!-- TODO: use payment provider constants -->
  <% case @payment_provider %>
  <% when 'balanced' %>
  <%= javascript_include_tag 'balanced' %>
  <% when 'stripe' %>
  <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
  <%= javascript_include_tag 'stripe' %>
  <% end %>
  <%# KXM Stripe scripts included manually because I don't yet know what to do with the PaymentProvider stuff... delete when refactored %>
  <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
  <%= javascript_include_tag 'stripe' %>

  <%# KXM This script tag is only here to get things working. Put your toys away when your done with them, Keetie.  In all likelihood this will end up in the roll_your_own_market.js.coffee script %>
  <script type="text/javascript">
    $(document).ready(function () {
      $(function() {
        $( "#tabs" ).tabs();
      });

      $('div[id^="form-"]').each(function(){
        manage_section_state($(this));
      });

      // The presence of JavaScript means that the form is tabbed.  Show the form navigation
      $(".wizard_nav").show();

      /**
       * wizard_nav
       * Coordinates the 'Previous' and 'Continue' button clicks with the corresponding tab interface actions
       **/
      function wizard_nav(button){
        var clicked_form_nav = button;
        var target_tab_nav = $('#market-tab-list').find('a[href="'+clicked_form_nav.attr('target')+'"]');
        target_tab_nav.trigger('click');
      }

      /**
       * manage_section_state
       * Manages the tab classes on page load and on input change 
       **/
      function manage_section_state(form_section){
        var pass = true;

        form_section_id = form_section.prop('id');

        target_anchor = $('a[href^="#'+form_section_id+'"]')
        target_li = target_anchor.closest('li');

        form_section.find('input').each(function(index){
          // # KXM This could (should) be a method call for validation of some kind.  For now it confirms that *something* has been entered
          if( $(this).val() == '' || $(this).val() == null ){
            pass = false;
          }

          if( $(this).prop('type') == 'checkbox' && !$(this).is(':checked') ){
            pass = false;
          }
        });

        // # KXM Confirm what constitutes a test here and abstract to a validation class
        if( pass == true ){
          target_li.addClass('pass');
        } else {
          target_li.removeClass('pass');
        }
      };

      // Trigger section management whenever input changes
      $('input').change(function(){
        ancestor_div = $(this).closest('div[id^="form-"]');
        manage_section_state(ancestor_div);
      })

      // Bind a given form nav click to the corresponding tab nav click
      $("button.wizard_nav").click(function(e){
        e.preventDefault();
        wizard_nav($(this));
      });

      //  KXM Placeholder methods for buttons that don't yet work...
      $("#add_market").click(function(e){
        e.preventDefault();
        alert("This button will:\nAdd an entry to a table of pending markets, creating the table if necessary\nSpawn another market data entry form")
      });

      $("#apply_discount").click(function(e){
        e.preventDefault();
        alert("This button will:\nApply a discount to the payment total\nPresumably validate the discount?\nPerform some UI manipulation?")
      });

    });
  </script>

</body>
</html>
